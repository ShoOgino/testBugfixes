{"path":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrServer],boolean).mjava","commits":[{"id":"29372a57b7e46d222a80429ad6b96413b7319eea","date":1390584196,"type":0,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrServer],boolean).mjava","pathOld":"/dev/null","sourceNew":"  protected void updateMappingsFromZk(List<JettySolrRunner> jettys, List<SolrServer> clients, boolean allowOverSharding) throws Exception {\n    ZkStateReader zkStateReader = cloudClient.getZkStateReader();\n    zkStateReader.updateClusterState(true);\n    cloudJettys.clear();\n    shardToJetty.clear();\n    \n    ClusterState clusterState = zkStateReader.getClusterState();\n    DocCollection coll = clusterState.getCollection(DEFAULT_COLLECTION);\n\n    List<CloudSolrServerClient> theClients = new ArrayList<CloudSolrServerClient>();\n    for (SolrServer client : clients) {\n      // find info for this client in zk \n      nextClient:\n      // we find out state by simply matching ports...\n      for (Slice slice : coll.getSlices()) {\n        for (Replica replica : slice.getReplicas()) {\n          int port = new URI(((HttpSolrServer) client).getBaseURL())\n              .getPort();\n          \n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            CloudSolrServerClient csc = new CloudSolrServerClient();\n            csc.solrClient = client;\n            csc.port = port;\n            csc.shardName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            csc.info = replica;\n            \n            theClients .add(csc);\n            \n            break nextClient;\n          }\n        }\n      }\n    }\n \n    for (JettySolrRunner jetty : jettys) {\n      int port = jetty.getLocalPort();\n      if (port == -1) {\n        throw new RuntimeException(\"Cannot find the port for jetty\");\n      }\n      \n      nextJetty:\n      for (Slice slice : coll.getSlices()) {\n        Set<Entry<String,Replica>> entries = slice.getReplicasMap().entrySet();\n        for (Entry<String,Replica> entry : entries) {\n          Replica replica = entry.getValue();\n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            List<CloudJettyRunner> list = shardToJetty.get(slice.getName());\n            if (list == null) {\n              list = new ArrayList<CloudJettyRunner>();\n              shardToJetty.put(slice.getName(), list);\n            }\n            boolean isLeader = slice.getLeader() == replica;\n            CloudJettyRunner cjr = new CloudJettyRunner();\n            cjr.jetty = jetty;\n            cjr.info = replica;\n            cjr.nodeName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            cjr.coreNodeName = entry.getKey();\n            cjr.url = replica.getStr(ZkStateReader.BASE_URL_PROP) + \"/\" + replica.getStr(ZkStateReader.CORE_NAME_PROP);\n            cjr.client = findClientByPort(port, theClients);\n            list.add(cjr);\n            if (isLeader) {\n              shardToLeaderJetty.put(slice.getName(), cjr);\n            }\n            cloudJettys.add(cjr);\n            break nextJetty;\n          }\n        }\n      }\n    }\n    \n    // # of jetties may not match replicas in shard here, because we don't map\n    // jetties that are not running - every shard should have at least one\n    // running jetty though\n    for (Slice slice : coll.getSlices()) {\n      // check that things look right\n      List<CloudJettyRunner> jetties = shardToJetty.get(slice.getName());\n      if (!allowOverSharding) {\n        assertNotNull(\"Test setup problem: We found no jetties for shard: \"\n            + slice.getName() + \" just:\" + shardToJetty.keySet(), jetties);\n        \n        assertEquals(\"slice:\" + slice.getName(), slice.getReplicas().size(),\n            jetties.size());\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"634f330c54fd3f9f491d52036dc3f40b4f4d8934","date":1394635157,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrServer],boolean).mjava","pathOld":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrServer],boolean).mjava","sourceNew":"  protected void updateMappingsFromZk(List<JettySolrRunner> jettys, List<SolrServer> clients, boolean allowOverSharding) throws Exception {\n    ZkStateReader zkStateReader = cloudClient.getZkStateReader();\n    zkStateReader.updateClusterState(true);\n    cloudJettys.clear();\n    shardToJetty.clear();\n    \n    ClusterState clusterState = zkStateReader.getClusterState();\n    DocCollection coll = clusterState.getCollection(DEFAULT_COLLECTION);\n\n    List<CloudSolrServerClient> theClients = new ArrayList<>();\n    for (SolrServer client : clients) {\n      // find info for this client in zk \n      nextClient:\n      // we find out state by simply matching ports...\n      for (Slice slice : coll.getSlices()) {\n        for (Replica replica : slice.getReplicas()) {\n          int port = new URI(((HttpSolrServer) client).getBaseURL())\n              .getPort();\n          \n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            CloudSolrServerClient csc = new CloudSolrServerClient();\n            csc.solrClient = client;\n            csc.port = port;\n            csc.shardName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            csc.info = replica;\n            \n            theClients .add(csc);\n            \n            break nextClient;\n          }\n        }\n      }\n    }\n \n    for (JettySolrRunner jetty : jettys) {\n      int port = jetty.getLocalPort();\n      if (port == -1) {\n        throw new RuntimeException(\"Cannot find the port for jetty\");\n      }\n      \n      nextJetty:\n      for (Slice slice : coll.getSlices()) {\n        Set<Entry<String,Replica>> entries = slice.getReplicasMap().entrySet();\n        for (Entry<String,Replica> entry : entries) {\n          Replica replica = entry.getValue();\n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            List<CloudJettyRunner> list = shardToJetty.get(slice.getName());\n            if (list == null) {\n              list = new ArrayList<>();\n              shardToJetty.put(slice.getName(), list);\n            }\n            boolean isLeader = slice.getLeader() == replica;\n            CloudJettyRunner cjr = new CloudJettyRunner();\n            cjr.jetty = jetty;\n            cjr.info = replica;\n            cjr.nodeName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            cjr.coreNodeName = entry.getKey();\n            cjr.url = replica.getStr(ZkStateReader.BASE_URL_PROP) + \"/\" + replica.getStr(ZkStateReader.CORE_NAME_PROP);\n            cjr.client = findClientByPort(port, theClients);\n            list.add(cjr);\n            if (isLeader) {\n              shardToLeaderJetty.put(slice.getName(), cjr);\n            }\n            cloudJettys.add(cjr);\n            break nextJetty;\n          }\n        }\n      }\n    }\n    \n    // # of jetties may not match replicas in shard here, because we don't map\n    // jetties that are not running - every shard should have at least one\n    // running jetty though\n    for (Slice slice : coll.getSlices()) {\n      // check that things look right\n      List<CloudJettyRunner> jetties = shardToJetty.get(slice.getName());\n      if (!allowOverSharding) {\n        assertNotNull(\"Test setup problem: We found no jetties for shard: \"\n            + slice.getName() + \" just:\" + shardToJetty.keySet(), jetties);\n        \n        assertEquals(\"slice:\" + slice.getName(), slice.getReplicas().size(),\n            jetties.size());\n      }\n    }\n  }\n\n","sourceOld":"  protected void updateMappingsFromZk(List<JettySolrRunner> jettys, List<SolrServer> clients, boolean allowOverSharding) throws Exception {\n    ZkStateReader zkStateReader = cloudClient.getZkStateReader();\n    zkStateReader.updateClusterState(true);\n    cloudJettys.clear();\n    shardToJetty.clear();\n    \n    ClusterState clusterState = zkStateReader.getClusterState();\n    DocCollection coll = clusterState.getCollection(DEFAULT_COLLECTION);\n\n    List<CloudSolrServerClient> theClients = new ArrayList<CloudSolrServerClient>();\n    for (SolrServer client : clients) {\n      // find info for this client in zk \n      nextClient:\n      // we find out state by simply matching ports...\n      for (Slice slice : coll.getSlices()) {\n        for (Replica replica : slice.getReplicas()) {\n          int port = new URI(((HttpSolrServer) client).getBaseURL())\n              .getPort();\n          \n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            CloudSolrServerClient csc = new CloudSolrServerClient();\n            csc.solrClient = client;\n            csc.port = port;\n            csc.shardName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            csc.info = replica;\n            \n            theClients .add(csc);\n            \n            break nextClient;\n          }\n        }\n      }\n    }\n \n    for (JettySolrRunner jetty : jettys) {\n      int port = jetty.getLocalPort();\n      if (port == -1) {\n        throw new RuntimeException(\"Cannot find the port for jetty\");\n      }\n      \n      nextJetty:\n      for (Slice slice : coll.getSlices()) {\n        Set<Entry<String,Replica>> entries = slice.getReplicasMap().entrySet();\n        for (Entry<String,Replica> entry : entries) {\n          Replica replica = entry.getValue();\n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            List<CloudJettyRunner> list = shardToJetty.get(slice.getName());\n            if (list == null) {\n              list = new ArrayList<CloudJettyRunner>();\n              shardToJetty.put(slice.getName(), list);\n            }\n            boolean isLeader = slice.getLeader() == replica;\n            CloudJettyRunner cjr = new CloudJettyRunner();\n            cjr.jetty = jetty;\n            cjr.info = replica;\n            cjr.nodeName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            cjr.coreNodeName = entry.getKey();\n            cjr.url = replica.getStr(ZkStateReader.BASE_URL_PROP) + \"/\" + replica.getStr(ZkStateReader.CORE_NAME_PROP);\n            cjr.client = findClientByPort(port, theClients);\n            list.add(cjr);\n            if (isLeader) {\n              shardToLeaderJetty.put(slice.getName(), cjr);\n            }\n            cloudJettys.add(cjr);\n            break nextJetty;\n          }\n        }\n      }\n    }\n    \n    // # of jetties may not match replicas in shard here, because we don't map\n    // jetties that are not running - every shard should have at least one\n    // running jetty though\n    for (Slice slice : coll.getSlices()) {\n      // check that things look right\n      List<CloudJettyRunner> jetties = shardToJetty.get(slice.getName());\n      if (!allowOverSharding) {\n        assertNotNull(\"Test setup problem: We found no jetties for shard: \"\n            + slice.getName() + \" just:\" + shardToJetty.keySet(), jetties);\n        \n        assertEquals(\"slice:\" + slice.getName(), slice.getReplicas().size(),\n            jetties.size());\n      }\n    }\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"bafca15d8e408346a67f4282ad1143b88023893b","date":1420034748,"type":5,"author":"Alan Woodward","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrClient],boolean).mjava","pathOld":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#updateMappingsFromZk(List[JettySolrRunner],List[SolrServer],boolean).mjava","sourceNew":"  protected void updateMappingsFromZk(List<JettySolrRunner> jettys, List<SolrClient> clients, boolean allowOverSharding) throws Exception {\n    ZkStateReader zkStateReader = cloudClient.getZkStateReader();\n    zkStateReader.updateClusterState(true);\n    cloudJettys.clear();\n    shardToJetty.clear();\n    \n    ClusterState clusterState = zkStateReader.getClusterState();\n    DocCollection coll = clusterState.getCollection(DEFAULT_COLLECTION);\n\n    List<CloudSolrServerClient> theClients = new ArrayList<>();\n    for (SolrClient client : clients) {\n      // find info for this client in zk \n      nextClient:\n      // we find out state by simply matching ports...\n      for (Slice slice : coll.getSlices()) {\n        for (Replica replica : slice.getReplicas()) {\n          int port = new URI(((HttpSolrClient) client).getBaseURL())\n              .getPort();\n          \n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            CloudSolrServerClient csc = new CloudSolrServerClient();\n            csc.solrClient = client;\n            csc.port = port;\n            csc.shardName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            csc.info = replica;\n            \n            theClients .add(csc);\n            \n            break nextClient;\n          }\n        }\n      }\n    }\n \n    for (JettySolrRunner jetty : jettys) {\n      int port = jetty.getLocalPort();\n      if (port == -1) {\n        throw new RuntimeException(\"Cannot find the port for jetty\");\n      }\n      \n      nextJetty:\n      for (Slice slice : coll.getSlices()) {\n        Set<Entry<String,Replica>> entries = slice.getReplicasMap().entrySet();\n        for (Entry<String,Replica> entry : entries) {\n          Replica replica = entry.getValue();\n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            List<CloudJettyRunner> list = shardToJetty.get(slice.getName());\n            if (list == null) {\n              list = new ArrayList<>();\n              shardToJetty.put(slice.getName(), list);\n            }\n            boolean isLeader = slice.getLeader() == replica;\n            CloudJettyRunner cjr = new CloudJettyRunner();\n            cjr.jetty = jetty;\n            cjr.info = replica;\n            cjr.nodeName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            cjr.coreNodeName = entry.getKey();\n            cjr.url = replica.getStr(ZkStateReader.BASE_URL_PROP) + \"/\" + replica.getStr(ZkStateReader.CORE_NAME_PROP);\n            cjr.client = findClientByPort(port, theClients);\n            list.add(cjr);\n            if (isLeader) {\n              shardToLeaderJetty.put(slice.getName(), cjr);\n            }\n            cloudJettys.add(cjr);\n            break nextJetty;\n          }\n        }\n      }\n    }\n    \n    // # of jetties may not match replicas in shard here, because we don't map\n    // jetties that are not running - every shard should have at least one\n    // running jetty though\n    for (Slice slice : coll.getSlices()) {\n      // check that things look right\n      List<CloudJettyRunner> jetties = shardToJetty.get(slice.getName());\n      if (!allowOverSharding) {\n        assertNotNull(\"Test setup problem: We found no jetties for shard: \"\n            + slice.getName() + \" just:\" + shardToJetty.keySet(), jetties);\n        \n        assertEquals(\"slice:\" + slice.getName(), slice.getReplicas().size(),\n            jetties.size());\n      }\n    }\n  }\n\n","sourceOld":"  protected void updateMappingsFromZk(List<JettySolrRunner> jettys, List<SolrServer> clients, boolean allowOverSharding) throws Exception {\n    ZkStateReader zkStateReader = cloudClient.getZkStateReader();\n    zkStateReader.updateClusterState(true);\n    cloudJettys.clear();\n    shardToJetty.clear();\n    \n    ClusterState clusterState = zkStateReader.getClusterState();\n    DocCollection coll = clusterState.getCollection(DEFAULT_COLLECTION);\n\n    List<CloudSolrServerClient> theClients = new ArrayList<>();\n    for (SolrServer client : clients) {\n      // find info for this client in zk \n      nextClient:\n      // we find out state by simply matching ports...\n      for (Slice slice : coll.getSlices()) {\n        for (Replica replica : slice.getReplicas()) {\n          int port = new URI(((HttpSolrServer) client).getBaseURL())\n              .getPort();\n          \n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            CloudSolrServerClient csc = new CloudSolrServerClient();\n            csc.solrClient = client;\n            csc.port = port;\n            csc.shardName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            csc.info = replica;\n            \n            theClients .add(csc);\n            \n            break nextClient;\n          }\n        }\n      }\n    }\n \n    for (JettySolrRunner jetty : jettys) {\n      int port = jetty.getLocalPort();\n      if (port == -1) {\n        throw new RuntimeException(\"Cannot find the port for jetty\");\n      }\n      \n      nextJetty:\n      for (Slice slice : coll.getSlices()) {\n        Set<Entry<String,Replica>> entries = slice.getReplicasMap().entrySet();\n        for (Entry<String,Replica> entry : entries) {\n          Replica replica = entry.getValue();\n          if (replica.getStr(ZkStateReader.BASE_URL_PROP).contains(\":\" + port)) {\n            List<CloudJettyRunner> list = shardToJetty.get(slice.getName());\n            if (list == null) {\n              list = new ArrayList<>();\n              shardToJetty.put(slice.getName(), list);\n            }\n            boolean isLeader = slice.getLeader() == replica;\n            CloudJettyRunner cjr = new CloudJettyRunner();\n            cjr.jetty = jetty;\n            cjr.info = replica;\n            cjr.nodeName = replica.getStr(ZkStateReader.NODE_NAME_PROP);\n            cjr.coreNodeName = entry.getKey();\n            cjr.url = replica.getStr(ZkStateReader.BASE_URL_PROP) + \"/\" + replica.getStr(ZkStateReader.CORE_NAME_PROP);\n            cjr.client = findClientByPort(port, theClients);\n            list.add(cjr);\n            if (isLeader) {\n              shardToLeaderJetty.put(slice.getName(), cjr);\n            }\n            cloudJettys.add(cjr);\n            break nextJetty;\n          }\n        }\n      }\n    }\n    \n    // # of jetties may not match replicas in shard here, because we don't map\n    // jetties that are not running - every shard should have at least one\n    // running jetty though\n    for (Slice slice : coll.getSlices()) {\n      // check that things look right\n      List<CloudJettyRunner> jetties = shardToJetty.get(slice.getName());\n      if (!allowOverSharding) {\n        assertNotNull(\"Test setup problem: We found no jetties for shard: \"\n            + slice.getName() + \" just:\" + shardToJetty.keySet(), jetties);\n        \n        assertEquals(\"slice:\" + slice.getName(), slice.getReplicas().size(),\n            jetties.size());\n      }\n    }\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"634f330c54fd3f9f491d52036dc3f40b4f4d8934":["29372a57b7e46d222a80429ad6b96413b7319eea"],"29372a57b7e46d222a80429ad6b96413b7319eea":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"bafca15d8e408346a67f4282ad1143b88023893b":["634f330c54fd3f9f491d52036dc3f40b4f4d8934"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["bafca15d8e408346a67f4282ad1143b88023893b"]},"commit2Childs":{"634f330c54fd3f9f491d52036dc3f40b4f4d8934":["bafca15d8e408346a67f4282ad1143b88023893b"],"29372a57b7e46d222a80429ad6b96413b7319eea":["634f330c54fd3f9f491d52036dc3f40b4f4d8934"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["29372a57b7e46d222a80429ad6b96413b7319eea"],"bafca15d8e408346a67f4282ad1143b88023893b":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}