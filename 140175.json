{"path":"solr/solrj/src/test/org/apache/solr/client/solrj/io/stream/CloudAuthStreamTest#testIndirectDeleteStream().mjava","commits":[{"id":"140a95988ddfbe87c2376f5fed6acae475ea11fc","date":1580924964,"type":0,"author":"Chris Hostetter","isMerge":false,"pathNew":"solr/solrj/src/test/org/apache/solr/client/solrj/io/stream/CloudAuthStreamTest#testIndirectDeleteStream().mjava","pathOld":"/dev/null","sourceNew":"  public void testIndirectDeleteStream() throws Exception {\n    { // Put some \"real\" docs directly to both X & Y...\n      final UpdateRequest xxx_Update = setBasicAuthCredentials(new UpdateRequest(), WRITE_X_USER);\n      final UpdateRequest yyy_Update = setBasicAuthCredentials(new UpdateRequest(), WRITE_Y_USER);\n      for (int i = 1; i <= 42; i++) {\n        xxx_Update.add(sdoc(\"id\",i+\"z\",\"foo_i\",\"\"+i));\n        yyy_Update.add(sdoc(\"id\",i+\"z\",\"foo_i\",\"\"+i));\n      }\n      assertEquals(\"initial docs in X\",\n                   0, xxx_Update.commit(cluster.getSolrClient(), COLLECTION_X).getStatus());\n      assertEquals(\"initial docs in Y\",\n                   0, yyy_Update.commit(cluster.getSolrClient(), COLLECTION_Y).getStatus());\n    }\n    \n    assertEquals(42L, commitAndCountDocsInCollection(COLLECTION_X, WRITE_X_USER));\n    assertEquals(42L, commitAndCountDocsInCollection(COLLECTION_Y, WRITE_Y_USER));\n    \n    { // WRITE_X user should be able to delete X via a (dummy) stream from Y...\n      final SolrStream solrStream = new SolrStream(solrUrl + \"/\" + COLLECTION_Y,\n                                                   params(\"qt\", \"/stream\", \"expr\",\n                                                          \"delete(\"+COLLECTION_X+\",batchSize=1,\" +\n                                                          \"tuple(id=42z))\"));\n      solrStream.setCredentials(WRITE_X_USER, WRITE_X_USER);\n      final List<Tuple> tuples = getTuples(solrStream);\n      assertEquals(1, tuples.size());\n      assertEquals(1L, tuples.get(0).get(\"totalIndexed\"));\n    }\n\n    assertEquals(42L - 1L, commitAndCountDocsInCollection(COLLECTION_X, WRITE_X_USER));\n    assertEquals(42L, commitAndCountDocsInCollection(COLLECTION_Y, WRITE_Y_USER));\n    \n    { // WRITE_X user should be able to delete ids from X via a (search) stream from Y (routed via Y)\n      final String expr\n        = \"delete(\"+COLLECTION_X+\", batchSize=50,                   \" // note batch size\n        + \"       pruneVersionField=true,                           \" // NOTE: ignoring Y version to del X\n        + \"       search(\"+COLLECTION_Y+\",                          \"\n        + \"              q=\\\"foo_i:[* TO 10]\\\",                     \" // 10 matches = 1 batch\n        + \"              rows=100,                                  \"\n        + \"              fl=\\\"id,foo_i,_version_\\\",                 \" // foo_i & version should be ignored\n        + \"              sort=\\\"foo_i desc\\\"))                      \"\n        ;\n      \n      final SolrStream solrStream = new SolrStream(solrUrl + \"/\" + COLLECTION_Y, // NOTE: Y route\n                                                   params(\"qt\", \"/stream\",\n                                                          \"expr\", expr));\n      solrStream.setCredentials(WRITE_X_USER, WRITE_X_USER);\n      final List<Tuple> tuples = getTuples(solrStream);\n      assertEquals(1, tuples.size());\n      assertEquals(10L, tuples.get(0).get(\"batchIndexed\"));\n      assertEquals(10L, tuples.get(0).get(\"totalIndexed\"));\n\n    }\n\n    assertEquals(42L - 1L - 10L, commitAndCountDocsInCollection(COLLECTION_X, WRITE_X_USER));\n    assertEquals(42L, commitAndCountDocsInCollection(COLLECTION_Y, WRITE_Y_USER));\n      \n    { // WRITE_X user should be able to delete ids from X via a (search) stream from Y (routed via X)...\n      final String expr\n        = \"delete(\"+COLLECTION_X+\", batchSize=5,                    \" // note batch size\n        + \"       search(\"+COLLECTION_Y+\",                          \"\n        + \"              q=\\\"foo_i:[30 TO *]\\\",                     \" // 13 matches = 3 batches\n        + \"              rows=100,                                  \"\n        + \"              fl=\\\"id,foo_i\\\",                           \" // foo_i should be ignored\n        + \"              sort=\\\"foo_i desc\\\"))                      \"\n        ;\n      \n      final SolrStream solrStream = new SolrStream(solrUrl + \"/\" + COLLECTION_X, // NOTE: X route\n                                                   params(\"qt\", \"/stream\",\n                                                          \"expr\", expr));\n      solrStream.setCredentials(WRITE_X_USER, WRITE_X_USER);\n      final List<Tuple> tuples = getTuples(solrStream);\n      assertEquals(3, tuples.size());\n      \n      assertEquals( 5L, tuples.get(0).get(\"batchIndexed\"));\n      assertEquals( 5L, tuples.get(0).get(\"totalIndexed\"));\n      \n      assertEquals( 5L, tuples.get(1).get(\"batchIndexed\"));\n      assertEquals(10L, tuples.get(1).get(\"totalIndexed\"));\n      \n      assertEquals( 3L, tuples.get(2).get(\"batchIndexed\"));\n      assertEquals(13L, tuples.get(2).get(\"totalIndexed\"));\n    }\n\n    assertEquals(42L - 1L - 10L - (13L - 1L), // '42' in last 13 deletes was already deleted from X\n                 commitAndCountDocsInCollection(COLLECTION_X, WRITE_X_USER));\n    assertEquals(42L, commitAndCountDocsInCollection(COLLECTION_Y, WRITE_Y_USER));\n    \n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"140a95988ddfbe87c2376f5fed6acae475ea11fc":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["140a95988ddfbe87c2376f5fed6acae475ea11fc"]},"commit2Childs":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["140a95988ddfbe87c2376f5fed6acae475ea11fc"],"140a95988ddfbe87c2376f5fed6acae475ea11fc":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}