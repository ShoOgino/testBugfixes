{"path":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","commits":[{"id":"7b01e327764dff0c4e657a87afb8a11306045b76","date":1320242486,"type":0,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"/dev/null","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit, shouldn't need any fudge given \n    // other actions already taken\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"fd046f471d3f4fb6cdda913c27847ccd68b3f25c","date":1320269452,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit, shouldn't need any fudge given \n    // other actions already taken\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2c007e7c4cf8c55bc2a5884e315123afaaeec87f","date":1327520966,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d","date":1327523564,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"9ea39f3c731554e6865fa8704123fd3e47e24ed3","date":1327527486,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0d22ac6a4146774c1bc8400160fc0b6150294e92","date":1327528604,"type":3,"author":"Uwe Schindler","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !< \" + postAdd529, \n        manCommit < postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"78a55f24d9b493c2a1cecf79f1d78279062b545b","date":1327688152,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"b9c20614afe92acf4c134c6504cf31f8f7da079d","date":1335103080,"type":3,"author":"Yonik Seeley","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d9405f486872f1e416304dfe389741f4ee2f8a4d","date":1351276739,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"f2126b84bd093fa3d921582a109a0ee578c28126","date":1351522501,"type":3,"author":"Michael McCandless","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n\n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"5306a1c6f41cf709b73be2905ae294a21cb47c3b","date":1356107260,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d3fcb70cf561547c7bb1506e0cf32ca7b1287064","date":1357616416,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"cb1dbe3724f6ff86364fbfaf748fff6f80fd5555","date":1363918233,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(150, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(100, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"bcf9886c8ff537aafde14de48ebf744f5673f08b","date":1439041198,"type":3,"author":"Ramkumar Aiyengar","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occured too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occured too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.currentTimeMillis();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n    \n    assertTrue(\"soft529 occured too fast: \" + \n               del529 + \" + \" + softCommitWaitMillis + \" !<= \" + soft529,\n               del529 + softCommitWaitMillis <= soft529);\n    assertTrue(\"hard529 occured too fast: \" + \n               del529 + \" + \" + hardCommitWaitMillis + \" !<= \" + hard529,\n               del529 + hardCommitWaitMillis <= hard529);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well \n    long slowTestFudge = Math.max(150, 3 * (soft529 - del529 - softCommitWaitMillis));\n    assertTrue(\"searcher529 wasn't soon enough after soft529: \" +\n               searcher529 + \" !< \" + soft529 + \" + \" + slowTestFudge + \" (fudge)\",\n               searcher529 < soft529 + slowTestFudge );\n\n    assertTrue(\"hard529 was before searcher529: \" + \n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0158ced21948b6626f733c1c42c1e18d94449789","date":1462994341,"type":3,"author":"Bartosz Krasiski","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occured too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occured too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d470c8182e92b264680e34081b75e70a9f2b3c89","date":1463985353,"type":3,"author":"Noble Paul","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occured too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occured too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4cce5816ef15a48a0bc11e5d400497ee4301dd3b","date":1476991456,"type":3,"author":"Kevin Risden","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occured too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occured too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commmits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"6a043e93ce5cee80458f8468ac6db8f024055773","date":1486677634,"type":3,"author":"markrmiller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    int startingHardCommits = hardTracker.getCommitCount();\n    int startingSoftCommits = softTracker.getCommitCount();\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    // we don't want to overlap soft and hard opening searchers - this now blocks commits and we\n    // are looking for prompt timings\n    hardTracker.setOpenSearcher(false);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3000, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // wait for the last searcher we triggerd with 550\n    monitor.searcher.poll(5000, MILLISECONDS);\n    \n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n        monitor.hard.poll(1000, MILLISECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n        monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n    \n    monitor.searcher.clear();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we definitely shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n               monitor.hard.poll(2, SECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n               monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"7b9c5b1123d9ab8e01dca627a5bced86092a3824","date":1486686145,"type":3,"author":"markrmiller","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    int startingHardCommits = hardTracker.getCommitCount();\n    int startingSoftCommits = softTracker.getCommitCount();\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    // we don't want to overlap soft and hard opening searchers - this now blocks commits and we\n    // are looking for prompt timings\n    hardTracker.setOpenSearcher(false);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 5, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 5, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // ensure we wait for the last searcher we triggered with 550\n    monitor.searcher.poll(5000, MILLISECONDS);\n    \n    // ensure we wait for the commits on 550\n    monitor.hard.poll(5000, MILLISECONDS);\n    monitor.soft.poll(5000, MILLISECONDS);\n    \n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n        monitor.hard.poll(1000, MILLISECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n        monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n    \n    monitor.searcher.clear();\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    int startingHardCommits = hardTracker.getCommitCount();\n    int startingSoftCommits = softTracker.getCommitCount();\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    // we don't want to overlap soft and hard opening searchers - this now blocks commits and we\n    // are looking for prompt timings\n    hardTracker.setOpenSearcher(false);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 3000, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // wait for the last searcher we triggerd with 550\n    monitor.searcher.poll(5000, MILLISECONDS);\n    \n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n        monitor.hard.poll(1000, MILLISECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n        monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n    \n    monitor.searcher.clear();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"25aea5e95fe9399f6ca9758178fa3a003159ff4d","date":1507651705,"type":3,"author":"Chris Hostetter","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/SoftAutoCommitTest#testSoftAndHardCommitMaxTimeDelete().mjava","sourceNew":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    doTestSoftAndHardCommitMaxTimeDelete(CommitWithinType.NONE);\n  }\n\n","sourceOld":"  public void testSoftAndHardCommitMaxTimeDelete() throws Exception {\n    \n    final int softCommitWaitMillis = 500;\n    final int hardCommitWaitMillis = 1200;\n\n    CommitTracker hardTracker = updater.commitTracker;\n    CommitTracker softTracker = updater.softCommitTracker;\n    \n    int startingHardCommits = hardTracker.getCommitCount();\n    int startingSoftCommits = softTracker.getCommitCount();\n    \n    softTracker.setTimeUpperBound(softCommitWaitMillis);\n    softTracker.setDocsUpperBound(-1);\n    hardTracker.setTimeUpperBound(hardCommitWaitMillis);\n    hardTracker.setDocsUpperBound(-1);\n    // we don't want to overlap soft and hard opening searchers - this now blocks commits and we\n    // are looking for prompt timings\n    hardTracker.setOpenSearcher(false);\n    \n    // add a doc and force a commit\n    assertU(adoc(\"id\", \"529\", \"subject\", \"the doc we care about in this test\"));\n    assertU(commit());\n\n    Long soft529;\n    Long hard529;\n\n/*** an explicit commit can (and should) clear pending auto-commits\n    long postAdd529 = System.currentTimeMillis();\n\n    // wait for first hard/soft commit\n    Long soft529 = monitor.soft.poll(softCommitWaitMillis * 3, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    Long manCommit = monitor.hard.poll(0, MILLISECONDS);\n\n    assertNotNull(\"manCommit wasn't fast enough\", manCommit);\n    assertTrue(\"forced manCommit didn't happen when it should have: \" + \n        manCommit + \" !<= \" + postAdd529, \n        manCommit <= postAdd529);\n    \n    Long hard529 = monitor.hard.poll(hardCommitWaitMillis * 2, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n\n    monitor.assertSaneOffers();\n ***/\n\n    monitor.clear();\n\n    // Delete the document\n    long del529 = System.nanoTime();\n    assertU( delI(\"529\") );\n\n    monitor.assertSaneOffers();\n\n    // Wait for the soft commit with some fudge\n    soft529 = monitor.soft.poll(softCommitWaitMillis * 5, MILLISECONDS);\n    assertNotNull(\"soft529 wasn't fast enough\", soft529);\n    monitor.assertSaneOffers();\n \n    // check for the searcher, should have happened right after soft commit\n    Long searcher529 = monitor.searcher.poll(softCommitWaitMillis, MILLISECONDS);\n    assertNotNull(\"searcher529 wasn't fast enough\", searcher529);\n    monitor.assertSaneOffers();\n\n    // toss in another doc, shouldn't affect first hard commit time we poll\n    assertU(adoc(\"id\", \"550\", \"subject\", \"just for noise/activity\"));\n\n    // wait for the hard commit\n    hard529 = monitor.hard.poll(hardCommitWaitMillis * 5, MILLISECONDS);\n    assertNotNull(\"hard529 wasn't fast enough\", hard529);\n    monitor.assertSaneOffers();\n\n    final long soft529Ms = TimeUnit.MILLISECONDS.convert(soft529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"soft529 occurred too fast, in \" + soft529Ms +\n            \"ms, less than soft commit interval \" + softCommitWaitMillis,\n        soft529Ms >= softCommitWaitMillis);\n    final long hard529Ms = TimeUnit.MILLISECONDS.convert(hard529 - del529, TimeUnit.NANOSECONDS);\n    assertTrue(\"hard529 occurred too fast, in \" +\n            hard529Ms + \"ms, less than hard commit interval \" + hardCommitWaitMillis,\n        hard529Ms >= hardCommitWaitMillis);\n\n    // however slow the machine was to do the soft commit compared to expected,\n    // assume newSearcher had some magnitude of that much overhead as well\n    long slowTestFudge = Math.max(300, 12 * (soft529Ms - softCommitWaitMillis));\n    final long softCommitToSearcherOpenMs = TimeUnit.MILLISECONDS.convert(searcher529 - soft529, TimeUnit.NANOSECONDS);\n    assertTrue(\"searcher529 wasn't soon enough after soft529: Took \" +\n            softCommitToSearcherOpenMs + \"ms, >= acceptable \" + slowTestFudge + \"ms (fudge)\",\n        softCommitToSearcherOpenMs < slowTestFudge);\n\n    assertTrue(\"hard529 was before searcher529: \" +\n               searcher529 + \" !<= \" + hard529,\n               searcher529 <= hard529);\n\n    // ensure we wait for the last searcher we triggered with 550\n    monitor.searcher.poll(5000, MILLISECONDS);\n    \n    // ensure we wait for the commits on 550\n    monitor.hard.poll(5000, MILLISECONDS);\n    monitor.soft.poll(5000, MILLISECONDS);\n    \n    // clear commits\n    monitor.hard.clear();\n    monitor.soft.clear();\n    \n    // wait a bit, w/o other action we shouldn't see any \n    // new hard/soft commits \n    assertNull(\"Got a hard commit we weren't expecting\",\n        monitor.hard.poll(1000, MILLISECONDS));\n    assertNull(\"Got a soft commit we weren't expecting\",\n        monitor.soft.poll(0, MILLISECONDS));\n\n    monitor.assertSaneOffers();\n    \n    monitor.searcher.clear();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"d3fcb70cf561547c7bb1506e0cf32ca7b1287064":["d9405f486872f1e416304dfe389741f4ee2f8a4d","5306a1c6f41cf709b73be2905ae294a21cb47c3b"],"78a55f24d9b493c2a1cecf79f1d78279062b545b":["a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d","9ea39f3c731554e6865fa8704123fd3e47e24ed3"],"5306a1c6f41cf709b73be2905ae294a21cb47c3b":["d9405f486872f1e416304dfe389741f4ee2f8a4d"],"b9c20614afe92acf4c134c6504cf31f8f7da079d":["9ea39f3c731554e6865fa8704123fd3e47e24ed3"],"a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d":["fd046f471d3f4fb6cdda913c27847ccd68b3f25c","2c007e7c4cf8c55bc2a5884e315123afaaeec87f"],"25aea5e95fe9399f6ca9758178fa3a003159ff4d":["7b9c5b1123d9ab8e01dca627a5bced86092a3824"],"d9405f486872f1e416304dfe389741f4ee2f8a4d":["b9c20614afe92acf4c134c6504cf31f8f7da079d"],"9ea39f3c731554e6865fa8704123fd3e47e24ed3":["2c007e7c4cf8c55bc2a5884e315123afaaeec87f"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":["bcf9886c8ff537aafde14de48ebf744f5673f08b","d470c8182e92b264680e34081b75e70a9f2b3c89"],"d470c8182e92b264680e34081b75e70a9f2b3c89":["bcf9886c8ff537aafde14de48ebf744f5673f08b","0158ced21948b6626f733c1c42c1e18d94449789"],"7b9c5b1123d9ab8e01dca627a5bced86092a3824":["6a043e93ce5cee80458f8468ac6db8f024055773"],"6a043e93ce5cee80458f8468ac6db8f024055773":["d470c8182e92b264680e34081b75e70a9f2b3c89"],"0d22ac6a4146774c1bc8400160fc0b6150294e92":["fd046f471d3f4fb6cdda913c27847ccd68b3f25c","9ea39f3c731554e6865fa8704123fd3e47e24ed3"],"7b01e327764dff0c4e657a87afb8a11306045b76":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cb1dbe3724f6ff86364fbfaf748fff6f80fd5555":["5306a1c6f41cf709b73be2905ae294a21cb47c3b"],"fd046f471d3f4fb6cdda913c27847ccd68b3f25c":["7b01e327764dff0c4e657a87afb8a11306045b76"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"2c007e7c4cf8c55bc2a5884e315123afaaeec87f":["fd046f471d3f4fb6cdda913c27847ccd68b3f25c"],"bcf9886c8ff537aafde14de48ebf744f5673f08b":["cb1dbe3724f6ff86364fbfaf748fff6f80fd5555"],"f2126b84bd093fa3d921582a109a0ee578c28126":["b9c20614afe92acf4c134c6504cf31f8f7da079d","d9405f486872f1e416304dfe389741f4ee2f8a4d"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["25aea5e95fe9399f6ca9758178fa3a003159ff4d"],"0158ced21948b6626f733c1c42c1e18d94449789":["bcf9886c8ff537aafde14de48ebf744f5673f08b"]},"commit2Childs":{"d3fcb70cf561547c7bb1506e0cf32ca7b1287064":[],"78a55f24d9b493c2a1cecf79f1d78279062b545b":[],"5306a1c6f41cf709b73be2905ae294a21cb47c3b":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064","cb1dbe3724f6ff86364fbfaf748fff6f80fd5555"],"b9c20614afe92acf4c134c6504cf31f8f7da079d":["d9405f486872f1e416304dfe389741f4ee2f8a4d","f2126b84bd093fa3d921582a109a0ee578c28126"],"a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d":["78a55f24d9b493c2a1cecf79f1d78279062b545b"],"d9405f486872f1e416304dfe389741f4ee2f8a4d":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064","5306a1c6f41cf709b73be2905ae294a21cb47c3b","f2126b84bd093fa3d921582a109a0ee578c28126"],"25aea5e95fe9399f6ca9758178fa3a003159ff4d":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"9ea39f3c731554e6865fa8704123fd3e47e24ed3":["78a55f24d9b493c2a1cecf79f1d78279062b545b","b9c20614afe92acf4c134c6504cf31f8f7da079d","0d22ac6a4146774c1bc8400160fc0b6150294e92"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":[],"d470c8182e92b264680e34081b75e70a9f2b3c89":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","6a043e93ce5cee80458f8468ac6db8f024055773"],"7b9c5b1123d9ab8e01dca627a5bced86092a3824":["25aea5e95fe9399f6ca9758178fa3a003159ff4d"],"6a043e93ce5cee80458f8468ac6db8f024055773":["7b9c5b1123d9ab8e01dca627a5bced86092a3824"],"0d22ac6a4146774c1bc8400160fc0b6150294e92":[],"7b01e327764dff0c4e657a87afb8a11306045b76":["fd046f471d3f4fb6cdda913c27847ccd68b3f25c"],"fd046f471d3f4fb6cdda913c27847ccd68b3f25c":["a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d","0d22ac6a4146774c1bc8400160fc0b6150294e92","2c007e7c4cf8c55bc2a5884e315123afaaeec87f"],"cb1dbe3724f6ff86364fbfaf748fff6f80fd5555":["bcf9886c8ff537aafde14de48ebf744f5673f08b"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["7b01e327764dff0c4e657a87afb8a11306045b76"],"2c007e7c4cf8c55bc2a5884e315123afaaeec87f":["a3c68e20c73359a10cf3eb4a35c9fa7ab1f3c30d","9ea39f3c731554e6865fa8704123fd3e47e24ed3"],"bcf9886c8ff537aafde14de48ebf744f5673f08b":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","d470c8182e92b264680e34081b75e70a9f2b3c89","0158ced21948b6626f733c1c42c1e18d94449789"],"f2126b84bd093fa3d921582a109a0ee578c28126":[],"0158ced21948b6626f733c1c42c1e18d94449789":["d470c8182e92b264680e34081b75e70a9f2b3c89"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064","78a55f24d9b493c2a1cecf79f1d78279062b545b","4cce5816ef15a48a0bc11e5d400497ee4301dd3b","0d22ac6a4146774c1bc8400160fc0b6150294e92","f2126b84bd093fa3d921582a109a0ee578c28126","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}