{"path":"solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery#createWeight(IndexSearcher,ScoreMode,float).mjava","commits":[{"id":"83b987bcc75aaccfc3495fcc98472a4402cae7d1","date":1580487661,"type":0,"author":"Jason Gerlowski","isMerge":false,"pathNew":"solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery#createWeight(IndexSearcher,ScoreMode,float).mjava","pathOld":"/dev/null","sourceNew":"  @Override\n  public Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n    if (! (searcher instanceof SolrIndexSearcher)) {\n      log.debug(\"Falling back to JoinQueryWeight because searcher [{}] is not the required SolrIndexSearcher\", searcher);\n      return super.createWeight(searcher, scoreMode, boost);\n    }\n\n    final SolrIndexSearcher solrSearcher = (SolrIndexSearcher) searcher;\n    final JoinQueryWeight weight = new JoinQueryWeight(solrSearcher, ScoreMode.COMPLETE_NO_SCORES, 1.0f);\n    final SolrIndexSearcher fromSearcher = weight.fromSearcher;\n    final SolrIndexSearcher toSearcher = weight.toSearcher;\n\n    try {\n      final SortedSetDocValues topLevelFromDocValues = validateAndFetchDocValues(fromSearcher, fromField, \"from\");\n      final SortedSetDocValues topLevelToDocValues = validateAndFetchDocValues(toSearcher, toField, \"to\");\n      if (topLevelFromDocValues.getValueCount() == 0 || topLevelToDocValues.getValueCount() == 0) {\n        return createNoMatchesWeight(boost);\n      }\n\n      final LongBitSet fromOrdBitSet = findFieldOrdinalsMatchingQuery(q, fromField, fromSearcher, topLevelFromDocValues);\n      final LongBitSet toOrdBitSet = new LongBitSet(topLevelToDocValues.getValueCount());\n      final BitsetBounds toBitsetBounds = convertFromOrdinalsIntoToField(fromOrdBitSet, topLevelFromDocValues, toOrdBitSet, topLevelToDocValues);\n\n      final boolean toMultivalued = toSearcher.getSchema().getFieldOrNull(toField).multiValued();\n      return new ConstantScoreWeight(this, boost) {\n        public Scorer scorer(LeafReaderContext context) throws IOException {\n          if (toBitsetBounds.lower == BitsetBounds.NO_MATCHES) {\n            return null;\n          }\n\n          final DocIdSetIterator toApproximation = (toMultivalued) ? context.reader().getSortedSetDocValues(toField) :\n              context.reader().getSortedDocValues(toField);\n          if (toApproximation == null) {\n            return null;\n          }\n\n          final int docBase = context.docBase;\n          return new ConstantScoreScorer(this, this.score(), scoreMode, new TwoPhaseIterator(toApproximation) {\n            public boolean matches() throws IOException {\n              final boolean hasDoc = topLevelToDocValues.advanceExact(docBase + approximation.docID());\n              if (hasDoc) {\n                for (long ord = topLevelToDocValues.nextOrd(); ord != -1L; ord = topLevelToDocValues.nextOrd()) {\n                  if (toOrdBitSet.get(ord)) {\n                    return true;\n                  }\n                }\n              }\n              return false;\n            }\n\n            public float matchCost() {\n              return 10.0F;\n            }\n          });\n\n        }\n\n        public boolean isCacheable(LeafReaderContext ctx) {\n          return false;\n        }\n      };\n    } catch (IOException e) {\n      throw new RuntimeException(e);\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["83b987bcc75aaccfc3495fcc98472a4402cae7d1"],"83b987bcc75aaccfc3495fcc98472a4402cae7d1":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"]},"commit2Childs":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["83b987bcc75aaccfc3495fcc98472a4402cae7d1"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[],"83b987bcc75aaccfc3495fcc98472a4402cae7d1":["cd5edd1f2b162a5cfa08efd17851a07373a96817"]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}