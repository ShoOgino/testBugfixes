{"path":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants().mjava","commits":[{"id":"5613a70439d5d429f0689c2c5a21615e58deff97","date":1512102314,"type":1,"author":"David Smiley","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/processor/TimePartitionedUpdateProcessorTest#assertInvariants().mjava","sourceNew":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimeRoutedAliasUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","sourceOld":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimePartitionedUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"af3e10d8a1fbcc5c79b22f7477e79de467dd326c","date":1515178406,"type":5,"author":"David Smiley","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants(String...).mjava","pathOld":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants().mjava","sourceNew":"  private void assertInvariants(String... expectedColls) throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    assertArrayEquals(\"expected reverse sorted\",\n        cols.stream().sorted(Collections.reverseOrder()).toArray(),\n        cols.toArray());\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) { // ASSUMPTION: reverse sorted order\n      final Instant colStartInstant = TimeRoutedAliasUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n    assertArrayEquals(expectedColls, cols.toArray());\n  }\n\n","sourceOld":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimeRoutedAliasUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"b94236357aaa22b76c10629851fe4e376e0cea82","date":1516710914,"type":4,"author":"Karl Wright","isMerge":true,"pathNew":"/dev/null","pathOld":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants().mjava","sourceNew":null,"sourceOld":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimeRoutedAliasUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"b94236357aaa22b76c10629851fe4e376e0cea82":["5613a70439d5d429f0689c2c5a21615e58deff97","af3e10d8a1fbcc5c79b22f7477e79de467dd326c"],"af3e10d8a1fbcc5c79b22f7477e79de467dd326c":["5613a70439d5d429f0689c2c5a21615e58deff97"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"5613a70439d5d429f0689c2c5a21615e58deff97":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["b94236357aaa22b76c10629851fe4e376e0cea82"]},"commit2Childs":{"b94236357aaa22b76c10629851fe4e376e0cea82":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"af3e10d8a1fbcc5c79b22f7477e79de467dd326c":["b94236357aaa22b76c10629851fe4e376e0cea82"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["5613a70439d5d429f0689c2c5a21615e58deff97"],"5613a70439d5d429f0689c2c5a21615e58deff97":["b94236357aaa22b76c10629851fe4e376e0cea82","af3e10d8a1fbcc5c79b22f7477e79de467dd326c"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}