{"path":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","commits":[{"id":"253a79e1af11467dd01315b1919025d288aa0ccb","date":1458032260,"type":0,"author":"Martijn van Groningen","isMerge":false,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"/dev/null","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    if (random().nextBoolean()) {\n      doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n    }\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n      if (random().nextBoolean()) {\n        doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"5af5ba0166322092193d4c29880b0f7670fc7ca0","date":1471440525,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    if (random().nextBoolean()) {\n      doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n    }\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n      if (random().nextBoolean()) {\n        doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2c8bedceb91e64a3f0e831450058fc4a76d2c0a6","date":1471496851,"type":3,"author":"Noble Paul","isMerge":true,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    if (random().nextBoolean()) {\n      doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n    }\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n      if (random().nextBoolean()) {\n        doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"403d05f7f8d69b65659157eff1bc1d2717f04c66","date":1471692961,"type":3,"author":"Karl Wright","isMerge":true,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    if (random().nextBoolean()) {\n      doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n    }\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n      if (random().nextBoolean()) {\n        doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"6652c74b2358a0b13223817a6a793bf1c9d0749d","date":1474465301,"type":3,"author":"Mike McCandless","isMerge":false,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(0, numericDocValues.nextDoc());\n    assertEquals(0, controlNumericDocValues.nextDoc());\n    assertEquals(controlNumericDocValues.longValue(), numericDocValues.longValue());\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, sortedNumericDocValues.nextDoc());\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, controlSortedNumericDocValues.nextDoc());\n    assertEquals(controlSortedNumericDocValues.docValueCount(), sortedNumericDocValues.docValueCount());\n    for (int i = 0; i < controlSortedNumericDocValues.docValueCount(); i++) {\n      assertEquals(controlSortedNumericDocValues.nextValue(), sortedNumericDocValues.nextValue());\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(0, binaryDocValues.nextDoc());\n    assertEquals(0, controlBinaryDocValues.nextDoc());\n    assertEquals(controlBinaryDocValues.binaryValue(), binaryDocValues.binaryValue());\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(0, sortedDocValues.nextDoc());\n    assertEquals(0, controlSortedDocValues.nextDoc());\n    assertEquals(controlSortedDocValues.binaryValue(), sortedDocValues.binaryValue());\n    assertEquals(controlSortedDocValues.ordValue(), sortedDocValues.ordValue());\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, sortedSetDocValues.nextDoc());\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, controlSortedSetDocValues.nextDoc());\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"17e5da53e4e5bd659e22add9bba1cfa222e7e30d","date":1475435902,"type":3,"author":"Karl Wright","isMerge":true,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(0, numericDocValues.nextDoc());\n    assertEquals(0, controlNumericDocValues.nextDoc());\n    assertEquals(controlNumericDocValues.longValue(), numericDocValues.longValue());\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, sortedNumericDocValues.nextDoc());\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, controlSortedNumericDocValues.nextDoc());\n    assertEquals(controlSortedNumericDocValues.docValueCount(), sortedNumericDocValues.docValueCount());\n    for (int i = 0; i < controlSortedNumericDocValues.docValueCount(); i++) {\n      assertEquals(controlSortedNumericDocValues.nextValue(), sortedNumericDocValues.nextValue());\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(0, binaryDocValues.nextDoc());\n    assertEquals(0, controlBinaryDocValues.nextDoc());\n    assertEquals(controlBinaryDocValues.binaryValue(), binaryDocValues.binaryValue());\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(0, sortedDocValues.nextDoc());\n    assertEquals(0, controlSortedDocValues.nextDoc());\n    assertEquals(controlSortedDocValues.binaryValue(), sortedDocValues.binaryValue());\n    assertEquals(controlSortedDocValues.ordValue(), sortedDocValues.ordValue());\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, sortedSetDocValues.nextDoc());\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, controlSortedSetDocValues.nextDoc());\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4cce5816ef15a48a0bc11e5d400497ee4301dd3b","date":1476991456,"type":3,"author":"Kevin Risden","isMerge":true,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(0, numericDocValues.nextDoc());\n    assertEquals(0, controlNumericDocValues.nextDoc());\n    assertEquals(controlNumericDocValues.longValue(), numericDocValues.longValue());\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, sortedNumericDocValues.nextDoc());\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, controlSortedNumericDocValues.nextDoc());\n    assertEquals(controlSortedNumericDocValues.docValueCount(), sortedNumericDocValues.docValueCount());\n    for (int i = 0; i < controlSortedNumericDocValues.docValueCount(); i++) {\n      assertEquals(controlSortedNumericDocValues.nextValue(), sortedNumericDocValues.nextValue());\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(0, binaryDocValues.nextDoc());\n    assertEquals(0, controlBinaryDocValues.nextDoc());\n    assertEquals(controlBinaryDocValues.binaryValue(), binaryDocValues.binaryValue());\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(0, sortedDocValues.nextDoc());\n    assertEquals(0, controlSortedDocValues.nextDoc());\n    assertEquals(controlSortedDocValues.binaryValue(), sortedDocValues.binaryValue());\n    assertEquals(controlSortedDocValues.ordValue(), sortedDocValues.ordValue());\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, sortedSetDocValues.nextDoc());\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, controlSortedSetDocValues.nextDoc());\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    if (random().nextBoolean()) {\n      doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n    }\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n      if (random().nextBoolean()) {\n        doc.add(new LegacyLongField(\"numeric\", randomLong, Field.Store.NO));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(controlNumericDocValues.get(0), numericDocValues.get(0));\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    sortedNumericDocValues.setDocument(0);\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    controlSortedNumericDocValues.setDocument(0);\n    assertEquals(controlSortedNumericDocValues.count(), sortedNumericDocValues.count());\n    for (int i = 0; i < controlSortedNumericDocValues.count(); i++) {\n      assertEquals(controlSortedNumericDocValues.valueAt(i), sortedNumericDocValues.valueAt(i));\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(controlBinaryDocValues.get(0), binaryDocValues.get(0));\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(controlSortedDocValues.get(0), sortedDocValues.get(0));\n    assertEquals(controlSortedDocValues.getOrd(0), sortedDocValues.getOrd(0));\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    sortedSetDocValues.setDocument(0);\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    controlSortedSetDocValues.setDocument(0);\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d77dafd89756a5161d244985903e3487ca109182","date":1548679743,"type":5,"author":"Dawid Weiss","isMerge":false,"pathNew":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstDirectory#testDocValuesMemoryIndexVsNormalIndex().mjava","pathOld":"lucene/memory/src/test/org/apache/lucene/index/memory/TestMemoryIndexAgainstRAMDir#testDocValuesMemoryIndexVsNormalIndex().mjava","sourceNew":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(0, numericDocValues.nextDoc());\n    assertEquals(0, controlNumericDocValues.nextDoc());\n    assertEquals(controlNumericDocValues.longValue(), numericDocValues.longValue());\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, sortedNumericDocValues.nextDoc());\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, controlSortedNumericDocValues.nextDoc());\n    assertEquals(controlSortedNumericDocValues.docValueCount(), sortedNumericDocValues.docValueCount());\n    for (int i = 0; i < controlSortedNumericDocValues.docValueCount(); i++) {\n      assertEquals(controlSortedNumericDocValues.nextValue(), sortedNumericDocValues.nextValue());\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(0, binaryDocValues.nextDoc());\n    assertEquals(0, controlBinaryDocValues.nextDoc());\n    assertEquals(controlBinaryDocValues.binaryValue(), binaryDocValues.binaryValue());\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(0, sortedDocValues.nextDoc());\n    assertEquals(0, controlSortedDocValues.nextDoc());\n    assertEquals(controlSortedDocValues.binaryValue(), sortedDocValues.binaryValue());\n    assertEquals(controlSortedDocValues.ordValue(), sortedDocValues.ordValue());\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, sortedSetDocValues.nextDoc());\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, controlSortedSetDocValues.nextDoc());\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testDocValuesMemoryIndexVsNormalIndex() throws Exception {\n    Document doc = new Document();\n    long randomLong = random().nextLong();\n    doc.add(new NumericDocValuesField(\"numeric\", randomLong));\n    int numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomLong = random().nextLong();\n      doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedNumericDocValuesField(\"sorted_numeric\", randomLong));\n      }\n    }\n    BytesRef randomTerm = new BytesRef(randomTerm());\n    doc.add(new BinaryDocValuesField(\"binary\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"binary\", randomTerm, Field.Store.NO));\n    }\n    randomTerm = new BytesRef(randomTerm());\n    doc.add(new SortedDocValuesField(\"sorted\", randomTerm));\n    if (random().nextBoolean()) {\n      doc.add(new StringField(\"sorted\", randomTerm, Field.Store.NO));\n    }\n    numValues = atLeast(5);\n    for (int i = 0; i < numValues; i++) {\n      randomTerm = new BytesRef(randomTerm());\n      doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      if (random().nextBoolean()) {\n        // randomly duplicate field/value\n        doc.add(new SortedSetDocValuesField(\"sorted_set\", randomTerm));\n      }\n      if (random().nextBoolean()) {\n        // randomily just add a normal string field\n        doc.add(new StringField(\"sorted_set\", randomTerm, Field.Store.NO));\n      }\n    }\n\n    MockAnalyzer mockAnalyzer = new MockAnalyzer(random());\n    MemoryIndex memoryIndex = MemoryIndex.fromDocument(doc, mockAnalyzer);\n    IndexReader indexReader = memoryIndex.createSearcher().getIndexReader();\n    LeafReader leafReader =  indexReader.leaves().get(0).reader();\n\n    Directory dir = newDirectory();\n    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(random(), mockAnalyzer));\n    writer.addDocument(doc);\n    writer.close();\n    IndexReader controlIndexReader = DirectoryReader.open(dir);\n    LeafReader controlLeafReader =  controlIndexReader.leaves().get(0).reader();\n\n    NumericDocValues numericDocValues = leafReader.getNumericDocValues(\"numeric\");\n    NumericDocValues controlNumericDocValues = controlLeafReader.getNumericDocValues(\"numeric\");\n    assertEquals(0, numericDocValues.nextDoc());\n    assertEquals(0, controlNumericDocValues.nextDoc());\n    assertEquals(controlNumericDocValues.longValue(), numericDocValues.longValue());\n\n    SortedNumericDocValues sortedNumericDocValues = leafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, sortedNumericDocValues.nextDoc());\n    SortedNumericDocValues controlSortedNumericDocValues = controlLeafReader.getSortedNumericDocValues(\"sorted_numeric\");\n    assertEquals(0, controlSortedNumericDocValues.nextDoc());\n    assertEquals(controlSortedNumericDocValues.docValueCount(), sortedNumericDocValues.docValueCount());\n    for (int i = 0; i < controlSortedNumericDocValues.docValueCount(); i++) {\n      assertEquals(controlSortedNumericDocValues.nextValue(), sortedNumericDocValues.nextValue());\n    }\n\n    BinaryDocValues binaryDocValues = leafReader.getBinaryDocValues(\"binary\");\n    BinaryDocValues controlBinaryDocValues = controlLeafReader.getBinaryDocValues(\"binary\");\n    assertEquals(0, binaryDocValues.nextDoc());\n    assertEquals(0, controlBinaryDocValues.nextDoc());\n    assertEquals(controlBinaryDocValues.binaryValue(), binaryDocValues.binaryValue());\n\n    SortedDocValues sortedDocValues = leafReader.getSortedDocValues(\"sorted\");\n    SortedDocValues controlSortedDocValues = controlLeafReader.getSortedDocValues(\"sorted\");\n    assertEquals(controlSortedDocValues.getValueCount(), sortedDocValues.getValueCount());\n    assertEquals(0, sortedDocValues.nextDoc());\n    assertEquals(0, controlSortedDocValues.nextDoc());\n    assertEquals(controlSortedDocValues.binaryValue(), sortedDocValues.binaryValue());\n    assertEquals(controlSortedDocValues.ordValue(), sortedDocValues.ordValue());\n    assertEquals(controlSortedDocValues.lookupOrd(0), sortedDocValues.lookupOrd(0));\n\n    SortedSetDocValues sortedSetDocValues = leafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, sortedSetDocValues.nextDoc());\n    SortedSetDocValues controlSortedSetDocValues = controlLeafReader.getSortedSetDocValues(\"sorted_set\");\n    assertEquals(0, controlSortedSetDocValues.nextDoc());\n    assertEquals(controlSortedSetDocValues.getValueCount(), sortedSetDocValues.getValueCount());\n    for (long controlOrd = controlSortedSetDocValues.nextOrd(); controlOrd != SortedSetDocValues.NO_MORE_ORDS;\n         controlOrd = controlSortedSetDocValues.nextOrd()) {\n      assertEquals(controlOrd, sortedSetDocValues.nextOrd());\n      assertEquals(controlSortedSetDocValues.lookupOrd(controlOrd), sortedSetDocValues.lookupOrd(controlOrd));\n    }\n    assertEquals(SortedSetDocValues.NO_MORE_ORDS, sortedSetDocValues.nextOrd());\n\n    indexReader.close();\n    controlIndexReader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"403d05f7f8d69b65659157eff1bc1d2717f04c66":["253a79e1af11467dd01315b1919025d288aa0ccb","2c8bedceb91e64a3f0e831450058fc4a76d2c0a6"],"253a79e1af11467dd01315b1919025d288aa0ccb":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"17e5da53e4e5bd659e22add9bba1cfa222e7e30d":["403d05f7f8d69b65659157eff1bc1d2717f04c66","6652c74b2358a0b13223817a6a793bf1c9d0749d"],"6652c74b2358a0b13223817a6a793bf1c9d0749d":["403d05f7f8d69b65659157eff1bc1d2717f04c66"],"d77dafd89756a5161d244985903e3487ca109182":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"5af5ba0166322092193d4c29880b0f7670fc7ca0":["253a79e1af11467dd01315b1919025d288aa0ccb"],"2c8bedceb91e64a3f0e831450058fc4a76d2c0a6":["253a79e1af11467dd01315b1919025d288aa0ccb","5af5ba0166322092193d4c29880b0f7670fc7ca0"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":["253a79e1af11467dd01315b1919025d288aa0ccb","17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["d77dafd89756a5161d244985903e3487ca109182"]},"commit2Childs":{"403d05f7f8d69b65659157eff1bc1d2717f04c66":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d","6652c74b2358a0b13223817a6a793bf1c9d0749d"],"253a79e1af11467dd01315b1919025d288aa0ccb":["403d05f7f8d69b65659157eff1bc1d2717f04c66","5af5ba0166322092193d4c29880b0f7670fc7ca0","2c8bedceb91e64a3f0e831450058fc4a76d2c0a6","4cce5816ef15a48a0bc11e5d400497ee4301dd3b"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["253a79e1af11467dd01315b1919025d288aa0ccb"],"17e5da53e4e5bd659e22add9bba1cfa222e7e30d":["d77dafd89756a5161d244985903e3487ca109182","4cce5816ef15a48a0bc11e5d400497ee4301dd3b"],"6652c74b2358a0b13223817a6a793bf1c9d0749d":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"d77dafd89756a5161d244985903e3487ca109182":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"5af5ba0166322092193d4c29880b0f7670fc7ca0":["2c8bedceb91e64a3f0e831450058fc4a76d2c0a6"],"2c8bedceb91e64a3f0e831450058fc4a76d2c0a6":["403d05f7f8d69b65659157eff1bc1d2717f04c66"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}