{"path":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","commits":[{"id":"ab5548b8f3ccb00ab6a8702dfc85a949d2a05a11","date":1367321736,"type":0,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"/dev/null","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new CachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n    System.out.println(\"group: \" + group);\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161","date":1378462032,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n    System.out.println(\"group: \" + group);\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new CachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n    System.out.println(\"group: \" + group);\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2e18c86f811939bfa8cd24046c96ed026f2e9b34","date":1393893071,"type":3,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n    System.out.println(\"group: \" + group);\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"acf00221f44c5f08ccea014f2492b53af15ecd66","date":1394568293,"type":3,"author":"Michael McCandless","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n    System.out.println(\"group: \" + group);\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"634f330c54fd3f9f491d52036dc3f40b4f4d8934","date":1394635157,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<Document>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"ae14298f4eec6d5faee6a149f88ba57d14a6f21a","date":1396971290,"type":3,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.shutdown();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d0ef034a4f10871667ae75181537775ddcf8ade4","date":1407610475,"type":3,"author":"Ryan Ernst","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.shutdown();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"b012914a8110b2ff1d075ed1ef72aa57084d4897","date":1414685177,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    Filter parentsFilter = new FixedBitSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0ed6b1234af94a2693d3e6550e7b3ee41fd3f51c","date":1416362965,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"f582f18c13d4852b01d4fe0a0196432c5c6f2b7f","date":1421314520,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    newSearcher(r).search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"3f68d01cf19df971dcdcb05e30247f4ad7ec9747","date":1434611645,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery parentQuery = new BooleanQuery();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery, c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4b3915945926c0bf7def01b0c504977709d3aed3","date":1436197708,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitDocIdSetFilter parentsFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"isParent\", \"yes\"))));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"a67f37df79147ed4dd608300c2336c2979db98be","date":1436271524,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"6654c5f3ec2e4a84ef867c82d4eec872c2372c8c","date":1453060490,"type":3,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    StoredDocument doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0e7bc21595222ae4f75509300fbb7726691f387f","date":1464078795,"type":3,"author":"Dawid Weiss","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4cce5816ef15a48a0bc11e5d400497ee4301dd3b","date":1476991456,"type":3,"author":"Kevin Risden","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n    \n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"9d9452e13e015fa1187b0b1bed1a1d08b9c96241","date":1485723373,"type":4,"author":"Martijn van Groningen","isMerge":false,"pathNew":"/dev/null","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":null,"sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"7c3523a0ab04c3002eee3896c75ea5f10f388bcc","date":1485968422,"type":4,"author":"Kevin Risden","isMerge":true,"pathNew":"/dev/null","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoin#testSometimesParentOnlyMatches().mjava","sourceNew":null,"sourceOld":"  // LUCENE-4968\n  public void testSometimesParentOnlyMatches() throws Exception {\n    Directory d = newDirectory();\n    RandomIndexWriter w = new RandomIndexWriter(random(), d);\n    Document parent = new Document();\n    parent.add(new StoredField(\"parentID\", \"0\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"0\")));\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n\n    List<Document> docs = new ArrayList<>();\n\n    Document child = new Document();\n    docs.add(child);\n    child.add(new StoredField(\"childID\", \"0\"));\n    child.add(newTextField(\"childText\", \"text\", Field.Store.NO));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    docs.clear();\n\n    parent = new Document();\n    parent.add(newTextField(\"parentText\", \"text\", Field.Store.NO));\n    parent.add(newStringField(\"isParent\", \"yes\", Field.Store.NO));\n    parent.add(new StoredField(\"parentID\", \"1\"));\n    parent.add(new SortedDocValuesField(\"parentID\", new BytesRef(\"1\")));\n\n    // parent last:\n    docs.add(parent);\n    w.addDocuments(docs);\n\n    IndexReader r = w.getReader();\n    w.close();\n\n    IndexSearcher searcher = new ToParentBlockJoinIndexSearcher(r);\n    Query childQuery = new TermQuery(new Term(\"childText\", \"text\"));\n    BitSetProducer parentsFilter = new QueryBitSetProducer(new TermQuery(new Term(\"isParent\", \"yes\")));\n    CheckJoinIndex.check(r, parentsFilter);\n    ToParentBlockJoinQuery childJoinQuery = new ToParentBlockJoinQuery(childQuery, parentsFilter, ScoreMode.Avg);\n    BooleanQuery.Builder parentQuery = new BooleanQuery.Builder();\n    parentQuery.add(childJoinQuery, Occur.SHOULD);\n    parentQuery.add(new TermQuery(new Term(\"parentText\", \"text\")), Occur.SHOULD);\n\n    ToParentBlockJoinCollector c = new ToParentBlockJoinCollector(new Sort(new SortField(\"parentID\", SortField.Type.STRING)),\n                                                                  10, true, true);\n    searcher.search(parentQuery.build(), c);\n    TopGroups<Integer> groups = c.getTopGroups(childJoinQuery, null, 0, 10, 0, false);\n\n    // Two parents:\n    assertEquals(2, groups.totalGroupCount.intValue());\n\n    // One child docs:\n    assertEquals(1, groups.totalGroupedHitCount);\n\n    GroupDocs<Integer> group = groups.groups[0];\n    Document doc = r.document(group.groupValue.intValue());\n    assertEquals(\"0\", doc.get(\"parentID\"));\n\n    group = groups.groups[1];\n    doc = r.document(group.groupValue.intValue());\n    assertEquals(\"1\", doc.get(\"parentID\"));\n\n    r.close();\n    d.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"2e18c86f811939bfa8cd24046c96ed026f2e9b34":["49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161"],"634f330c54fd3f9f491d52036dc3f40b4f4d8934":["acf00221f44c5f08ccea014f2492b53af15ecd66"],"b012914a8110b2ff1d075ed1ef72aa57084d4897":["d0ef034a4f10871667ae75181537775ddcf8ade4"],"a67f37df79147ed4dd608300c2336c2979db98be":["4b3915945926c0bf7def01b0c504977709d3aed3"],"7c3523a0ab04c3002eee3896c75ea5f10f388bcc":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","9d9452e13e015fa1187b0b1bed1a1d08b9c96241"],"4b3915945926c0bf7def01b0c504977709d3aed3":["3f68d01cf19df971dcdcb05e30247f4ad7ec9747"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":["6654c5f3ec2e4a84ef867c82d4eec872c2372c8c","0e7bc21595222ae4f75509300fbb7726691f387f"],"0ed6b1234af94a2693d3e6550e7b3ee41fd3f51c":["b012914a8110b2ff1d075ed1ef72aa57084d4897"],"3f68d01cf19df971dcdcb05e30247f4ad7ec9747":["f582f18c13d4852b01d4fe0a0196432c5c6f2b7f"],"f582f18c13d4852b01d4fe0a0196432c5c6f2b7f":["0ed6b1234af94a2693d3e6550e7b3ee41fd3f51c"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"0e7bc21595222ae4f75509300fbb7726691f387f":["6654c5f3ec2e4a84ef867c82d4eec872c2372c8c"],"d0ef034a4f10871667ae75181537775ddcf8ade4":["ae14298f4eec6d5faee6a149f88ba57d14a6f21a"],"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161":["ab5548b8f3ccb00ab6a8702dfc85a949d2a05a11"],"ae14298f4eec6d5faee6a149f88ba57d14a6f21a":["634f330c54fd3f9f491d52036dc3f40b4f4d8934"],"ab5548b8f3ccb00ab6a8702dfc85a949d2a05a11":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"acf00221f44c5f08ccea014f2492b53af15ecd66":["49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161","2e18c86f811939bfa8cd24046c96ed026f2e9b34"],"9d9452e13e015fa1187b0b1bed1a1d08b9c96241":["0e7bc21595222ae4f75509300fbb7726691f387f"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["9d9452e13e015fa1187b0b1bed1a1d08b9c96241"],"6654c5f3ec2e4a84ef867c82d4eec872c2372c8c":["a67f37df79147ed4dd608300c2336c2979db98be"]},"commit2Childs":{"2e18c86f811939bfa8cd24046c96ed026f2e9b34":["acf00221f44c5f08ccea014f2492b53af15ecd66"],"634f330c54fd3f9f491d52036dc3f40b4f4d8934":["ae14298f4eec6d5faee6a149f88ba57d14a6f21a"],"b012914a8110b2ff1d075ed1ef72aa57084d4897":["0ed6b1234af94a2693d3e6550e7b3ee41fd3f51c"],"a67f37df79147ed4dd608300c2336c2979db98be":["6654c5f3ec2e4a84ef867c82d4eec872c2372c8c"],"7c3523a0ab04c3002eee3896c75ea5f10f388bcc":[],"4b3915945926c0bf7def01b0c504977709d3aed3":["a67f37df79147ed4dd608300c2336c2979db98be"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":["7c3523a0ab04c3002eee3896c75ea5f10f388bcc"],"0ed6b1234af94a2693d3e6550e7b3ee41fd3f51c":["f582f18c13d4852b01d4fe0a0196432c5c6f2b7f"],"3f68d01cf19df971dcdcb05e30247f4ad7ec9747":["4b3915945926c0bf7def01b0c504977709d3aed3"],"f582f18c13d4852b01d4fe0a0196432c5c6f2b7f":["3f68d01cf19df971dcdcb05e30247f4ad7ec9747"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["ab5548b8f3ccb00ab6a8702dfc85a949d2a05a11"],"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161":["2e18c86f811939bfa8cd24046c96ed026f2e9b34","acf00221f44c5f08ccea014f2492b53af15ecd66"],"d0ef034a4f10871667ae75181537775ddcf8ade4":["b012914a8110b2ff1d075ed1ef72aa57084d4897"],"0e7bc21595222ae4f75509300fbb7726691f387f":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","9d9452e13e015fa1187b0b1bed1a1d08b9c96241"],"ae14298f4eec6d5faee6a149f88ba57d14a6f21a":["d0ef034a4f10871667ae75181537775ddcf8ade4"],"ab5548b8f3ccb00ab6a8702dfc85a949d2a05a11":["49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161"],"acf00221f44c5f08ccea014f2492b53af15ecd66":["634f330c54fd3f9f491d52036dc3f40b4f4d8934"],"9d9452e13e015fa1187b0b1bed1a1d08b9c96241":["7c3523a0ab04c3002eee3896c75ea5f10f388bcc","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"6654c5f3ec2e4a84ef867c82d4eec872c2372c8c":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","0e7bc21595222ae4f75509300fbb7726691f387f"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["7c3523a0ab04c3002eee3896c75ea5f10f388bcc","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}