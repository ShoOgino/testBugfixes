{"path":"lucene/core/src/test/org/apache/lucene/search/TestTopDocsCollector#testConcurrentMinScoreTopScoreDocs().mjava","commits":[{"id":"5319c194edd3bf49f39c6d198107ed213c1d3670","date":1569842580,"type":0,"author":"jimczi","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/search/TestTopDocsCollector#testConcurrentMinScoreTopScoreDocs().mjava","pathOld":"/dev/null","sourceNew":"  public void testConcurrentMinScoreTopScoreDocs() throws Exception {\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(dir, newIndexWriterConfig().setMergePolicy(NoMergePolicy.INSTANCE));\n    Document doc = new Document();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc));\n    w.flush();\n    IndexReader reader = DirectoryReader.open(w);\n    assertEquals(3, reader.leaves().size());\n    w.close();\n\n    CollectorManager<TopScoreDocCollector, TopDocs> manager =\n        TopScoreDocCollector.createSharedManager(2, null, 0);\n    TopScoreDocCollector collector = manager.newCollector();\n    TopScoreDocCollector collector2 = manager.newCollector();\n    assertTrue(collector.bottomValueChecker == collector2.bottomValueChecker);\n    BottomValueChecker minValueChecker = collector.bottomValueChecker;\n\n    ScoreAndDoc scorer = new ScoreAndDoc();\n    ScoreAndDoc scorer2 = new ScoreAndDoc();\n\n    LeafCollector leafCollector = collector.getLeafCollector(reader.leaves().get(0));\n    leafCollector.setScorer(scorer);\n    LeafCollector leafCollector2 = collector2.getLeafCollector(reader.leaves().get(1));\n    leafCollector2.setScorer(scorer2);\n\n    scorer.doc = 0;\n    scorer.score = 3;\n    leafCollector.collect(0);\n\n    scorer2.doc = 0;\n    scorer2.score = 6;\n    leafCollector2.collect(0);\n\n    scorer.doc = 1;\n    scorer.score = 2;\n    leafCollector.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 2f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertNull(scorer2.minCompetitiveScore);\n\n    scorer2.doc = 1;\n    scorer2.score = 9;\n    leafCollector2.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 6f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(6f), 0f);\n\n    scorer2.doc = 2;\n    scorer2.score = 7;\n    leafCollector2.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer2.doc = 3;\n    scorer2.score = 1;\n    leafCollector2.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 2;\n    scorer.score = 10;\n    leafCollector.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, 7f, 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 3;\n    scorer.score = 11;\n    leafCollector.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 10, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(10f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    TopScoreDocCollector collector3 = manager.newCollector();\n    LeafCollector leafCollector3 = collector3.getLeafCollector(reader.leaves().get(2));\n    ScoreAndDoc scorer3 = new ScoreAndDoc();\n    leafCollector3.setScorer(scorer3);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 0;\n    scorer3.score = 1f;\n    leafCollector3.collect(0);\n    assertEquals(minValueChecker.getBottomValue(), 10f, 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer.doc = 4;\n    scorer.score = 11;\n    leafCollector.collect(4);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 1;\n    scorer3.score = 2f;\n    leafCollector3.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 11f, 0f);\n\n\n    TopDocs topDocs = manager.reduce(Arrays.asList(collector, collector2, collector3));\n    assertEquals(11, topDocs.totalHits.value);\n    assertEquals(new TotalHits(11, TotalHits.Relation.GREATER_THAN_OR_EQUAL_TO), topDocs.totalHits);\n\n    reader.close();\n    dir.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"f00d3f1ad3bbb957062c4871ec23f49edda800c6","date":1569925943,"type":5,"author":"jimczi","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/search/TestTopDocsCollector#testConcurrentMinScore().mjava","pathOld":"lucene/core/src/test/org/apache/lucene/search/TestTopDocsCollector#testConcurrentMinScoreTopScoreDocs().mjava","sourceNew":"  public void testConcurrentMinScore() throws Exception {\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(dir, newIndexWriterConfig().setMergePolicy(NoMergePolicy.INSTANCE));\n    Document doc = new Document();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc));\n    w.flush();\n    IndexReader reader = DirectoryReader.open(w);\n    assertEquals(3, reader.leaves().size());\n    w.close();\n\n    CollectorManager<TopScoreDocCollector, TopDocs> manager =\n        TopScoreDocCollector.createSharedManager(2, null, 0);\n    TopScoreDocCollector collector = manager.newCollector();\n    TopScoreDocCollector collector2 = manager.newCollector();\n    assertTrue(collector.bottomValueChecker == collector2.bottomValueChecker);\n    BottomValueChecker minValueChecker = collector.bottomValueChecker;\n\n    ScoreAndDoc scorer = new ScoreAndDoc();\n    ScoreAndDoc scorer2 = new ScoreAndDoc();\n\n    LeafCollector leafCollector = collector.getLeafCollector(reader.leaves().get(0));\n    leafCollector.setScorer(scorer);\n    LeafCollector leafCollector2 = collector2.getLeafCollector(reader.leaves().get(1));\n    leafCollector2.setScorer(scorer2);\n\n    scorer.doc = 0;\n    scorer.score = 3;\n    leafCollector.collect(0);\n\n    scorer2.doc = 0;\n    scorer2.score = 6;\n    leafCollector2.collect(0);\n\n    scorer.doc = 1;\n    scorer.score = 2;\n    leafCollector.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 2f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertNull(scorer2.minCompetitiveScore);\n\n    scorer2.doc = 1;\n    scorer2.score = 9;\n    leafCollector2.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 6f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(6f), 0f);\n\n    scorer2.doc = 2;\n    scorer2.score = 7;\n    leafCollector2.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer2.doc = 3;\n    scorer2.score = 1;\n    leafCollector2.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 2;\n    scorer.score = 10;\n    leafCollector.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, 7f, 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 3;\n    scorer.score = 11;\n    leafCollector.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 10, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(10f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    TopScoreDocCollector collector3 = manager.newCollector();\n    LeafCollector leafCollector3 = collector3.getLeafCollector(reader.leaves().get(2));\n    ScoreAndDoc scorer3 = new ScoreAndDoc();\n    leafCollector3.setScorer(scorer3);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 0;\n    scorer3.score = 1f;\n    leafCollector3.collect(0);\n    assertEquals(minValueChecker.getBottomValue(), 10f, 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer.doc = 4;\n    scorer.score = 11;\n    leafCollector.collect(4);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 1;\n    scorer3.score = 2f;\n    leafCollector3.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 11f, 0f);\n\n\n    TopDocs topDocs = manager.reduce(Arrays.asList(collector, collector2, collector3));\n    assertEquals(11, topDocs.totalHits.value);\n    assertEquals(new TotalHits(11, TotalHits.Relation.GREATER_THAN_OR_EQUAL_TO), topDocs.totalHits);\n\n    reader.close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testConcurrentMinScoreTopScoreDocs() throws Exception {\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(dir, newIndexWriterConfig().setMergePolicy(NoMergePolicy.INSTANCE));\n    Document doc = new Document();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc, doc, doc, doc, doc));\n    w.flush();\n    w.addDocuments(Arrays.asList(doc, doc));\n    w.flush();\n    IndexReader reader = DirectoryReader.open(w);\n    assertEquals(3, reader.leaves().size());\n    w.close();\n\n    CollectorManager<TopScoreDocCollector, TopDocs> manager =\n        TopScoreDocCollector.createSharedManager(2, null, 0);\n    TopScoreDocCollector collector = manager.newCollector();\n    TopScoreDocCollector collector2 = manager.newCollector();\n    assertTrue(collector.bottomValueChecker == collector2.bottomValueChecker);\n    BottomValueChecker minValueChecker = collector.bottomValueChecker;\n\n    ScoreAndDoc scorer = new ScoreAndDoc();\n    ScoreAndDoc scorer2 = new ScoreAndDoc();\n\n    LeafCollector leafCollector = collector.getLeafCollector(reader.leaves().get(0));\n    leafCollector.setScorer(scorer);\n    LeafCollector leafCollector2 = collector2.getLeafCollector(reader.leaves().get(1));\n    leafCollector2.setScorer(scorer2);\n\n    scorer.doc = 0;\n    scorer.score = 3;\n    leafCollector.collect(0);\n\n    scorer2.doc = 0;\n    scorer2.score = 6;\n    leafCollector2.collect(0);\n\n    scorer.doc = 1;\n    scorer.score = 2;\n    leafCollector.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 2f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertNull(scorer2.minCompetitiveScore);\n\n    scorer2.doc = 1;\n    scorer2.score = 9;\n    leafCollector2.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 6f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(6f), 0f);\n\n    scorer2.doc = 2;\n    scorer2.score = 7;\n    leafCollector2.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer2.doc = 3;\n    scorer2.score = 1;\n    leafCollector2.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(2f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 2;\n    scorer.score = 10;\n    leafCollector.collect(2);\n    assertEquals(minValueChecker.getBottomValue(), 7f, 0f);\n    assertEquals(scorer.minCompetitiveScore, 7f, 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    scorer.doc = 3;\n    scorer.score = 11;\n    leafCollector.collect(3);\n    assertEquals(minValueChecker.getBottomValue(), 10, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(10f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n\n    TopScoreDocCollector collector3 = manager.newCollector();\n    LeafCollector leafCollector3 = collector3.getLeafCollector(reader.leaves().get(2));\n    ScoreAndDoc scorer3 = new ScoreAndDoc();\n    leafCollector3.setScorer(scorer3);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 0;\n    scorer3.score = 1f;\n    leafCollector3.collect(0);\n    assertEquals(minValueChecker.getBottomValue(), 10f, 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer.doc = 4;\n    scorer.score = 11;\n    leafCollector.collect(4);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 10f, 0f);\n\n    scorer3.doc = 1;\n    scorer3.score = 2f;\n    leafCollector3.collect(1);\n    assertEquals(minValueChecker.getBottomValue(), 11f, 0f);\n    assertEquals(scorer.minCompetitiveScore, Math.nextUp(11f), 0f);\n    assertEquals(scorer2.minCompetitiveScore, Math.nextUp(7f), 0f);\n    assertEquals(scorer3.minCompetitiveScore, 11f, 0f);\n\n\n    TopDocs topDocs = manager.reduce(Arrays.asList(collector, collector2, collector3));\n    assertEquals(11, topDocs.totalHits.value);\n    assertEquals(new TotalHits(11, TotalHits.Relation.GREATER_THAN_OR_EQUAL_TO), topDocs.totalHits);\n\n    reader.close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"f00d3f1ad3bbb957062c4871ec23f49edda800c6":["5319c194edd3bf49f39c6d198107ed213c1d3670"],"5319c194edd3bf49f39c6d198107ed213c1d3670":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"]},"commit2Childs":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["5319c194edd3bf49f39c6d198107ed213c1d3670","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"f00d3f1ad3bbb957062c4871ec23f49edda800c6":[],"5319c194edd3bf49f39c6d198107ed213c1d3670":["f00d3f1ad3bbb957062c4871ec23f49edda800c6"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["f00d3f1ad3bbb957062c4871ec23f49edda800c6","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}