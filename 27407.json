{"path":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","commits":[{"id":"e27b99259bc542853bfc42f809014f56aad988fb","date":1366018447,"type":0,"author":"Martijn van Groningen","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"/dev/null","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir);\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"f53c6f42e7b48d8350238aaa12672718d128c3e8","date":1366984375,"type":3,"author":"Martijn van Groningen","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir);\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161","date":1378462032,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new CachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"ae14298f4eec6d5faee6a149f88ba57d14a6f21a","date":1396971290,"type":3,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"7e2fb55c0777755badd3b46d8140f3d4301febed","date":1398881584,"type":3,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.COMPOUND_FILES));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"b70a13d2b73512ad6b204e9ad8fe09ffeeda3c2c","date":1399816179,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"93dd449115a9247533e44bab47e8429e5dccbc6d","date":1400258396,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"56572ec06f1407c066d6b7399413178b33176cd8","date":1400495675,"type":3,"author":"Michael McCandless","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"54a6bea0b991120a99ad0e2f72ae853fd5ecae0e","date":1406737224,"type":3,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(TEST_VERSION_CURRENT,\n        new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d0ef034a4f10871667ae75181537775ddcf8ade4","date":1407610475,"type":3,"author":"Ryan Ernst","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.shutdown();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"b012914a8110b2ff1d075ed1ef72aa57084d4897","date":1414685177,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitDocIdSetFilter parentFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\"))));\n    BitDocIdSetFilter childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\"))));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\")))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    Filter parentFilter = new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\")));\n    Filter childFilter = new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, wrap(parentFilter), wrap(childFilter)\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new FixedBitSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, wrap(parentFilter), wrap(childFilter)\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"1db68e96dd908fcd79ef809095822736aa601d08","date":1434630596,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitDocIdSetFilter parentFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\"))));\n    BitDocIdSetFilter childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\"))));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        childFilter,\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\")))));\n    query = new ToParentBlockJoinQuery(\n        childFilter,\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitDocIdSetFilter parentFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\"))));\n    BitDocIdSetFilter childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\"))));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\")))));\n    query = new ToParentBlockJoinQuery(\n        new FilteredQuery(new MatchAllDocsQuery(), childFilter),\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4b3915945926c0bf7def01b0c504977709d3aed3","date":1436197708,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitDocIdSetFilter parentFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term(\"__type\", \"parent\"))));\n    BitDocIdSetFilter childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new PrefixQuery(new Term(\"field2\"))));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        childFilter,\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery((new Term(\"filter_1\", \"T\")))));\n    query = new ToParentBlockJoinQuery(\n        childFilter,\n        new BitDocIdSetCachingWrapperFilter(parentFilter),\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"a67f37df79147ed4dd608300c2336c2979db98be","date":1436271524,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    // This doc will not be included, because it doesn't have nested docs\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"h\", Field.Store.NO));\n    w.addDocument(document);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    // Some garbage docs, just to check if the NestedFieldComparator can deal with this.\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n    document = new Document();\n    document.add(new StringField(\"fieldXXX\", \"x\", Field.Store.NO));\n    w.addDocument(document);\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(28, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(28, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2a1862266772deb28cdcb7d996b64d2177022687","date":1453077824,"type":3,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w, false));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"6652c74b2358a0b13223817a6a793bf1c9d0749d","date":1474465301,"type":3,"author":"Mike McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"17e5da53e4e5bd659e22add9bba1cfa222e7e30d","date":1475435902,"type":3,"author":"Karl Wright","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4cce5816ef15a48a0bc11e5d400497ee4301dd3b","date":1476991456,"type":3,"author":"Kevin Risden","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n        .setMergePolicy(NoMergePolicy.INSTANCE));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f","date":1493463311,"type":3,"author":"Mikhail Khludnev","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    ));\n\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    ));\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n    \n    // Sort by field descending, order last, sort filter (filter_1:T)\n    BitSetProducer childFilter1T = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n \n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter1T\n    ));\n    \n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, \n              new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"another\")))\n        , childFilter1T\n    ));\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"e9017cf144952056066919f1ebc7897ff9bd71b1","date":1496757600,"type":3,"author":"Shalin Shekhar Mangar","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    ));\n\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    ));\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n    \n    // Sort by field descending, order last, sort filter (filter_1:T)\n    BitSetProducer childFilter1T = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n \n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter1T\n    ));\n    \n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, \n              new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"another\")))\n        , childFilter1T\n    ));\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last, sort filter (filter_1:T)\n    childFilter = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n    sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    );\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"83788ad129a5154d5c6562c4e8ce3db48793aada","date":1532961485,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestBlockJoinSorting#testNestedSorting().mjava","sourceNew":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits.value);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    ));\n\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits.value);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    ));\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits.value, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n    \n    // Sort by field descending, order last, sort filter (filter_1:T)\n    BitSetProducer childFilter1T = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n \n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter1T\n    ));\n    \n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits.value);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, \n              new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"another\")))\n        , childFilter1T\n    ));\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  @Test\n  public void testNestedSorting() throws Exception {\n    final Directory dir = newDirectory();\n    final RandomIndexWriter w = new RandomIndexWriter(random(), dir, newIndexWriterConfig(new MockAnalyzer(random()))\n                                                      .setMergePolicy(newLogMergePolicy()));\n\n    List<Document> docs = new ArrayList<>();\n    Document document = new Document();\n    document.add(new StringField(\"field2\", \"a\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"a\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"b\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"b\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"a\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"c\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"c\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"d\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"d\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"b\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"e\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"e\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"f\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"f\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"c\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"g\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"g\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"h\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"h\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"d\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"i\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"i\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"j\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"j\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"f\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"k\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"k\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"l\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"l\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"g\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n\n    docs.clear();\n    document = new Document();\n    document.add(new StringField(\"field2\", \"m\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"m\")));\n    document.add(new StringField(\"filter_1\", \"T\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"n\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"n\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"field2\", \"o\", Field.Store.NO));\n    document.add(new SortedDocValuesField(\"field2\", new BytesRef(\"o\")));\n    document.add(new StringField(\"filter_1\", \"F\", Field.Store.NO));\n    docs.add(document);\n    document = new Document();\n    document.add(new StringField(\"__type\", \"parent\", Field.Store.NO));\n    document.add(new StringField(\"field1\", \"i\", Field.Store.NO));\n    docs.add(document);\n    w.addDocuments(docs);\n    w.commit();\n\n    IndexSearcher searcher = new IndexSearcher(DirectoryReader.open(w.w));\n    w.close();\n    BitSetProducer parentFilter = new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"parent\")));\n    CheckJoinIndex.check(searcher.getIndexReader(), parentFilter);\n    BitSetProducer childFilter = new QueryBitSetProducer(new PrefixQuery(new Term(\"field2\")));\n    ToParentBlockJoinQuery query = new ToParentBlockJoinQuery(\n        new PrefixQuery(new Term(\"field2\")),\n        parentFilter,\n        ScoreMode.None\n    );\n\n    // Sort by field ascending, order first\n    ToParentBlockJoinSortField sortField = new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, parentFilter, childFilter\n    );\n    Sort sort = new Sort(sortField);\n    TopFieldDocs topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"a\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field ascending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, false, true, parentFilter, childFilter\n    ));\n\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(7, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(3, topDocs.scoreDocs[0].doc);\n    assertEquals(\"c\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[1].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[4].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    // Sort by field descending, order last\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter\n    ));\n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(topDocs.totalHits, 7);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(27, topDocs.scoreDocs[0].doc);\n    assertEquals(\"o\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(23, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(19, topDocs.scoreDocs[2].doc);\n    assertEquals(\"k\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"i\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[4].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n    \n    // Sort by field descending, order last, sort filter (filter_1:T)\n    BitSetProducer childFilter1T = new QueryBitSetProducer(new TermQuery((new Term(\"filter_1\", \"T\"))));\n    query = new ToParentBlockJoinQuery(\n        new TermQuery((new Term(\"filter_1\", \"T\"))),\n        parentFilter,\n        ScoreMode.None\n    );\n \n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, parentFilter, childFilter1T\n    ));\n    \n    sort = new Sort(sortField);\n    topDocs = searcher.search(query, 5, sort);\n    assertEquals(6, topDocs.totalHits);\n    assertEquals(5, topDocs.scoreDocs.length);\n    assertEquals(23, topDocs.scoreDocs[0].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[0]).fields[0]).utf8ToString());\n    assertEquals(27, topDocs.scoreDocs[1].doc);\n    assertEquals(\"m\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[1]).fields[0]).utf8ToString());\n    assertEquals(11, topDocs.scoreDocs[2].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[2]).fields[0]).utf8ToString());\n    assertEquals(15, topDocs.scoreDocs[3].doc);\n    assertEquals(\"g\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[3]).fields[0]).utf8ToString());\n    assertEquals(7, topDocs.scoreDocs[4].doc);\n    assertEquals(\"e\", ((BytesRef) ((FieldDoc) topDocs.scoreDocs[4]).fields[0]).utf8ToString());\n\n    sortField = notEqual(sortField, () -> new ToParentBlockJoinSortField(\n        \"field2\", SortField.Type.STRING, true, \n              new QueryBitSetProducer(new TermQuery(new Term(\"__type\", \"another\")))\n        , childFilter1T\n    ));\n\n    searcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"7e2fb55c0777755badd3b46d8140f3d4301febed":["ae14298f4eec6d5faee6a149f88ba57d14a6f21a"],"b012914a8110b2ff1d075ed1ef72aa57084d4897":["d0ef034a4f10871667ae75181537775ddcf8ade4"],"54a6bea0b991120a99ad0e2f72ae853fd5ecae0e":["93dd449115a9247533e44bab47e8429e5dccbc6d"],"a67f37df79147ed4dd608300c2336c2979db98be":["4b3915945926c0bf7def01b0c504977709d3aed3"],"b70a13d2b73512ad6b204e9ad8fe09ffeeda3c2c":["7e2fb55c0777755badd3b46d8140f3d4301febed"],"56572ec06f1407c066d6b7399413178b33176cd8":["7e2fb55c0777755badd3b46d8140f3d4301febed","93dd449115a9247533e44bab47e8429e5dccbc6d"],"4b3915945926c0bf7def01b0c504977709d3aed3":["1db68e96dd908fcd79ef809095822736aa601d08"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":["2a1862266772deb28cdcb7d996b64d2177022687","17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"f53c6f42e7b48d8350238aaa12672718d128c3e8":["e27b99259bc542853bfc42f809014f56aad988fb"],"e9017cf144952056066919f1ebc7897ff9bd71b1":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d","02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f"],"1db68e96dd908fcd79ef809095822736aa601d08":["b012914a8110b2ff1d075ed1ef72aa57084d4897"],"2a1862266772deb28cdcb7d996b64d2177022687":["a67f37df79147ed4dd608300c2336c2979db98be"],"93dd449115a9247533e44bab47e8429e5dccbc6d":["7e2fb55c0777755badd3b46d8140f3d4301febed","b70a13d2b73512ad6b204e9ad8fe09ffeeda3c2c"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"17e5da53e4e5bd659e22add9bba1cfa222e7e30d":["2a1862266772deb28cdcb7d996b64d2177022687","6652c74b2358a0b13223817a6a793bf1c9d0749d"],"6652c74b2358a0b13223817a6a793bf1c9d0749d":["2a1862266772deb28cdcb7d996b64d2177022687"],"d0ef034a4f10871667ae75181537775ddcf8ade4":["54a6bea0b991120a99ad0e2f72ae853fd5ecae0e"],"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161":["f53c6f42e7b48d8350238aaa12672718d128c3e8"],"ae14298f4eec6d5faee6a149f88ba57d14a6f21a":["49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161"],"83788ad129a5154d5c6562c4e8ce3db48793aada":["02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f"],"02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"e27b99259bc542853bfc42f809014f56aad988fb":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["83788ad129a5154d5c6562c4e8ce3db48793aada"]},"commit2Childs":{"7e2fb55c0777755badd3b46d8140f3d4301febed":["b70a13d2b73512ad6b204e9ad8fe09ffeeda3c2c","56572ec06f1407c066d6b7399413178b33176cd8","93dd449115a9247533e44bab47e8429e5dccbc6d"],"b012914a8110b2ff1d075ed1ef72aa57084d4897":["1db68e96dd908fcd79ef809095822736aa601d08"],"54a6bea0b991120a99ad0e2f72ae853fd5ecae0e":["d0ef034a4f10871667ae75181537775ddcf8ade4"],"a67f37df79147ed4dd608300c2336c2979db98be":["2a1862266772deb28cdcb7d996b64d2177022687"],"b70a13d2b73512ad6b204e9ad8fe09ffeeda3c2c":["93dd449115a9247533e44bab47e8429e5dccbc6d"],"56572ec06f1407c066d6b7399413178b33176cd8":[],"4b3915945926c0bf7def01b0c504977709d3aed3":["a67f37df79147ed4dd608300c2336c2979db98be"],"4cce5816ef15a48a0bc11e5d400497ee4301dd3b":[],"f53c6f42e7b48d8350238aaa12672718d128c3e8":["49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161"],"e9017cf144952056066919f1ebc7897ff9bd71b1":[],"1db68e96dd908fcd79ef809095822736aa601d08":["4b3915945926c0bf7def01b0c504977709d3aed3"],"2a1862266772deb28cdcb7d996b64d2177022687":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","17e5da53e4e5bd659e22add9bba1cfa222e7e30d","6652c74b2358a0b13223817a6a793bf1c9d0749d"],"93dd449115a9247533e44bab47e8429e5dccbc6d":["54a6bea0b991120a99ad0e2f72ae853fd5ecae0e","56572ec06f1407c066d6b7399413178b33176cd8"],"17e5da53e4e5bd659e22add9bba1cfa222e7e30d":["4cce5816ef15a48a0bc11e5d400497ee4301dd3b","e9017cf144952056066919f1ebc7897ff9bd71b1","02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["e27b99259bc542853bfc42f809014f56aad988fb"],"6652c74b2358a0b13223817a6a793bf1c9d0749d":["17e5da53e4e5bd659e22add9bba1cfa222e7e30d"],"d0ef034a4f10871667ae75181537775ddcf8ade4":["b012914a8110b2ff1d075ed1ef72aa57084d4897"],"49a8cbd66bc94e18d7b9087e42dbc6cc0ee0c161":["ae14298f4eec6d5faee6a149f88ba57d14a6f21a"],"ae14298f4eec6d5faee6a149f88ba57d14a6f21a":["7e2fb55c0777755badd3b46d8140f3d4301febed"],"83788ad129a5154d5c6562c4e8ce3db48793aada":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"02ea2fa46568487e04cba3f11bf8bfc7e2c08a1f":["e9017cf144952056066919f1ebc7897ff9bd71b1","83788ad129a5154d5c6562c4e8ce3db48793aada"],"e27b99259bc542853bfc42f809014f56aad988fb":["f53c6f42e7b48d8350238aaa12672718d128c3e8"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["56572ec06f1407c066d6b7399413178b33176cd8","4cce5816ef15a48a0bc11e5d400497ee4301dd3b","e9017cf144952056066919f1ebc7897ff9bd71b1","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}