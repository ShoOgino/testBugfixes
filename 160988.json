{"path":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","commits":[{"id":"b89678825b68eccaf09e6ab71675fc0b0af1e099","date":1334669779,"type":1,"author":"Robert Muir","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"modules/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    readers[0].taxReader.refresh();\n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    // Hold on to the 'original' reader so we can do some checks with it\n    IndexReader origReader = null;\n\n    assertTrue(\"Reader must be updated!\", readers[0].indexReader != r2);\n    \n    // Set the 'original' reader\n    origReader = readers[0].indexReader;\n    // Set the new master index Reader\n    readers[0].indexReader = r2;\n\n    // Try to get total-counts the originalReader AGAIN, just for sanity. Should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 6th attempt\",totalCounts == \n      TFC.getTotalCounts(origReader, readers[0].taxReader, iParams, null));\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    origReader.close();\n    readers[0].close();\n    r2.close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    readers[0].taxReader.refresh();\n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    // Hold on to the 'original' reader so we can do some checks with it\n    IndexReader origReader = null;\n\n    assertTrue(\"Reader must be updated!\", readers[0].indexReader != r2);\n    \n    // Set the 'original' reader\n    origReader = readers[0].indexReader;\n    // Set the new master index Reader\n    readers[0].indexReader = r2;\n\n    // Try to get total-counts the originalReader AGAIN, just for sanity. Should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 6th attempt\",totalCounts == \n      TFC.getTotalCounts(origReader, readers[0].taxReader, iParams, null));\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    origReader.close();\n    readers[0].close();\n    r2.close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"219dcddcdf2fc13f6271d9e5836bd19c53a4abf1","date":1353511594,"type":3,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    readers[0].taxReader.refresh();\n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    // Hold on to the 'original' reader so we can do some checks with it\n    IndexReader origReader = null;\n\n    assertTrue(\"Reader must be updated!\", readers[0].indexReader != r2);\n    \n    // Set the 'original' reader\n    origReader = readers[0].indexReader;\n    // Set the new master index Reader\n    readers[0].indexReader = r2;\n\n    // Try to get total-counts the originalReader AGAIN, just for sanity. Should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 6th attempt\",totalCounts == \n      TFC.getTotalCounts(origReader, readers[0].taxReader, iParams, null));\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    origReader.close();\n    readers[0].close();\n    r2.close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"407687e67faf6e1f02a211ca078d8e3eed631027","date":1355157407,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    readers[0].taxReader.refresh();\n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    // Hold on to the 'original' reader so we can do some checks with it\n    IndexReader origReader = null;\n\n    assertTrue(\"Reader must be updated!\", readers[0].indexReader != r2);\n    \n    // Set the 'original' reader\n    origReader = readers[0].indexReader;\n    // Set the new master index Reader\n    readers[0].indexReader = r2;\n\n    // Try to get total-counts the originalReader AGAIN, just for sanity. Should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 6th attempt\",totalCounts == \n      TFC.getTotalCounts(origReader, readers[0].taxReader, iParams, null));\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    origReader.close();\n    readers[0].close();\n    r2.close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d4c6c7f3cda7a0595cabd16e5e9107ca29852708","date":1355402234,"type":3,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d3fcb70cf561547c7bb1506e0cf32ca7b1287064","date":1357616416,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"6c2cd18c7da6f499a33f06fc89c07a463ec074c0","date":1358329431,"type":3,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"c4015cd39dff8d4dec562d909f9766debac53aa6","date":1358548736,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc","date":1359570667,"type":3,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory indexDir = newDirectory();\n    Directory taxoDir = newDirectory();\n\n    // Create our index/taxonomy writers\n    IndexWriter indexWriter = new IndexWriter(indexDir, newIndexWriterConfig(TEST_VERSION_CURRENT, null));\n    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, indexWriter, taxoWriter, \"a\", \"b\");\n\n    // Commit Changes\n    indexWriter.commit();\n    taxoWriter.commit();\n\n    // Open readers\n    DirectoryReader indexReader = DirectoryReader.open(indexDir);\n    TaxonomyReader taxoReader = new DirectoryTaxonomyReader(taxoDir);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, indexWriter, taxoWriter, \"c\", \"d\");\n    IOUtils.close(indexWriter, taxoWriter);\n\n    TaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(taxoReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > taxoReader.getSize());\n    taxoReader.close();\n    taxoReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(indexReader);\n    assertNotNull(r2);\n    indexReader.close();\n    indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n    \n    IOUtils.close(indexReader, taxoReader);\n    outputFile.delete();\n    IOUtils.close(indexDir, taxoDir);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"61d5f95d14e5b9b046998c51e16709a398c15226","date":1359603451,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory indexDir = newDirectory();\n    Directory taxoDir = newDirectory();\n\n    // Create our index/taxonomy writers\n    IndexWriter indexWriter = new IndexWriter(indexDir, newIndexWriterConfig(TEST_VERSION_CURRENT, null));\n    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, indexWriter, taxoWriter, \"a\", \"b\");\n\n    // Commit Changes\n    indexWriter.commit();\n    taxoWriter.commit();\n\n    // Open readers\n    DirectoryReader indexReader = DirectoryReader.open(indexDir);\n    TaxonomyReader taxoReader = new DirectoryTaxonomyReader(taxoDir);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, indexWriter, taxoWriter, \"c\", \"d\");\n    IOUtils.close(indexWriter, taxoWriter);\n\n    TaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(taxoReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > taxoReader.getSize());\n    taxoReader.close();\n    taxoReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(indexReader);\n    assertNotNull(r2);\n    indexReader.close();\n    indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n    \n    IOUtils.close(indexReader, taxoReader);\n    outputFile.delete();\n    IOUtils.close(indexDir, taxoDir);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);\n\n    // Create our index/taxonomy writers\n    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"a\", \"b\");\n\n    // Commit Changes\n    writers[0].indexWriter.commit();\n    writers[0].taxWriter.commit();\n\n    // Open readers\n    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, \"c\", \"d\");\n    writers[0].indexWriter.close();\n    writers[0].taxWriter.close();\n\n    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > readers[0].taxReader.getSize());\n    readers[0].taxReader.close();\n    readers[0].taxReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);\n    assertNotNull(r2);\n    readers[0].indexReader.close();\n    readers[0].indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams));\n    \n    readers[0].close();\n    outputFile.delete();\n    IOUtils.close(dirs[0]);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"607428da722dcb3e86bbd11c63de8986e6275c36","date":1360334150,"type":5,"author":"Shai Erera","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/complements/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestTotalFacetCountsCache#testGenerationalConsistency().mjava","sourceNew":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory indexDir = newDirectory();\n    Directory taxoDir = newDirectory();\n\n    // Create our index/taxonomy writers\n    IndexWriter indexWriter = new IndexWriter(indexDir, newIndexWriterConfig(TEST_VERSION_CURRENT, null));\n    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, indexWriter, taxoWriter, \"a\", \"b\");\n\n    // Commit Changes\n    indexWriter.commit();\n    taxoWriter.commit();\n\n    // Open readers\n    DirectoryReader indexReader = DirectoryReader.open(indexDir);\n    TaxonomyReader taxoReader = new DirectoryTaxonomyReader(taxoDir);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, indexWriter, taxoWriter, \"c\", \"d\");\n    IOUtils.close(indexWriter, taxoWriter);\n\n    TaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(taxoReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > taxoReader.getSize());\n    taxoReader.close();\n    taxoReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(indexReader);\n    assertNotNull(r2);\n    indexReader.close();\n    indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n    \n    IOUtils.close(indexReader, taxoReader);\n    outputFile.delete();\n    IOUtils.close(indexDir, taxoDir);\n  }\n\n","sourceOld":"  /**\n   * Simple test to make sure the TotalFacetCountsManager updates the\n   * TotalFacetCounts array only when it is supposed to, and whether it\n   * is recomputed or read from disk.\n   */\n  @Test\n  public void testGenerationalConsistency() throws Exception {\n    // Create temporary RAMDirectories\n    Directory indexDir = newDirectory();\n    Directory taxoDir = newDirectory();\n\n    // Create our index/taxonomy writers\n    IndexWriter indexWriter = new IndexWriter(indexDir, newIndexWriterConfig(TEST_VERSION_CURRENT, null));\n    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);\n    FacetIndexingParams iParams = FacetIndexingParams.ALL_PARENTS;\n\n    // Add a facet to the index\n    addFacets(iParams, indexWriter, taxoWriter, \"a\", \"b\");\n\n    // Commit Changes\n    indexWriter.commit();\n    taxoWriter.commit();\n\n    // Open readers\n    DirectoryReader indexReader = DirectoryReader.open(indexDir);\n    TaxonomyReader taxoReader = new DirectoryTaxonomyReader(taxoDir);\n\n    // As this is the first time we have invoked the TotalFacetCountsManager, \n    // we should expect to compute and not read from disk.\n    TotalFacetCounts totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    int prevGen = assertRecomputed(totalCounts, 0, \"after first attempt to get it!\");\n\n    // Repeating same operation should pull from the cache - not recomputed. \n    assertTrue(\"Should be obtained from cache at 2nd attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n\n    // Repeat the same operation as above. but clear first - now should recompute again\n    initCache();\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 3rd attempt to get it!\");\n    \n    //store to file\n    File outputFile = _TestUtil.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n    initCache();\n    TFC.store(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after cache clear, 4th attempt to get it!\");\n\n    //clear and load\n    initCache();\n    TFC.load(outputFile, indexReader, taxoReader, iParams);\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertReadFromDisc(totalCounts, prevGen, \"after 5th attempt to get it!\");\n\n    // Add a new facet to the index, commit and refresh readers\n    addFacets(iParams, indexWriter, taxoWriter, \"c\", \"d\");\n    IOUtils.close(indexWriter, taxoWriter);\n\n    TaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(taxoReader);\n    assertNotNull(newTaxoReader);\n    assertTrue(\"should have received more cagtegories in updated taxonomy\", newTaxoReader.getSize() > taxoReader.getSize());\n    taxoReader.close();\n    taxoReader = newTaxoReader;\n    \n    DirectoryReader r2 = DirectoryReader.openIfChanged(indexReader);\n    assertNotNull(r2);\n    indexReader.close();\n    indexReader = r2;\n\n    // now use the new reader - should recompute\n    totalCounts = TFC.getTotalCounts(indexReader, taxoReader, iParams);\n    prevGen = assertRecomputed(totalCounts, prevGen, \"after updating the index - 7th attempt!\");\n\n    // try again - should not recompute\n    assertTrue(\"Should be obtained from cache at 8th attempt\",totalCounts == \n      TFC.getTotalCounts(indexReader, taxoReader, iParams));\n    \n    IOUtils.close(indexReader, taxoReader);\n    outputFile.delete();\n    IOUtils.close(indexDir, taxoDir);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"d3fcb70cf561547c7bb1506e0cf32ca7b1287064":["407687e67faf6e1f02a211ca078d8e3eed631027","d4c6c7f3cda7a0595cabd16e5e9107ca29852708"],"607428da722dcb3e86bbd11c63de8986e6275c36":["1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc"],"b89678825b68eccaf09e6ab71675fc0b0af1e099":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"61d5f95d14e5b9b046998c51e16709a398c15226":["c4015cd39dff8d4dec562d909f9766debac53aa6","1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc"],"c4015cd39dff8d4dec562d909f9766debac53aa6":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064","6c2cd18c7da6f499a33f06fc89c07a463ec074c0"],"d4c6c7f3cda7a0595cabd16e5e9107ca29852708":["219dcddcdf2fc13f6271d9e5836bd19c53a4abf1"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"407687e67faf6e1f02a211ca078d8e3eed631027":["b89678825b68eccaf09e6ab71675fc0b0af1e099","219dcddcdf2fc13f6271d9e5836bd19c53a4abf1"],"1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc":["6c2cd18c7da6f499a33f06fc89c07a463ec074c0"],"219dcddcdf2fc13f6271d9e5836bd19c53a4abf1":["b89678825b68eccaf09e6ab71675fc0b0af1e099"],"6c2cd18c7da6f499a33f06fc89c07a463ec074c0":["d4c6c7f3cda7a0595cabd16e5e9107ca29852708"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["607428da722dcb3e86bbd11c63de8986e6275c36"]},"commit2Childs":{"d3fcb70cf561547c7bb1506e0cf32ca7b1287064":["c4015cd39dff8d4dec562d909f9766debac53aa6"],"607428da722dcb3e86bbd11c63de8986e6275c36":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"b89678825b68eccaf09e6ab71675fc0b0af1e099":["407687e67faf6e1f02a211ca078d8e3eed631027","219dcddcdf2fc13f6271d9e5836bd19c53a4abf1"],"61d5f95d14e5b9b046998c51e16709a398c15226":[],"c4015cd39dff8d4dec562d909f9766debac53aa6":["61d5f95d14e5b9b046998c51e16709a398c15226"],"d4c6c7f3cda7a0595cabd16e5e9107ca29852708":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064","6c2cd18c7da6f499a33f06fc89c07a463ec074c0"],"407687e67faf6e1f02a211ca078d8e3eed631027":["d3fcb70cf561547c7bb1506e0cf32ca7b1287064"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["b89678825b68eccaf09e6ab71675fc0b0af1e099"],"1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc":["607428da722dcb3e86bbd11c63de8986e6275c36","61d5f95d14e5b9b046998c51e16709a398c15226"],"219dcddcdf2fc13f6271d9e5836bd19c53a4abf1":["d4c6c7f3cda7a0595cabd16e5e9107ca29852708","407687e67faf6e1f02a211ca078d8e3eed631027"],"6c2cd18c7da6f499a33f06fc89c07a463ec074c0":["c4015cd39dff8d4dec562d909f9766debac53aa6","1289047c4a6e31121c9d3a8f4c7a3fb30179f0fc"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["61d5f95d14e5b9b046998c51e16709a398c15226","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}