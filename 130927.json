{"path":"lucene/core/src/java/org/apache/lucene/util/packed/DirectMonotonicWriter#flush().mjava","commits":[{"id":"a870f9917149dc600c4ad4417d615c1795de5864","date":1445975387,"type":0,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/core/src/java/org/apache/lucene/util/packed/DirectMonotonicWriter#flush().mjava","pathOld":"/dev/null","sourceNew":"  private void flush() throws IOException {\n    assert bufferSize != 0;\n\n    final float avgInc = (float) ((double) (buffer[bufferSize-1] - buffer[0]) / Math.max(1, bufferSize - 1));\n    for (int i = 0; i < bufferSize; ++i) {\n      final long expected = (long) (avgInc * (long) i);\n      buffer[i] -= expected;\n    }\n\n    long min = buffer[0];\n    for (int i = 1; i < bufferSize; ++i) {\n      min = Math.min(buffer[i], min);\n    }\n\n    long maxDelta = 0;\n    for (int i = 0; i < bufferSize; ++i) {\n      buffer[i] -= min;\n      // use | will change nothing when it comes to computing required bits\n      // but has the benefit of working fine with negative values too\n      // (in case of overflow)\n      maxDelta |= buffer[i];\n    }\n\n    meta.writeLong(min);\n    meta.writeInt(Float.floatToIntBits(avgInc));\n    meta.writeLong(data.getFilePointer() - baseDataPointer);\n    if (maxDelta == 0) {\n      meta.writeByte((byte) 0);\n    } else {\n      final int bitsRequired = DirectWriter.unsignedBitsRequired(maxDelta);\n      DirectWriter writer = DirectWriter.getInstance(data, bufferSize, bitsRequired);\n      for (int i = 0; i < bufferSize; ++i) {\n        writer.add(buffer[i]);\n      }\n      writer.finish();\n      meta.writeByte((byte) bitsRequired);\n    }\n    bufferSize = 0;\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"a870f9917149dc600c4ad4417d615c1795de5864":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["a870f9917149dc600c4ad4417d615c1795de5864"]},"commit2Childs":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["a870f9917149dc600c4ad4417d615c1795de5864"],"a870f9917149dc600c4ad4417d615c1795de5864":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}