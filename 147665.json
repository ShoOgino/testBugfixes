{"path":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","commits":[{"id":"2f472c757c161e228505e389efda705e2cf3c09e","date":1501700089,"type":0,"author":"Anshum Gupta","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"/dev/null","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws IOException, SolrServerException, InterruptedException, KeeperException {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(cluster.getSolrClient());\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n\n      JettySolrRunner jetty = cluster.getJettySolrRunner(0);\n      cluster.expireZkSession(jetty);\n      Set<String> live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n\n      int counter = 0;\n      while (live_nodes.size() == 1 && counter++ < 100) {\n        Thread.sleep(100);\n        live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n      }\n\n      try {\n        req.process(httpSolrClient);\n      } catch (HttpSolrClient.RemoteSolrException e) {\n        assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n        assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":["3126baf79b1adfd0260e762eca2b1314eba05da8"],"isBuggy":true,"nexts":[],"revCommit":null},{"id":"7a23cf16c8fa265dc0a564adcabb55e3f054e0ac","date":1502192746,"type":0,"author":"Shalin Shekhar Mangar","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"/dev/null","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws IOException, SolrServerException, InterruptedException, KeeperException {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(cluster.getSolrClient());\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n\n      JettySolrRunner jetty = cluster.getJettySolrRunner(0);\n      cluster.expireZkSession(jetty);\n      Set<String> live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n\n      int counter = 0;\n      while (live_nodes.size() == 1 && counter++ < 100) {\n        Thread.sleep(100);\n        live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n      }\n\n      try {\n        req.process(httpSolrClient);\n      } catch (HttpSolrClient.RemoteSolrException e) {\n        assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n        assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"3126baf79b1adfd0260e762eca2b1314eba05da8","date":1507761032,"type":3,"author":"Chris Hostetter","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n                 req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n    \n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n    \n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n                  \n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n      \n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      HttpSolrClient.RemoteSolrException e = expectThrows(HttpSolrClient.RemoteSolrException.class, () ->\n                                                          {\n                                                            req.process(httpSolrClient);\n                                                          });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n    \n  }\n\n","sourceOld":"  @Test\n  public void testHealthCheckHandler() throws IOException, SolrServerException, InterruptedException, KeeperException {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(cluster.getSolrClient());\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n\n      JettySolrRunner jetty = cluster.getJettySolrRunner(0);\n      cluster.expireZkSession(jetty);\n      Set<String> live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n\n      int counter = 0;\n      while (live_nodes.size() == 1 && counter++ < 100) {\n        Thread.sleep(100);\n        live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n      }\n\n      try {\n        req.process(httpSolrClient);\n      } catch (HttpSolrClient.RemoteSolrException e) {\n        assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n        assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n      }\n    }\n  }\n\n","bugFix":["2f472c757c161e228505e389efda705e2cf3c09e"],"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"e1ff601a12d12d08405c7e451d64604d94292953","date":1507795721,"type":3,"author":"Cao Manh Dat","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n                 req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n    \n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n    \n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n                  \n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n      \n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      HttpSolrClient.RemoteSolrException e = expectThrows(HttpSolrClient.RemoteSolrException.class, () ->\n                                                          {\n                                                            req.process(httpSolrClient);\n                                                          });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n    \n  }\n\n","sourceOld":"  @Test\n  public void testHealthCheckHandler() throws IOException, SolrServerException, InterruptedException, KeeperException {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(cluster.getSolrClient());\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n\n      JettySolrRunner jetty = cluster.getJettySolrRunner(0);\n      cluster.expireZkSession(jetty);\n      Set<String> live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n\n      int counter = 0;\n      while (live_nodes.size() == 1 && counter++ < 100) {\n        Thread.sleep(100);\n        live_nodes = cluster.getSolrClient().getZkStateReader().getClusterState().getLiveNodes();\n      }\n\n      try {\n        req.process(httpSolrClient);\n      } catch (HttpSolrClient.RemoteSolrException e) {\n        assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n        assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n      }\n    }\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4bb866c04f137107dcf5b8f0e5bcee02fc832050","date":1546758709,"type":3,"author":"Shalin Shekhar Mangar","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n        req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n\n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // successfully create a dummy collection\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      CollectionAdminResponse collectionAdminResponse = CollectionAdminRequest.createCollection(\"test\", \"_default\", 1, 1)\n          .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n          .process(httpSolrClient);\n      assertEquals(0, collectionAdminResponse.getStatus());\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    } finally {\n      cluster.deleteAllCollections();\n      cluster.deleteAllConfigSets();\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n\n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      HttpSolrClient.RemoteSolrException e = expectThrows(HttpSolrClient.RemoteSolrException.class, () ->\n      {\n        req.process(httpSolrClient);\n      });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // add a new node for the purpose of negative testing\n    // negative check that if core container is not available at the node\n    newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // shutdown the core container of new node\n      newJetty.getCoreContainer().shutdown();\n\n      // api shouldn't unreachable\n      SolrException thrown = expectThrows(SolrException.class, () -> {\n        req.process(httpSolrClient).getResponse().get(CommonParams.STATUS);\n        fail(\"API shouldn't be available, and fail at above request\");\n      });\n      assertEquals(\"Exception code should be 404\", 404, thrown.code());\n      assertTrue(\"Should have seen an exception containing the an error\", thrown.getMessage().contains(\n          \"Error processing the request. CoreContainer is either not initialized or shutting down.\"));\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node and failed core container\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n\n  }\n\n","sourceOld":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n                 req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n    \n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n    \n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n                  \n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n      \n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      HttpSolrClient.RemoteSolrException e = expectThrows(HttpSolrClient.RemoteSolrException.class, () ->\n                                                          {\n                                                            req.process(httpSolrClient);\n                                                          });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n    \n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"db96734b79e26d948b59f68bd4564c4836a71acf","date":1585375566,"type":3,"author":"Munendra S N","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n        req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n\n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // successfully create a dummy collection\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      CollectionAdminResponse collectionAdminResponse = CollectionAdminRequest.createCollection(\"test\", \"_default\", 1, 1)\n          .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n          .process(httpSolrClient);\n      assertEquals(0, collectionAdminResponse.getStatus());\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    } finally {\n      cluster.deleteAllCollections();\n      cluster.deleteAllConfigSets();\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n\n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      BaseHttpSolrClient.RemoteSolrException e = expectThrows(BaseHttpSolrClient.RemoteSolrException.class, () ->\n      {\n        req.process(httpSolrClient);\n      });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // add a new node for the purpose of negative testing\n    // negative check that if core container is not available at the node\n    newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // shutdown the core container of new node\n      newJetty.getCoreContainer().shutdown();\n\n      // api shouldn't unreachable\n      SolrException thrown = expectThrows(SolrException.class, () -> {\n        req.process(httpSolrClient).getResponse().get(CommonParams.STATUS);\n        fail(\"API shouldn't be available, and fail at above request\");\n      });\n      assertEquals(\"Exception code should be 404\", 404, thrown.code());\n      assertTrue(\"Should have seen an exception containing the an error\", thrown.getMessage().contains(\n          \"Error processing the request. CoreContainer is either not initialized or shutting down.\"));\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node and failed core container\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n\n  }\n\n","sourceOld":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n        req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n\n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // successfully create a dummy collection\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      CollectionAdminResponse collectionAdminResponse = CollectionAdminRequest.createCollection(\"test\", \"_default\", 1, 1)\n          .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n          .process(httpSolrClient);\n      assertEquals(0, collectionAdminResponse.getStatus());\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    } finally {\n      cluster.deleteAllCollections();\n      cluster.deleteAllConfigSets();\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n\n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      HttpSolrClient.RemoteSolrException e = expectThrows(HttpSolrClient.RemoteSolrException.class, () ->\n      {\n        req.process(httpSolrClient);\n      });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // add a new node for the purpose of negative testing\n    // negative check that if core container is not available at the node\n    newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // shutdown the core container of new node\n      newJetty.getCoreContainer().shutdown();\n\n      // api shouldn't unreachable\n      SolrException thrown = expectThrows(SolrException.class, () -> {\n        req.process(httpSolrClient).getResponse().get(CommonParams.STATUS);\n        fail(\"API shouldn't be available, and fail at above request\");\n      });\n      assertEquals(\"Exception code should be 404\", 404, thrown.code());\n      assertTrue(\"Should have seen an exception containing the an error\", thrown.getMessage().contains(\n          \"Error processing the request. CoreContainer is either not initialized or shutting down.\"));\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node and failed core container\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"1949be020da305d0d64d348458ac933994b52e8d","date":1586255171,"type":5,"author":"Jan Høydahl","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/admin/HealthCheckHandlerTest#testHealthCheckHandler().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/HealthCheckHandlerTest#testHealthCheckHandler().mjava","sourceNew":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n        req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n\n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // successfully create a dummy collection\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      CollectionAdminResponse collectionAdminResponse = CollectionAdminRequest.createCollection(\"test\", \"_default\", 1, 1)\n          .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n          .process(httpSolrClient);\n      assertEquals(0, collectionAdminResponse.getStatus());\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    } finally {\n      cluster.deleteAllCollections();\n      cluster.deleteAllConfigSets();\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n\n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      BaseHttpSolrClient.RemoteSolrException e = expectThrows(BaseHttpSolrClient.RemoteSolrException.class, () ->\n      {\n        req.process(httpSolrClient);\n      });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // add a new node for the purpose of negative testing\n    // negative check that if core container is not available at the node\n    newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // shutdown the core container of new node\n      newJetty.getCoreContainer().shutdown();\n\n      // api shouldn't unreachable\n      SolrException thrown = expectThrows(SolrException.class, () -> {\n        req.process(httpSolrClient).getResponse().get(CommonParams.STATUS);\n        fail(\"API shouldn't be available, and fail at above request\");\n      });\n      assertEquals(\"Exception code should be 404\", 404, thrown.code());\n      assertTrue(\"Should have seen an exception containing the an error\", thrown.getMessage().contains(\n          \"Error processing the request. CoreContainer is either not initialized or shutting down.\"));\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node and failed core container\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n\n  }\n\n","sourceOld":"  @Test\n  public void testHealthCheckHandler() throws Exception {\n    SolrRequest req = new GenericSolrRequest(SolrRequest.METHOD.GET, HEALTH_CHECK_HANDLER_PATH, new ModifiableSolrParams());\n\n    // positive check that our only existing \"healthy\" node works with cloud client\n    // NOTE: this is using GenericSolrRequest, not HealthCheckRequest which is why it passes\n    // as compared with testHealthCheckHandlerWithCloudClient\n    // (Not sure if that's actaully a good thing -- but it's how the existing test worked)\n    assertEquals(CommonParams.OK,\n        req.process(cluster.getSolrClient()).getResponse().get(CommonParams.STATUS));\n\n    // positive check that our exiting \"healthy\" node works with direct http client\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    }\n\n    // successfully create a dummy collection\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n      CollectionAdminResponse collectionAdminResponse = CollectionAdminRequest.createCollection(\"test\", \"_default\", 1, 1)\n          .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n          .process(httpSolrClient);\n      assertEquals(0, collectionAdminResponse.getStatus());\n      SolrResponse response = req.process(httpSolrClient);\n      assertEquals(CommonParams.OK, response.getResponse().get(CommonParams.STATUS));\n    } finally {\n      cluster.deleteAllCollections();\n      cluster.deleteAllConfigSets();\n    }\n\n    // add a new node for the purpose of negative testing\n    JettySolrRunner newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // now \"break\" our (new) node\n      newJetty.getCoreContainer().getZkController().getZkClient().close();\n\n      // negative check of our (new) \"broken\" node that we deliberately put into an unhealth state\n      BaseHttpSolrClient.RemoteSolrException e = expectThrows(BaseHttpSolrClient.RemoteSolrException.class, () ->\n      {\n        req.process(httpSolrClient);\n      });\n      assertTrue(e.getMessage(), e.getMessage().contains(\"Host Unavailable\"));\n      assertEquals(SolrException.ErrorCode.SERVICE_UNAVAILABLE.code, e.code());\n    } finally {\n      newJetty.stop();\n    }\n\n    // add a new node for the purpose of negative testing\n    // negative check that if core container is not available at the node\n    newJetty = cluster.startJettySolrRunner();\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(newJetty.getBaseUrl().toString())) {\n\n      // postive check that our (new) \"healthy\" node works with direct http client\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n\n      // shutdown the core container of new node\n      newJetty.getCoreContainer().shutdown();\n\n      // api shouldn't unreachable\n      SolrException thrown = expectThrows(SolrException.class, () -> {\n        req.process(httpSolrClient).getResponse().get(CommonParams.STATUS);\n        fail(\"API shouldn't be available, and fail at above request\");\n      });\n      assertEquals(\"Exception code should be 404\", 404, thrown.code());\n      assertTrue(\"Should have seen an exception containing the an error\", thrown.getMessage().contains(\n          \"Error processing the request. CoreContainer is either not initialized or shutting down.\"));\n    } finally {\n      newJetty.stop();\n    }\n\n    // (redundent) positive check that our (previously) exiting \"healthy\" node (still) works\n    // after getting negative results from our broken node and failed core container\n    try (HttpSolrClient httpSolrClient = getHttpSolrClient(cluster.getJettySolrRunner(0).getBaseUrl().toString())) {\n\n      assertEquals(CommonParams.OK, req.process(httpSolrClient).getResponse().get(CommonParams.STATUS));\n    }\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"7a23cf16c8fa265dc0a564adcabb55e3f054e0ac":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85","2f472c757c161e228505e389efda705e2cf3c09e"],"4bb866c04f137107dcf5b8f0e5bcee02fc832050":["e1ff601a12d12d08405c7e451d64604d94292953"],"3126baf79b1adfd0260e762eca2b1314eba05da8":["2f472c757c161e228505e389efda705e2cf3c09e"],"1949be020da305d0d64d348458ac933994b52e8d":["db96734b79e26d948b59f68bd4564c4836a71acf"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"e1ff601a12d12d08405c7e451d64604d94292953":["2f472c757c161e228505e389efda705e2cf3c09e","3126baf79b1adfd0260e762eca2b1314eba05da8"],"db96734b79e26d948b59f68bd4564c4836a71acf":["4bb866c04f137107dcf5b8f0e5bcee02fc832050"],"2f472c757c161e228505e389efda705e2cf3c09e":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["1949be020da305d0d64d348458ac933994b52e8d"]},"commit2Childs":{"7a23cf16c8fa265dc0a564adcabb55e3f054e0ac":[],"4bb866c04f137107dcf5b8f0e5bcee02fc832050":["db96734b79e26d948b59f68bd4564c4836a71acf"],"3126baf79b1adfd0260e762eca2b1314eba05da8":["e1ff601a12d12d08405c7e451d64604d94292953"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["7a23cf16c8fa265dc0a564adcabb55e3f054e0ac","2f472c757c161e228505e389efda705e2cf3c09e"],"e1ff601a12d12d08405c7e451d64604d94292953":["4bb866c04f137107dcf5b8f0e5bcee02fc832050"],"1949be020da305d0d64d348458ac933994b52e8d":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"db96734b79e26d948b59f68bd4564c4836a71acf":["1949be020da305d0d64d348458ac933994b52e8d"],"2f472c757c161e228505e389efda705e2cf3c09e":["7a23cf16c8fa265dc0a564adcabb55e3f054e0ac","3126baf79b1adfd0260e762eca2b1314eba05da8","e1ff601a12d12d08405c7e451d64604d94292953"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["7a23cf16c8fa265dc0a564adcabb55e3f054e0ac","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}