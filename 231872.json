{"path":"lucene/core/src/test/org/apache/lucene/index/TestSoftDeletesDirectoryReaderWrapper#testDropFullyDeletedSegments().mjava","commits":[{"id":"64ae4f237e39a4a8c75efb13ccf6cf6622974659","date":1536144294,"type":0,"author":"Simon Willnauer","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/index/TestSoftDeletesDirectoryReaderWrapper#testDropFullyDeletedSegments().mjava","pathOld":"/dev/null","sourceNew":"  public void testDropFullyDeletedSegments() throws IOException {\n    IndexWriterConfig indexWriterConfig = newIndexWriterConfig();\n    String softDeletesField = \"soft_delete\";\n    indexWriterConfig.setSoftDeletesField(softDeletesField);\n    indexWriterConfig.setMergePolicy(new SoftDeletesRetentionMergePolicy(softDeletesField, MatchAllDocsQuery::new,\n        NoMergePolicy.INSTANCE));\n    try (Directory dir = newDirectory();\n         IndexWriter writer = new IndexWriter(dir, indexWriterConfig)) {\n\n      Document doc = new Document();\n      doc.add(new StringField(\"id\", \"1\", Field.Store.YES));\n      doc.add(new StringField(\"version\", \"1\", Field.Store.YES));\n      writer.addDocument(doc);\n      writer.commit();\n      doc = new Document();\n      doc.add(new StringField(\"id\", \"2\", Field.Store.YES));\n      doc.add(new StringField(\"version\", \"1\", Field.Store.YES));\n      writer.addDocument(doc);\n      writer.commit();\n\n      try (DirectoryReader reader = new SoftDeletesDirectoryReaderWrapper(DirectoryReader.open(dir), softDeletesField)) {\n        assertEquals(2, reader.leaves().size());\n        assertEquals(2, reader.numDocs());\n        assertEquals(2, reader.maxDoc());\n        assertEquals(0, reader.numDeletedDocs());\n      }\n      writer.updateDocValues(new Term(\"id\", \"1\"), new NumericDocValuesField(softDeletesField, 1));\n      writer.commit();\n      try (DirectoryReader reader = new SoftDeletesDirectoryReaderWrapper(DirectoryReader.open(writer), softDeletesField)) {\n        assertEquals(1, reader.numDocs());\n        assertEquals(1, reader.maxDoc());\n        assertEquals(0, reader.numDeletedDocs());\n        assertEquals(1, reader.leaves().size());\n      }\n      try (DirectoryReader reader = new SoftDeletesDirectoryReaderWrapper(DirectoryReader.open(dir), softDeletesField)) {\n        assertEquals(1, reader.numDocs());\n        assertEquals(1, reader.maxDoc());\n        assertEquals(0, reader.numDeletedDocs());\n        assertEquals(1, reader.leaves().size());\n      }\n\n      try (DirectoryReader reader = DirectoryReader.open(dir)) {\n        assertEquals(2, reader.numDocs());\n        assertEquals(2, reader.maxDoc());\n        assertEquals(0, reader.numDeletedDocs());\n        assertEquals(2, reader.leaves().size());\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"64ae4f237e39a4a8c75efb13ccf6cf6622974659":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["64ae4f237e39a4a8c75efb13ccf6cf6622974659"]},"commit2Childs":{"64ae4f237e39a4a8c75efb13ccf6cf6622974659":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["64ae4f237e39a4a8c75efb13ccf6cf6622974659"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}