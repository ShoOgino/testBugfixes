{"path":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","commits":[{"id":"c8c7f17e23a807049d8e2f0cb429977d5130befa","date":1524005824,"type":0,"author":"Houston Putman","isMerge":false,"pathNew":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","pathOld":"/dev/null","sourceNew":"  @Test\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection1\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection2\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":["bb222a3f9d9421d5c95afce73013fbd8de07ea1f"],"isBuggy":true,"nexts":[],"revCommit":null},{"id":"648627dd57e08f78d7b6e3b59b1f43530995a69a","date":1535068798,"type":3,"author":"Erick Erickson","isMerge":false,"pathNew":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","pathOld":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","sourceNew":"  @Test\n  @BadApple(bugUrl=\"https://issues.apache.org/jira/browse/SOLR-12028\") // added 23-Aug-2018\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection1\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection2\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","sourceOld":"  @Test\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection1\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection2\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":true,"nexts":[],"revCommit":null},{"id":"bb222a3f9d9421d5c95afce73013fbd8de07ea1f","date":1543514331,"type":3,"author":"markrmiller","isMerge":false,"pathNew":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","pathOld":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","sourceNew":"  @Test\n  @BadApple(bugUrl=\"https://issues.apache.org/jira/browse/SOLR-12028\") // added 23-Aug-2018\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection1\", 4, 4);\n    \n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection2\", 4, 4);\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","sourceOld":"  @Test\n  @BadApple(bugUrl=\"https://issues.apache.org/jira/browse/SOLR-12028\") // added 23-Aug-2018\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection1\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    client.waitForState(\"testcollection2\", MAX_WAIT_TIMEOUT, TimeUnit.SECONDS,\n        (n, c) -> DocCollection.isFullyActive(n, c, 4, 1));\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","bugFix":["c8c7f17e23a807049d8e2f0cb429977d5130befa"],"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"8d35c84fdef07284c122012ca4000d3b7285a66e","date":1545962630,"type":3,"author":"Erick Erickson","isMerge":false,"pathNew":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","pathOld":"solr/solrj/src/test/org/apache/solr/common/cloud/TestCloudCollectionsListeners#testCollectionDeletion().mjava","sourceNew":"  @Test\n  // commented out on: 24-Dec-2018   @BadApple(bugUrl=\"https://issues.apache.org/jira/browse/SOLR-12028\") // added 23-Aug-2018\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection1\", 4, 4);\n    \n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection2\", 4, 4);\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","sourceOld":"  @Test\n  @BadApple(bugUrl=\"https://issues.apache.org/jira/browse/SOLR-12028\") // added 23-Aug-2018\n  public void testCollectionDeletion() throws Exception {\n\n    CloudSolrClient client = cluster.getSolrClient();\n\n    CollectionAdminRequest.createCollection(\"testcollection1\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection1\", 4, 4);\n    \n    CollectionAdminRequest.createCollection(\"testcollection2\", \"config\", 4, 1)\n        .processAndWait(client, MAX_WAIT_TIMEOUT);\n    cluster.waitForActiveCollection(\"testcollection2\", 4, 4);\n\n    Map<Integer, Set<String>> oldResults = new HashMap<>();\n    Map<Integer, Set<String>> newResults = new HashMap<>();\n\n    CloudCollectionsListener watcher1 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(1, oldCollections);\n      newResults.put(1, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher1);\n    CloudCollectionsListener watcher2 = (oldCollections, newCollections) -> {\n      log.info(\"New set of collections: {}, {}\", oldCollections, newCollections);\n      oldResults.put(2, oldCollections);\n      newResults.put(2, newCollections);\n    };\n    client.getZkStateReader().registerCloudCollectionsListener(watcher2);\n\n\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener has old collection with size > 0 after registration\", 0, oldResults.get(2).size());\n\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(1).contains(\"testcollection2\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener not notified of all collections after registration\", newResults.get(2).contains(\"testcollection2\"));\n\n    CollectionAdminRequest.deleteCollection(\"testcollection1\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(1).size());\n    assertEquals(\"CloudCollectionsListener missing old collection after collection removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(1).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener notifies with collection that no longer exists\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener doesn't notify of collection that exists\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher2);\n\n    CollectionAdminRequest.deleteCollection(\"testcollection2\").processAndWait(client, MAX_WAIT_TIMEOUT);\n\n    assertEquals(\"CloudCollectionsListener has incorrect number of old collections\", 1, oldResults.get(1).size());\n    assertTrue(\"CloudCollectionsListener has incorrect old collection after collection removal\", oldResults.get(1).contains(\"testcollection2\"));\n    assertEquals(\"CloudCollectionsListener called after removal\", 2, oldResults.get(2).size());\n\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection1\"));\n    assertFalse(\"CloudCollectionsListener shows live collection after removal\", newResults.get(1).contains(\"testcollection2\"));\n    assertFalse(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection1\"));\n    assertTrue(\"CloudCollectionsListener called after removal\", newResults.get(2).contains(\"testcollection2\"));\n\n    client.getZkStateReader().removeCloudCollectionsListener(watcher1);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"648627dd57e08f78d7b6e3b59b1f43530995a69a":["c8c7f17e23a807049d8e2f0cb429977d5130befa"],"bb222a3f9d9421d5c95afce73013fbd8de07ea1f":["648627dd57e08f78d7b6e3b59b1f43530995a69a"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"c8c7f17e23a807049d8e2f0cb429977d5130befa":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["8d35c84fdef07284c122012ca4000d3b7285a66e"],"8d35c84fdef07284c122012ca4000d3b7285a66e":["bb222a3f9d9421d5c95afce73013fbd8de07ea1f"]},"commit2Childs":{"648627dd57e08f78d7b6e3b59b1f43530995a69a":["bb222a3f9d9421d5c95afce73013fbd8de07ea1f"],"bb222a3f9d9421d5c95afce73013fbd8de07ea1f":["8d35c84fdef07284c122012ca4000d3b7285a66e"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["c8c7f17e23a807049d8e2f0cb429977d5130befa"],"c8c7f17e23a807049d8e2f0cb429977d5130befa":["648627dd57e08f78d7b6e3b59b1f43530995a69a"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[],"8d35c84fdef07284c122012ca4000d3b7285a66e":["cd5edd1f2b162a5cfa08efd17851a07373a96817"]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}