{"path":"lucene/facet/src/test/org/apache/lucene/facet/search/TestDrillSideways#slowDrillSidewaysSearch(IndexSearcher,List[Doc],String,String[][],String[][],Filter).mjava","commits":[{"id":"5b1ac4be5e40d7bda6ec0f850c933a95ca0642fd","date":1361836936,"type":0,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestDrillSideways#slowDrillSidewaysSearch(IndexSearcher,List[Doc],String,String[][],String[][],Filter).mjava","pathOld":"/dev/null","sourceNew":"  private SimpleFacetResult slowDrillSidewaysSearch(IndexSearcher s, List<Doc> docs, String contentToken, String[][] drillDowns,\n                                                    String[][] dimValues, Filter onlyEven) throws Exception {\n    int numDims = dimValues.length;\n\n    List<Doc> hits = new ArrayList<Doc>();\n    Counters drillDownCounts = new Counters(dimValues);\n    Counters[] drillSidewaysCounts = new Counters[dimValues.length];\n    for(int dim=0;dim<numDims;dim++) {\n      drillSidewaysCounts[dim] = new Counters(dimValues);\n    }\n\n    if (VERBOSE) {\n      System.out.println(\"  compute expected\");\n    }\n\n    nextDoc: for(Doc doc : docs) {\n      if (doc.deleted) {\n        continue;\n      }\n      if (onlyEven != null & (Integer.parseInt(doc.id) & 1) != 0) {\n        continue;\n      }\n      if (contentToken == null || doc.contentToken.equals(contentToken)) {\n        int failDim = -1;\n        for(int dim=0;dim<numDims;dim++) {\n          if (drillDowns[dim] != null) {\n            String docValue = doc.dims[dim] == -1 ? null : dimValues[dim][doc.dims[dim]];\n            String docValue2 = doc.dims2[dim] == -1 ? null : dimValues[dim][doc.dims2[dim]];\n            boolean matches = false;\n            for(String value : drillDowns[dim]) {\n              if (value.equals(docValue) || value.equals(docValue2)) {\n                matches = true;\n                break;\n              }\n            }\n            if (!matches) {\n              if (failDim == -1) {\n                // Doc could be a near-miss, if no other dim fails\n                failDim = dim;\n              } else {\n                // Doc isn't a hit nor a near-miss\n                continue nextDoc;\n              }\n            }\n          }\n        }\n\n        if (failDim == -1) {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a hit\");\n          }\n          // Hit:\n          hits.add(doc);\n          drillDownCounts.inc(doc.dims, doc.dims2);\n          for(int dim=0;dim<dimValues.length;dim++) {\n            drillSidewaysCounts[dim].inc(doc.dims, doc.dims2);\n          }\n        } else {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a near-miss on dim=\" + failDim);\n          }\n          drillSidewaysCounts[failDim].inc(doc.dims, doc.dims2, failDim);\n        }\n      }\n    }\n\n    Map<String,Integer> idToDocID = new HashMap<String,Integer>();\n    for(int i=0;i<s.getIndexReader().maxDoc();i++) {\n      idToDocID.put(s.doc(i).get(\"id\"), i);\n    }\n\n    Collections.sort(hits);\n\n    SimpleFacetResult res = new SimpleFacetResult();\n    res.hits = hits;\n    res.counts = new int[numDims][];\n    for(int dim=0;dim<numDims;dim++) {\n      if (drillDowns[dim] != null) {\n        res.counts[dim] = drillSidewaysCounts[dim].counts[dim];\n      } else {\n        res.counts[dim] = drillDownCounts.counts[dim];\n      }\n    }\n\n    return res;\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"e70df4d80cde893a6897f8e6543c2d7666b73d7a","date":1365615272,"type":5,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/facet/src/test/org/apache/lucene/facet/search/TestDrillSideways#slowDrillSidewaysSearch(IndexSearcher,List[FacetRequest],List[Doc],String,String[][],String[][],Filter).mjava","pathOld":"lucene/facet/src/test/org/apache/lucene/facet/search/TestDrillSideways#slowDrillSidewaysSearch(IndexSearcher,List[Doc],String,String[][],String[][],Filter).mjava","sourceNew":"  private SimpleFacetResult slowDrillSidewaysSearch(IndexSearcher s, List<FacetRequest> requests, List<Doc> docs,\n                                                    String contentToken, String[][] drillDowns,\n                                                    String[][] dimValues, Filter onlyEven) throws Exception {\n    int numDims = dimValues.length;\n\n    List<Doc> hits = new ArrayList<Doc>();\n    Counters drillDownCounts = new Counters(dimValues);\n    Counters[] drillSidewaysCounts = new Counters[dimValues.length];\n    for(int dim=0;dim<numDims;dim++) {\n      drillSidewaysCounts[dim] = new Counters(dimValues);\n    }\n\n    if (VERBOSE) {\n      System.out.println(\"  compute expected\");\n    }\n\n    nextDoc: for(Doc doc : docs) {\n      if (doc.deleted) {\n        continue;\n      }\n      if (onlyEven != null & (Integer.parseInt(doc.id) & 1) != 0) {\n        continue;\n      }\n      if (contentToken == null || doc.contentToken.equals(contentToken)) {\n        int failDim = -1;\n        for(int dim=0;dim<numDims;dim++) {\n          if (drillDowns[dim] != null) {\n            String docValue = doc.dims[dim] == -1 ? null : dimValues[dim][doc.dims[dim]];\n            String docValue2 = doc.dims2[dim] == -1 ? null : dimValues[dim][doc.dims2[dim]];\n            boolean matches = false;\n            for(String value : drillDowns[dim]) {\n              if (value.equals(docValue) || value.equals(docValue2)) {\n                matches = true;\n                break;\n              }\n            }\n            if (!matches) {\n              if (failDim == -1) {\n                // Doc could be a near-miss, if no other dim fails\n                failDim = dim;\n              } else {\n                // Doc isn't a hit nor a near-miss\n                continue nextDoc;\n              }\n            }\n          }\n        }\n\n        if (failDim == -1) {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a hit\");\n          }\n          // Hit:\n          hits.add(doc);\n          drillDownCounts.inc(doc.dims, doc.dims2);\n          for(int dim=0;dim<dimValues.length;dim++) {\n            drillSidewaysCounts[dim].inc(doc.dims, doc.dims2);\n          }\n        } else {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a near-miss on dim=\" + failDim);\n          }\n          drillSidewaysCounts[failDim].inc(doc.dims, doc.dims2, failDim);\n        }\n      }\n    }\n\n    Map<String,Integer> idToDocID = new HashMap<String,Integer>();\n    for(int i=0;i<s.getIndexReader().maxDoc();i++) {\n      idToDocID.put(s.doc(i).get(\"id\"), i);\n    }\n\n    Collections.sort(hits);\n\n    SimpleFacetResult res = new SimpleFacetResult();\n    res.hits = hits;\n    res.counts = new int[numDims][];\n    for(int i=0;i<requests.size();i++) {\n      int dim = Integer.parseInt(requests.get(i).categoryPath.components[0].substring(3));\n      if (drillDowns[dim] != null) {\n        res.counts[dim] = drillSidewaysCounts[dim].counts[dim];\n      } else {\n        res.counts[dim] = drillDownCounts.counts[dim];\n      }\n    }\n\n    return res;\n  }\n\n","sourceOld":"  private SimpleFacetResult slowDrillSidewaysSearch(IndexSearcher s, List<Doc> docs, String contentToken, String[][] drillDowns,\n                                                    String[][] dimValues, Filter onlyEven) throws Exception {\n    int numDims = dimValues.length;\n\n    List<Doc> hits = new ArrayList<Doc>();\n    Counters drillDownCounts = new Counters(dimValues);\n    Counters[] drillSidewaysCounts = new Counters[dimValues.length];\n    for(int dim=0;dim<numDims;dim++) {\n      drillSidewaysCounts[dim] = new Counters(dimValues);\n    }\n\n    if (VERBOSE) {\n      System.out.println(\"  compute expected\");\n    }\n\n    nextDoc: for(Doc doc : docs) {\n      if (doc.deleted) {\n        continue;\n      }\n      if (onlyEven != null & (Integer.parseInt(doc.id) & 1) != 0) {\n        continue;\n      }\n      if (contentToken == null || doc.contentToken.equals(contentToken)) {\n        int failDim = -1;\n        for(int dim=0;dim<numDims;dim++) {\n          if (drillDowns[dim] != null) {\n            String docValue = doc.dims[dim] == -1 ? null : dimValues[dim][doc.dims[dim]];\n            String docValue2 = doc.dims2[dim] == -1 ? null : dimValues[dim][doc.dims2[dim]];\n            boolean matches = false;\n            for(String value : drillDowns[dim]) {\n              if (value.equals(docValue) || value.equals(docValue2)) {\n                matches = true;\n                break;\n              }\n            }\n            if (!matches) {\n              if (failDim == -1) {\n                // Doc could be a near-miss, if no other dim fails\n                failDim = dim;\n              } else {\n                // Doc isn't a hit nor a near-miss\n                continue nextDoc;\n              }\n            }\n          }\n        }\n\n        if (failDim == -1) {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a hit\");\n          }\n          // Hit:\n          hits.add(doc);\n          drillDownCounts.inc(doc.dims, doc.dims2);\n          for(int dim=0;dim<dimValues.length;dim++) {\n            drillSidewaysCounts[dim].inc(doc.dims, doc.dims2);\n          }\n        } else {\n          if (VERBOSE) {\n            System.out.println(\"    exp: id=\" + doc.id + \" is a near-miss on dim=\" + failDim);\n          }\n          drillSidewaysCounts[failDim].inc(doc.dims, doc.dims2, failDim);\n        }\n      }\n    }\n\n    Map<String,Integer> idToDocID = new HashMap<String,Integer>();\n    for(int i=0;i<s.getIndexReader().maxDoc();i++) {\n      idToDocID.put(s.doc(i).get(\"id\"), i);\n    }\n\n    Collections.sort(hits);\n\n    SimpleFacetResult res = new SimpleFacetResult();\n    res.hits = hits;\n    res.counts = new int[numDims][];\n    for(int dim=0;dim<numDims;dim++) {\n      if (drillDowns[dim] != null) {\n        res.counts[dim] = drillSidewaysCounts[dim].counts[dim];\n      } else {\n        res.counts[dim] = drillDownCounts.counts[dim];\n      }\n    }\n\n    return res;\n  }\n\n","bugFix":null,"bugIntro":["d1f7dc2d5ba61f478d9439f5b6afe27c8809422a"],"isBuggy":true,"nexts":[],"revCommit":null}],"commit2Parents":{"5b1ac4be5e40d7bda6ec0f850c933a95ca0642fd":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"e70df4d80cde893a6897f8e6543c2d7666b73d7a":["5b1ac4be5e40d7bda6ec0f850c933a95ca0642fd"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["e70df4d80cde893a6897f8e6543c2d7666b73d7a"]},"commit2Childs":{"5b1ac4be5e40d7bda6ec0f850c933a95ca0642fd":["e70df4d80cde893a6897f8e6543c2d7666b73d7a"],"e70df4d80cde893a6897f8e6543c2d7666b73d7a":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["5b1ac4be5e40d7bda6ec0f850c933a95ca0642fd"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}