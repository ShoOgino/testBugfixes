{"path":"lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.FieldsWriter#getInstance(FieldInfo,boolean).mjava","commits":[{"id":"1dbcafacd03baeb0f18199de611a1619606073c5","date":1546559081,"type":0,"author":"Mike McCandless","isMerge":false,"pathNew":"lucene/core/src/java/org/apache/lucene/codecs/perfield/PerFieldDocValuesFormat.FieldsWriter#getInstance(FieldInfo,boolean).mjava","pathOld":"/dev/null","sourceNew":"    /**\n     * DocValuesConsumer for the given field.\n     * @param field - FieldInfo object.\n     * @param ignoreCurrentFormat - ignore the existing format attributes.\n     * @return DocValuesConsumer for the field.\n     * @throws IOException if there is a low-level IO error\n     */\n    private DocValuesConsumer getInstance(FieldInfo field, boolean ignoreCurrentFormat) throws IOException {\n      DocValuesFormat format = null;\n      if (field.getDocValuesGen() != -1) {\n        String formatName = null;\n        if (ignoreCurrentFormat == false) {\n          formatName = field.getAttribute(PER_FIELD_FORMAT_KEY);\n        }\n        // this means the field never existed in that segment, yet is applied updates\n        if (formatName != null) {\n          format = DocValuesFormat.forName(formatName);\n        }\n      }\n      if (format == null) {\n        format = getDocValuesFormatForField(field.name);\n      }\n      if (format == null) {\n        throw new IllegalStateException(\"invalid null DocValuesFormat for field=\\\"\" + field.name + \"\\\"\");\n      }\n      final String formatName = format.getName();\n\n      field.putAttribute(PER_FIELD_FORMAT_KEY, formatName);\n      Integer suffix = null;\n\n      ConsumerAndSuffix consumer = formats.get(format);\n      if (consumer == null) {\n        // First time we are seeing this format; create a new instance\n\n        if (field.getDocValuesGen() != -1) {\n          String suffixAtt = null;\n          if (!ignoreCurrentFormat) {\n            suffixAtt = field.getAttribute(PER_FIELD_SUFFIX_KEY);\n          }\n          // even when dvGen is != -1, it can still be a new field, that never\n          // existed in the segment, and therefore doesn't have the recorded\n          // attributes yet.\n          if (suffixAtt != null) {\n            suffix = Integer.valueOf(suffixAtt);\n          }\n        }\n\n        if (suffix == null) {\n          // bump the suffix\n          suffix = suffixes.get(formatName);\n          if (suffix == null) {\n            suffix = 0;\n          } else {\n            suffix = suffix + 1;\n          }\n        }\n        suffixes.put(formatName, suffix);\n\n        final String segmentSuffix = getFullSegmentSuffix(segmentWriteState.segmentSuffix,\n                                                          getSuffix(formatName, Integer.toString(suffix)));\n        consumer = new ConsumerAndSuffix();\n        consumer.consumer = format.fieldsConsumer(new SegmentWriteState(segmentWriteState, segmentSuffix));\n        consumer.suffix = suffix;\n        formats.put(format, consumer);\n      } else {\n        // we've already seen this format, so just grab its suffix\n        assert suffixes.containsKey(formatName);\n        suffix = consumer.suffix;\n      }\n\n      field.putAttribute(PER_FIELD_SUFFIX_KEY, Integer.toString(suffix));\n      // TODO: we should only provide the \"slice\" of FIS\n      // that this DVF actually sees ...\n      return consumer.consumer;\n    }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"1dbcafacd03baeb0f18199de611a1619606073c5":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["1dbcafacd03baeb0f18199de611a1619606073c5"]},"commit2Childs":{"1dbcafacd03baeb0f18199de611a1619606073c5":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["1dbcafacd03baeb0f18199de611a1619606073c5"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}