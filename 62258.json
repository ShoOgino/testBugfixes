{"path":"lucene/spatial-extras/src/java/org/apache/lucene/spatial/prefix/NumberRangePrefixTreeStrategy#calcFacets(IndexReaderContext,Bits,Shape,int).mjava","commits":[{"id":"112d77ac8d3e10a362516ad834c9a11d35c94234","date":1456784319,"type":1,"author":"nknize","isMerge":false,"pathNew":"lucene/spatial-extras/src/java/org/apache/lucene/spatial/prefix/NumberRangePrefixTreeStrategy#calcFacets(IndexReaderContext,Bits,Shape,int).mjava","pathOld":"lucene/spatial/src/java/org/apache/lucene/spatial/prefix/NumberRangePrefixTreeStrategy#calcFacets(IndexReaderContext,Bits,Shape,int).mjava","sourceNew":"  /**\n   * Calculates facets (aggregated counts) given a range shape (start-end span) and a level, which specifies the detail.\n   * To get the level of an existing shape, say a Calendar, call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree#toUnitShape(Object)} then call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree.UnitNRShape#getLevel()}.\n   * Facet computation is implemented by navigating the underlying indexed terms efficiently.\n   */\n  public Facets calcFacets(IndexReaderContext context, Bits topAcceptDocs, Shape facetRange, final int level)\n      throws IOException {\n    final Facets facets = new Facets(level);\n    PrefixTreeFacetCounter.compute(this, context, topAcceptDocs, facetRange, level,\n        new PrefixTreeFacetCounter.FacetVisitor() {\n          Facets.FacetParentVal parentFacet;\n          UnitNRShape parentShape;\n\n          @Override\n          public void visit(Cell cell, int count) {\n            if (cell.getLevel() < level - 1) {//some ancestor of parent facet level, direct or distant\n              parentFacet = null;//reset\n              parentShape = null;//reset\n              facets.topLeaves += count;\n            } else if (cell.getLevel() == level - 1) {//parent\n              //set up FacetParentVal\n              setupParent((UnitNRShape) cell.getShape());\n              parentFacet.parentLeaves += count;\n            } else {//at facet level\n              UnitNRShape unitShape = (UnitNRShape) cell.getShape();\n              UnitNRShape unitShapeParent = unitShape.getShapeAtLevel(unitShape.getLevel() - 1);\n              if (parentFacet == null || !parentShape.equals(unitShapeParent)) {\n                setupParent(unitShapeParent);\n              }\n              //lazy init childCounts\n              if (parentFacet.childCounts == null) {\n                parentFacet.childCounts = new int[parentFacet.childCountsLen];\n              }\n              parentFacet.childCounts[unitShape.getValAtLevel(cell.getLevel())] += count;\n            }\n          }\n\n          private void setupParent(UnitNRShape unitShape) {\n            parentShape = unitShape.clone();\n            //Look for existing parentFacet (from previous segment), or create anew if needed\n            parentFacet = facets.parents.get(parentShape);\n            if (parentFacet == null) {//didn't find one; make a new one\n              parentFacet = new Facets.FacetParentVal();\n              parentFacet.childCountsLen = getGrid().getNumSubCells(parentShape);\n              facets.parents.put(parentShape, parentFacet);\n            }\n          }\n        });\n    return facets;\n  }\n\n","sourceOld":"  /**\n   * Calculates facets (aggregated counts) given a range shape (start-end span) and a level, which specifies the detail.\n   * To get the level of an existing shape, say a Calendar, call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree#toUnitShape(Object)} then call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree.UnitNRShape#getLevel()}.\n   * Facet computation is implemented by navigating the underlying indexed terms efficiently.\n   */\n  public Facets calcFacets(IndexReaderContext context, Bits topAcceptDocs, Shape facetRange, final int level)\n      throws IOException {\n    final Facets facets = new Facets(level);\n    PrefixTreeFacetCounter.compute(this, context, topAcceptDocs, facetRange, level,\n        new PrefixTreeFacetCounter.FacetVisitor() {\n          Facets.FacetParentVal parentFacet;\n          UnitNRShape parentShape;\n\n          @Override\n          public void visit(Cell cell, int count) {\n            if (cell.getLevel() < level - 1) {//some ancestor of parent facet level, direct or distant\n              parentFacet = null;//reset\n              parentShape = null;//reset\n              facets.topLeaves += count;\n            } else if (cell.getLevel() == level - 1) {//parent\n              //set up FacetParentVal\n              setupParent((UnitNRShape) cell.getShape());\n              parentFacet.parentLeaves += count;\n            } else {//at facet level\n              UnitNRShape unitShape = (UnitNRShape) cell.getShape();\n              UnitNRShape unitShapeParent = unitShape.getShapeAtLevel(unitShape.getLevel() - 1);\n              if (parentFacet == null || !parentShape.equals(unitShapeParent)) {\n                setupParent(unitShapeParent);\n              }\n              //lazy init childCounts\n              if (parentFacet.childCounts == null) {\n                parentFacet.childCounts = new int[parentFacet.childCountsLen];\n              }\n              parentFacet.childCounts[unitShape.getValAtLevel(cell.getLevel())] += count;\n            }\n          }\n\n          private void setupParent(UnitNRShape unitShape) {\n            parentShape = unitShape.clone();\n            //Look for existing parentFacet (from previous segment), or create anew if needed\n            parentFacet = facets.parents.get(parentShape);\n            if (parentFacet == null) {//didn't find one; make a new one\n              parentFacet = new Facets.FacetParentVal();\n              parentFacet.childCountsLen = getGrid().getNumSubCells(parentShape);\n              facets.parents.put(parentShape, parentFacet);\n            }\n          }\n        });\n    return facets;\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"af2638813028b254a88b418ebeafb541afb49653","date":1456804822,"type":1,"author":"Noble Paul","isMerge":true,"pathNew":"lucene/spatial-extras/src/java/org/apache/lucene/spatial/prefix/NumberRangePrefixTreeStrategy#calcFacets(IndexReaderContext,Bits,Shape,int).mjava","pathOld":"lucene/spatial/src/java/org/apache/lucene/spatial/prefix/NumberRangePrefixTreeStrategy#calcFacets(IndexReaderContext,Bits,Shape,int).mjava","sourceNew":"  /**\n   * Calculates facets (aggregated counts) given a range shape (start-end span) and a level, which specifies the detail.\n   * To get the level of an existing shape, say a Calendar, call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree#toUnitShape(Object)} then call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree.UnitNRShape#getLevel()}.\n   * Facet computation is implemented by navigating the underlying indexed terms efficiently.\n   */\n  public Facets calcFacets(IndexReaderContext context, Bits topAcceptDocs, Shape facetRange, final int level)\n      throws IOException {\n    final Facets facets = new Facets(level);\n    PrefixTreeFacetCounter.compute(this, context, topAcceptDocs, facetRange, level,\n        new PrefixTreeFacetCounter.FacetVisitor() {\n          Facets.FacetParentVal parentFacet;\n          UnitNRShape parentShape;\n\n          @Override\n          public void visit(Cell cell, int count) {\n            if (cell.getLevel() < level - 1) {//some ancestor of parent facet level, direct or distant\n              parentFacet = null;//reset\n              parentShape = null;//reset\n              facets.topLeaves += count;\n            } else if (cell.getLevel() == level - 1) {//parent\n              //set up FacetParentVal\n              setupParent((UnitNRShape) cell.getShape());\n              parentFacet.parentLeaves += count;\n            } else {//at facet level\n              UnitNRShape unitShape = (UnitNRShape) cell.getShape();\n              UnitNRShape unitShapeParent = unitShape.getShapeAtLevel(unitShape.getLevel() - 1);\n              if (parentFacet == null || !parentShape.equals(unitShapeParent)) {\n                setupParent(unitShapeParent);\n              }\n              //lazy init childCounts\n              if (parentFacet.childCounts == null) {\n                parentFacet.childCounts = new int[parentFacet.childCountsLen];\n              }\n              parentFacet.childCounts[unitShape.getValAtLevel(cell.getLevel())] += count;\n            }\n          }\n\n          private void setupParent(UnitNRShape unitShape) {\n            parentShape = unitShape.clone();\n            //Look for existing parentFacet (from previous segment), or create anew if needed\n            parentFacet = facets.parents.get(parentShape);\n            if (parentFacet == null) {//didn't find one; make a new one\n              parentFacet = new Facets.FacetParentVal();\n              parentFacet.childCountsLen = getGrid().getNumSubCells(parentShape);\n              facets.parents.put(parentShape, parentFacet);\n            }\n          }\n        });\n    return facets;\n  }\n\n","sourceOld":"  /**\n   * Calculates facets (aggregated counts) given a range shape (start-end span) and a level, which specifies the detail.\n   * To get the level of an existing shape, say a Calendar, call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree#toUnitShape(Object)} then call\n   * {@link org.apache.lucene.spatial.prefix.tree.NumberRangePrefixTree.UnitNRShape#getLevel()}.\n   * Facet computation is implemented by navigating the underlying indexed terms efficiently.\n   */\n  public Facets calcFacets(IndexReaderContext context, Bits topAcceptDocs, Shape facetRange, final int level)\n      throws IOException {\n    final Facets facets = new Facets(level);\n    PrefixTreeFacetCounter.compute(this, context, topAcceptDocs, facetRange, level,\n        new PrefixTreeFacetCounter.FacetVisitor() {\n          Facets.FacetParentVal parentFacet;\n          UnitNRShape parentShape;\n\n          @Override\n          public void visit(Cell cell, int count) {\n            if (cell.getLevel() < level - 1) {//some ancestor of parent facet level, direct or distant\n              parentFacet = null;//reset\n              parentShape = null;//reset\n              facets.topLeaves += count;\n            } else if (cell.getLevel() == level - 1) {//parent\n              //set up FacetParentVal\n              setupParent((UnitNRShape) cell.getShape());\n              parentFacet.parentLeaves += count;\n            } else {//at facet level\n              UnitNRShape unitShape = (UnitNRShape) cell.getShape();\n              UnitNRShape unitShapeParent = unitShape.getShapeAtLevel(unitShape.getLevel() - 1);\n              if (parentFacet == null || !parentShape.equals(unitShapeParent)) {\n                setupParent(unitShapeParent);\n              }\n              //lazy init childCounts\n              if (parentFacet.childCounts == null) {\n                parentFacet.childCounts = new int[parentFacet.childCountsLen];\n              }\n              parentFacet.childCounts[unitShape.getValAtLevel(cell.getLevel())] += count;\n            }\n          }\n\n          private void setupParent(UnitNRShape unitShape) {\n            parentShape = unitShape.clone();\n            //Look for existing parentFacet (from previous segment), or create anew if needed\n            parentFacet = facets.parents.get(parentShape);\n            if (parentFacet == null) {//didn't find one; make a new one\n              parentFacet = new Facets.FacetParentVal();\n              parentFacet.childCountsLen = getGrid().getNumSubCells(parentShape);\n              facets.parents.put(parentShape, parentFacet);\n            }\n          }\n        });\n    return facets;\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"af2638813028b254a88b418ebeafb541afb49653":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85","112d77ac8d3e10a362516ad834c9a11d35c94234"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"112d77ac8d3e10a362516ad834c9a11d35c94234":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["af2638813028b254a88b418ebeafb541afb49653"]},"commit2Childs":{"af2638813028b254a88b418ebeafb541afb49653":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["af2638813028b254a88b418ebeafb541afb49653","112d77ac8d3e10a362516ad834c9a11d35c94234"],"112d77ac8d3e10a362516ad834c9a11d35c94234":["af2638813028b254a88b418ebeafb541afb49653"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}