{"path":"solr/core/src/test/org/apache/solr/update/processor/TimePartitionedUpdateProcessorTest#assertInvariants().mjava","commits":[{"id":"543992c52fe295c8b15aafe4b066e7e3a9a42c48","date":1510862949,"type":0,"author":"David Smiley","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/processor/TimePartitionedUpdateProcessorTest#assertInvariants().mjava","pathOld":"/dev/null","sourceNew":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimePartitionedUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"5613a70439d5d429f0689c2c5a21615e58deff97","date":1512102314,"type":5,"author":"David Smiley","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/update/processor/TimeRoutedAliasUpdateProcessorTest#assertInvariants().mjava","pathOld":"solr/core/src/test/org/apache/solr/update/processor/TimePartitionedUpdateProcessorTest#assertInvariants().mjava","sourceNew":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimeRoutedAliasUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","sourceOld":"  private void assertInvariants() throws IOException, SolrServerException {\n    final int expectNumFound = lastDocId - numDocsDeletedOrFailed; //lastDocId is effectively # generated docs\n\n    final List<String> cols = new CollectionAdminRequest.ListAliases().process(solrClient).getAliasesAsLists().get(alias);\n    assert !cols.isEmpty();\n\n    int totalNumFound = 0;\n    Instant colEndInstant = null; // exclusive end\n    for (String col : cols) {\n      final Instant colStartInstant = TimePartitionedUpdateProcessor.parseInstantFromCollectionName(alias, col);\n      //TODO do this in parallel threads\n      final QueryResponse colStatsResp = solrClient.query(col, params(\n          \"q\", \"*:*\",\n          \"rows\", \"0\",\n          \"stats\", \"true\",\n          \"stats.field\", timeField));\n      long numFound = colStatsResp.getResults().getNumFound();\n      if (numFound > 0) {\n        totalNumFound += numFound;\n        final FieldStatsInfo timestampStats = colStatsResp.getFieldStatsInfo().get(timeField);\n        assertTrue(colStartInstant.toEpochMilli() <= ((Date)timestampStats.getMin()).getTime());\n        if (colEndInstant != null) {\n          assertTrue(colEndInstant.toEpochMilli() > ((Date)timestampStats.getMax()).getTime());\n        }\n      }\n\n      colEndInstant = colStartInstant; // next older segment will max out at our current start time\n    }\n    assertEquals(expectNumFound, totalNumFound);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"5613a70439d5d429f0689c2c5a21615e58deff97":["543992c52fe295c8b15aafe4b066e7e3a9a42c48"],"543992c52fe295c8b15aafe4b066e7e3a9a42c48":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["5613a70439d5d429f0689c2c5a21615e58deff97"]},"commit2Childs":{"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["543992c52fe295c8b15aafe4b066e7e3a9a42c48"],"5613a70439d5d429f0689c2c5a21615e58deff97":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"543992c52fe295c8b15aafe4b066e7e3a9a42c48":["5613a70439d5d429f0689c2c5a21615e58deff97"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}