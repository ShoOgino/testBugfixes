{"path":"solr/core/src/java/org/apache/solr/core/CoreMaps#clearMaps(ConfigSolr).mjava","commits":[{"id":"c7c73b6560033b6dcc828fbcc94ba9315c20f3c0","date":1366659310,"type":1,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/java/org/apache/solr/core/CoreMaps#clearMaps(ConfigSolr).mjava","pathOld":"solr/core/src/java/org/apache/solr/core/CoreMaps[CoreContainer]#clearMaps(ConfigSolr).mjava","sourceNew":"  // We are shutting down. You can't hold the lock on the various lists of cores while they shut down, so we need to\n  // make a temporary copy of the names and shut them down outside the lock.\n  protected void clearMaps(ConfigSolr cfg) {\n    List<String> coreNames;\n    List<String> transientNames;\n    List<SolrCore> pendingToClose;\n\n    // It might be possible for one of the cores to move from one list to another while we're closing them. So\n    // loop through the lists until they're all empty. In particular, the core could have moved from the transient\n    // list to the pendingCloses list.\n\n    while (true) {\n      synchronized (locker) {\n        coreNames = new ArrayList<String>(cores.keySet());\n        transientNames = new ArrayList<String>(transientCores.keySet());\n        pendingToClose = new ArrayList<SolrCore>(pendingCloses);\n      }\n\n      if (coreNames.size() == 0 && transientNames.size() == 0 && pendingToClose.size() == 0) break;\n\n      for (String coreName : coreNames) {\n        SolrCore core = cores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from core container list before closing.\");\n        } else {\n          try {\n            // nocommit: wtf is this?\n           // addPersistOneCore(cfg, container.loader, core.getCoreDescriptor(), getCoreToOrigName(core));\n\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              cores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      for (String coreName : transientNames) {\n        SolrCore core = transientCores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from transient core container list before closing.\");\n        } else {\n          try {\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              transientCores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      // We might have some cores that we were _thinking_ about shutting down, so take care of those too.\n      for (SolrCore core : pendingToClose) {\n        try {\n          core.close();\n        } catch (Throwable t) {\n          SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n        } finally {\n          synchronized (locker) {\n            pendingCloses.remove(core);\n          }\n        }\n      }\n    }\n  }\n\n","sourceOld":"  // We are shutting down. You can't hold the lock on the various lists of cores while they shut down, so we need to\n  // make a temporary copy of the names and shut them down outside the lock.\n  protected void clearMaps(ConfigSolr cfg) {\n    List<String> coreNames;\n    List<String> transientNames;\n    List<SolrCore> pendingToClose;\n\n    // It might be possible for one of the cores to move from one list to another while we're closing them. So\n    // loop through the lists until they're all empty. In particular, the core could have moved from the transient\n    // list to the pendingCloses list.\n\n    while (true) {\n      synchronized (locker) {\n        coreNames = new ArrayList(cores.keySet());\n        transientNames = new ArrayList(transientCores.keySet());\n        pendingToClose = new ArrayList(pendingCloses);\n      }\n\n      if (coreNames.size() == 0 && transientNames.size() == 0 && pendingToClose.size() == 0) break;\n\n      for (String coreName : coreNames) {\n        SolrCore core = cores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from core container list before closing.\");\n        } else {\n          try {\n            addPersistOneCore(cfg, container.loader, core.getCoreDescriptor(), getCoreToOrigName(core));\n\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              cores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      for (String coreName : transientNames) {\n        SolrCore core = transientCores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from transient core container list before closing.\");\n        } else {\n          try {\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              transientCores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      // We might have some cores that we were _thinking_ about shutting down, so take care of those too.\n      for (SolrCore core : pendingToClose) {\n        try {\n          core.close();\n        } catch (Throwable t) {\n          SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n        } finally {\n          synchronized (locker) {\n            pendingCloses.remove(core);\n          }\n        }\n      }\n    }\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"9409650933cc688e77e565092a25e58adfc2e18d","date":1366663164,"type":5,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/core/src/java/org/apache/solr/core/SolrCores#close().mjava","pathOld":"solr/core/src/java/org/apache/solr/core/CoreMaps#clearMaps(ConfigSolr).mjava","sourceNew":"  // We are shutting down. You can't hold the lock on the various lists of cores while they shut down, so we need to\n  // make a temporary copy of the names and shut them down outside the lock.\n  protected void close() {\n    List<String> coreNames;\n    List<String> transientNames;\n    List<SolrCore> pendingToClose;\n\n    // It might be possible for one of the cores to move from one list to another while we're closing them. So\n    // loop through the lists until they're all empty. In particular, the core could have moved from the transient\n    // list to the pendingCloses list.\n\n    while (true) {\n      synchronized (modifyLock) {\n        coreNames = new ArrayList<String>(cores.keySet());\n        transientNames = new ArrayList<String>(transientCores.keySet());\n        pendingToClose = new ArrayList<SolrCore>(pendingCloses);\n      }\n\n      if (coreNames.size() == 0 && transientNames.size() == 0 && pendingToClose.size() == 0) break;\n\n      for (String coreName : coreNames) {\n        SolrCore core = cores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from core container list before closing.\");\n        } else {\n          try {\n            // nocommit: wtf is this?\n           // addPersistOneCore(cfg, container.loader, core.getCoreDescriptor(), getCoreToOrigName(core));\n\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (modifyLock) {\n              cores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      for (String coreName : transientNames) {\n        SolrCore core = transientCores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from transient core container list before closing.\");\n        } else {\n          try {\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (modifyLock) {\n              transientCores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      // We might have some cores that we were _thinking_ about shutting down, so take care of those too.\n      for (SolrCore core : pendingToClose) {\n        try {\n          core.close();\n        } catch (Throwable t) {\n          SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n        } finally {\n          synchronized (modifyLock) {\n            pendingCloses.remove(core);\n          }\n        }\n      }\n    }\n  }\n\n","sourceOld":"  // We are shutting down. You can't hold the lock on the various lists of cores while they shut down, so we need to\n  // make a temporary copy of the names and shut them down outside the lock.\n  protected void clearMaps(ConfigSolr cfg) {\n    List<String> coreNames;\n    List<String> transientNames;\n    List<SolrCore> pendingToClose;\n\n    // It might be possible for one of the cores to move from one list to another while we're closing them. So\n    // loop through the lists until they're all empty. In particular, the core could have moved from the transient\n    // list to the pendingCloses list.\n\n    while (true) {\n      synchronized (locker) {\n        coreNames = new ArrayList<String>(cores.keySet());\n        transientNames = new ArrayList<String>(transientCores.keySet());\n        pendingToClose = new ArrayList<SolrCore>(pendingCloses);\n      }\n\n      if (coreNames.size() == 0 && transientNames.size() == 0 && pendingToClose.size() == 0) break;\n\n      for (String coreName : coreNames) {\n        SolrCore core = cores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from core container list before closing.\");\n        } else {\n          try {\n            // nocommit: wtf is this?\n           // addPersistOneCore(cfg, container.loader, core.getCoreDescriptor(), getCoreToOrigName(core));\n\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              cores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      for (String coreName : transientNames) {\n        SolrCore core = transientCores.get(coreName);\n        if (core == null) {\n          CoreContainer.log.info(\"Core \" + coreName + \" moved from transient core container list before closing.\");\n        } else {\n          try {\n            core.close();\n          } catch (Throwable t) {\n            SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n          } finally {\n            synchronized (locker) {\n              transientCores.remove(coreName);\n            }\n          }\n        }\n      }\n\n      // We might have some cores that we were _thinking_ about shutting down, so take care of those too.\n      for (SolrCore core : pendingToClose) {\n        try {\n          core.close();\n        } catch (Throwable t) {\n          SolrException.log(CoreContainer.log, \"Error shutting down core\", t);\n        } finally {\n          synchronized (locker) {\n            pendingCloses.remove(core);\n          }\n        }\n      }\n    }\n  }\n\n","bugFix":null,"bugIntro":["b16415d71f34d00bd12f3db116f7cac330f123e0"],"isBuggy":true,"nexts":[],"revCommit":null}],"commit2Parents":{"9409650933cc688e77e565092a25e58adfc2e18d":["c7c73b6560033b6dcc828fbcc94ba9315c20f3c0"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"c7c73b6560033b6dcc828fbcc94ba9315c20f3c0":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["9409650933cc688e77e565092a25e58adfc2e18d"]},"commit2Childs":{"9409650933cc688e77e565092a25e58adfc2e18d":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["c7c73b6560033b6dcc828fbcc94ba9315c20f3c0"],"c7c73b6560033b6dcc828fbcc94ba9315c20f3c0":["9409650933cc688e77e565092a25e58adfc2e18d"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}