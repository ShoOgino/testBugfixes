{"path":"lucene/core/src/test/org/apache/lucene/index/TestIndexWriter#testMaxCompletedSequenceNumber().mjava","commits":[{"id":"b07024a7318c25225dc4d070cf6d047315b73aaf","date":1586885963,"type":0,"author":"Simon Willnauer","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/index/TestIndexWriter#testMaxCompletedSequenceNumber().mjava","pathOld":"/dev/null","sourceNew":"  public void testMaxCompletedSequenceNumber() throws IOException, InterruptedException {\n    try (Directory dir = newDirectory();\n         IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig());) {\n      assertEquals(1, writer.addDocument(new Document()));\n      assertEquals(2, writer.updateDocument(new Term(\"foo\", \"bar\"), new Document()));\n      writer.flushNextBuffer();\n      assertEquals(3, writer.commit());\n      assertEquals(4, writer.addDocument(new Document()));\n      assertEquals(4, writer.getMaxCompletedSequenceNumber());\n      // commit moves seqNo by 2 since there is one DWPT that could still be in-flight\n      assertEquals(6, writer.commit());\n      assertEquals(6, writer.getMaxCompletedSequenceNumber());\n      assertEquals(7, writer.addDocument(new Document()));\n      writer.getReader().close();\n      // getReader moves seqNo by 2 since there is one DWPT that could still be in-flight\n      assertEquals(9, writer.getMaxCompletedSequenceNumber());\n    }\n    try (Directory dir = newDirectory();\n         IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig());\n         SearcherManager manager = new SearcherManager(writer, new SearcherFactory())) {\n      CountDownLatch start = new CountDownLatch(1);\n      int numDocs = 100 + random().nextInt(500);\n      AtomicLong maxCompletedSeqID = new AtomicLong(-1);\n      Thread[] threads = new Thread[2 + random().nextInt(2)];\n      for (int i = 0; i < threads.length; i++) {\n        int idx = i;\n        threads[i] = new Thread(() -> {\n          try {\n            start.await();\n            for (int j = 0; j < numDocs; j++) {\n              Document doc = new Document();\n              String id = idx +\"-\"+j;\n              doc.add(new StringField(\"id\", id, Field.Store.NO));\n              long seqNo = writer.addDocument(doc);\n              if (maxCompletedSeqID.get() < seqNo) {\n                long maxCompletedSequenceNumber = writer.getMaxCompletedSequenceNumber();\n                manager.maybeRefreshBlocking();\n                maxCompletedSeqID.updateAndGet(oldVal-> Math.max(oldVal, maxCompletedSequenceNumber));\n              }\n              IndexSearcher acquire = manager.acquire();\n              try {\n                assertEquals(1, acquire.search(new TermQuery(new Term(\"id\", id)), 10).totalHits.value);\n              } finally {\n                manager.release(acquire);\n              }\n            }\n          } catch (Exception e) {\n            throw new AssertionError(e);\n          }\n        });\n        threads[i].start();\n      }\n      start.countDown();\n      for (int i = 0; i < threads.length; i++) {\n        threads[i].join();\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"b07024a7318c25225dc4d070cf6d047315b73aaf":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["b07024a7318c25225dc4d070cf6d047315b73aaf"]},"commit2Childs":{"b07024a7318c25225dc4d070cf6d047315b73aaf":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["b07024a7318c25225dc4d070cf6d047315b73aaf"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}