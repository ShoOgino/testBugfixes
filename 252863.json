{"path":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","commits":[{"id":"a5efc03c304ac592bb9047dcbd762fb666a238bc","date":1457112180,"type":0,"author":"Martijn van Groningen","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"/dev/null","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        r.getCoreCacheKey(), values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"922ddd897402a6df25c766ea8300443be5e82b3d","date":1457157606,"type":0,"author":"Noble Paul","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"/dev/null","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        r.getCoreCacheKey(), values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"d211216c83f01894810543d1c107160a9ae3650b","date":1488289605,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        r.getCoreCacheKey(), values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"957c610636f393a85a38f1af670540028db13e6b","date":1500044517,"type":3,"author":"Mike McCandless","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    OrdinalMap ordinalMap = OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"aaf90fc29510e72665ac7934f34c3d1c25efad64","date":1500354819,"type":3,"author":"Cao Manh Dat","isMerge":true,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    OrdinalMap ordinalMap = OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    MultiDocValues.OrdinalMap ordinalMap = MultiDocValues.OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"83788ad129a5154d5c6562c4e8ce3db48793aada","date":1532961485,"type":3,"author":"Adrien Grand","isMerge":false,"pathNew":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","pathOld":"lucene/join/src/test/org/apache/lucene/search/join/TestJoinUtil#testOrdinalsJoinExplainNoMatches().mjava","sourceNew":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    OrdinalMap ordinalMap = OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits.value);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","sourceOld":"  public void testOrdinalsJoinExplainNoMatches() throws Exception {\n    final String idField = \"id\";\n    final String productIdField = \"productId\";\n    // A field indicating to what type a document belongs, which is then used to distinques between documents during joining.\n    final String typeField = \"type\";\n    // A single sorted doc values field that holds the join values for all document types.\n    // Typically during indexing a schema will automatically create this field with the values\n    final String joinField = idField + productIdField;\n\n    Directory dir = newDirectory();\n    IndexWriter w = new IndexWriter(\n        dir, newIndexWriterConfig(new MockAnalyzer(random())).setMergePolicy(NoMergePolicy.INSTANCE)\n    );\n\n    // 0\n    Document doc = new Document();\n    doc.add(new TextField(idField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name1\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 1\n    doc = new Document();\n    doc.add(new TextField(idField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"product\", Field.Store.NO));\n    doc.add(new TextField(\"description\", \"random text\", Field.Store.NO));\n    doc.add(new TextField(\"name\", \"name2\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 2\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"1\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"10.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    // 3\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"2\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"20.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"1\")));\n    w.addDocument(doc);\n\n    if (random().nextBoolean()) {\n      w.flush();\n    }\n\n    // 4\n    doc = new Document();\n    doc.add(new TextField(productIdField, \"3\", Field.Store.NO));\n    doc.add(new TextField(typeField, \"price\", Field.Store.NO));\n    doc.add(new TextField(\"price\", \"5.0\", Field.Store.NO));\n    doc.add(new SortedDocValuesField(joinField, new BytesRef(\"2\")));\n    w.addDocument(doc);\n\n    // 5\n    doc = new Document();\n    doc.add(new TextField(\"field\", \"value\", Field.Store.NO));\n    w.addDocument(doc);\n\n    IndexReader r = DirectoryReader.open(w);\n    IndexSearcher indexSearcher = new IndexSearcher(r);\n    SortedDocValues[] values = new SortedDocValues[r.leaves().size()];\n    for (int i = 0; i < values.length; i++) {\n      LeafReader leafReader =  r.leaves().get(i).reader();\n      values[i] = DocValues.getSorted(leafReader, joinField);\n    }\n    OrdinalMap ordinalMap = OrdinalMap.build(\n        null, values, PackedInts.DEFAULT\n    );\n\n    Query toQuery = new TermQuery(new Term(\"price\", \"5.0\"));\n    Query fromQuery = new TermQuery(new Term(\"name\", \"name2\"));\n\n    for (ScoreMode scoreMode : ScoreMode.values()) {\n      Query joinQuery = JoinUtil.createJoinQuery(joinField, fromQuery, toQuery, indexSearcher, scoreMode, ordinalMap);\n      TopDocs result = indexSearcher.search(joinQuery, 10);\n      assertEquals(1, result.totalHits);\n      assertEquals(4, result.scoreDocs[0].doc); // doc with price: 5.0\n      Explanation explanation = indexSearcher.explain(joinQuery, 4);\n      assertTrue(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"A match, join value 2\");\n\n      explanation = indexSearcher.explain(joinQuery, 3);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match, join value 1\");\n\n      explanation = indexSearcher.explain(joinQuery, 5);\n      assertFalse(explanation.isMatch());\n      assertEquals(explanation.getDescription(), \"Not a match\");\n    }\n\n    w.close();\n    indexSearcher.getIndexReader().close();\n    dir.close();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"957c610636f393a85a38f1af670540028db13e6b":["d211216c83f01894810543d1c107160a9ae3650b"],"922ddd897402a6df25c766ea8300443be5e82b3d":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85","a5efc03c304ac592bb9047dcbd762fb666a238bc"],"aaf90fc29510e72665ac7934f34c3d1c25efad64":["d211216c83f01894810543d1c107160a9ae3650b","957c610636f393a85a38f1af670540028db13e6b"],"d211216c83f01894810543d1c107160a9ae3650b":["922ddd897402a6df25c766ea8300443be5e82b3d"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"a5efc03c304ac592bb9047dcbd762fb666a238bc":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"83788ad129a5154d5c6562c4e8ce3db48793aada":["957c610636f393a85a38f1af670540028db13e6b"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["83788ad129a5154d5c6562c4e8ce3db48793aada"]},"commit2Childs":{"957c610636f393a85a38f1af670540028db13e6b":["aaf90fc29510e72665ac7934f34c3d1c25efad64","83788ad129a5154d5c6562c4e8ce3db48793aada"],"922ddd897402a6df25c766ea8300443be5e82b3d":["d211216c83f01894810543d1c107160a9ae3650b"],"aaf90fc29510e72665ac7934f34c3d1c25efad64":[],"d211216c83f01894810543d1c107160a9ae3650b":["957c610636f393a85a38f1af670540028db13e6b","aaf90fc29510e72665ac7934f34c3d1c25efad64"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["922ddd897402a6df25c766ea8300443be5e82b3d","a5efc03c304ac592bb9047dcbd762fb666a238bc"],"a5efc03c304ac592bb9047dcbd762fb666a238bc":["922ddd897402a6df25c766ea8300443be5e82b3d"],"83788ad129a5154d5c6562c4e8ce3db48793aada":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["aaf90fc29510e72665ac7934f34c3d1c25efad64","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}