{"path":"lucene/core/src/test/org/apache/lucene/index/TestIndexWriter#testRandomOperationsWithSoftDeletes().mjava","commits":[{"id":"70c7dd11b97185dbbe8c5963593a87075fb15a40","date":1583720284,"type":0,"author":"Nhat Nguyen","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/index/TestIndexWriter#testRandomOperationsWithSoftDeletes().mjava","pathOld":"/dev/null","sourceNew":"  public void testRandomOperationsWithSoftDeletes() throws Exception {\n    IndexWriterConfig iwc = newIndexWriterConfig();\n    AtomicInteger seqNo = new AtomicInteger(-1);\n    AtomicInteger retainingSeqNo = new AtomicInteger();\n    iwc.setSoftDeletesField(\"soft_deletes\");\n    iwc.setMergePolicy(new SoftDeletesRetentionMergePolicy(\"soft_deletes\",\n        () -> LongPoint.newRangeQuery(\"seq_no\", retainingSeqNo.longValue(), Long.MAX_VALUE), newMergePolicy()));\n    try (Directory dir = newDirectory();\n         IndexWriter writer = new IndexWriter(dir, iwc);\n         SearcherManager sm = new SearcherManager(writer, new SearcherFactory())) {\n      Semaphore numOperations = new Semaphore(10 + random().nextInt(1000));\n      boolean singleDoc = random().nextBoolean();\n      Thread[] threads = new Thread[1 + random().nextInt(4)];\n      CountDownLatch latch = new CountDownLatch(threads.length);\n      for (int i = 0; i < threads.length; i++) {\n        threads[i] = new Thread(() -> {\n          latch.countDown();\n          try {\n            latch.await();\n            while (numOperations.tryAcquire()) {\n              String id = singleDoc ? \"1\" : Integer.toString(random().nextInt(10));\n              Document doc = new Document();\n              doc.add(new StringField(\"id\", id, Field.Store.YES));\n              doc.add(new LongPoint(\"seq_no\", seqNo.getAndIncrement()));\n              if (random().nextInt(10) <= 2) {\n                if (random().nextBoolean()) {\n                  doc.add(new NumericDocValuesField(iwc.softDeletesField, 1));\n                }\n                writer.softUpdateDocument(new Term(\"id\", id), doc, new NumericDocValuesField(iwc.softDeletesField, 1));\n              } else {\n                writer.addDocument(doc);\n              }\n              if (random().nextInt(100) < 10) {\n                int min = retainingSeqNo.get();\n                int max = seqNo.get();\n                if (min < max && random().nextBoolean()) {\n                  retainingSeqNo.compareAndSet(min, min - random().nextInt(max - min));\n                }\n              }\n              if (random().nextInt(100) < 10) {\n                sm.maybeRefreshBlocking();\n              }\n              if (random().nextInt(100) < 5) {\n                writer.commit();\n              }\n              if (random().nextInt(100) < 1) {\n                writer.forceMerge(1 + random().nextInt(10), random().nextBoolean());\n              }\n            }\n          } catch (Exception e) {\n            throw new AssertionError(e);\n          }\n        });\n        threads[i].start();\n      }\n      for (Thread thread : threads) {\n        thread.join();\n      }\n    }\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"70c7dd11b97185dbbe8c5963593a87075fb15a40":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["70c7dd11b97185dbbe8c5963593a87075fb15a40"]},"commit2Childs":{"70c7dd11b97185dbbe8c5963593a87075fb15a40":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["70c7dd11b97185dbbe8c5963593a87075fb15a40"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}