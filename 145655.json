{"path":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","commits":[{"id":"c99002731351c8c955238845b0038682148eec53","date":1596830766,"type":0,"author":"Atri Sharma","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","pathOld":"/dev/null","sourceNew":"  @Test\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    processTest(client);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0fb0add11bccdea6f8a289cec694aa9f3895ef4e","date":1597165973,"type":3,"author":"Atri Sharma","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","pathOld":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","sourceNew":"  @Test\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    int numDocs = TEST_NIGHTLY ? 10000 : 100;\n\n    processTest(client, numDocs, 400 /* Number of queries */);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","sourceOld":"  @Test\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    processTest(client);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4d8de9b037ea3dd378609f4eb4d229334680d60d","date":1597738429,"type":3,"author":"Atri Sharma","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","pathOld":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","sourceNew":"  @Nightly\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    int numDocs = 10000;\n\n    processTest(client, numDocs, 400 /* Number of queries */);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","sourceOld":"  @Test\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    int numDocs = TEST_NIGHTLY ? 10000 : 100;\n\n    processTest(client, numDocs, 400 /* Number of queries */);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2460e6297ab2074eb39fc76a9806e0a0b640c88c","date":1601285226,"type":3,"author":"Atri Sharma","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","pathOld":"solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter#testSlotBorrowing().mjava","sourceNew":"  @Nightly\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RateLimiterConfig queryRateLimiterConfig = new RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RateLimiterConfig indexRateLimiterConfig = new RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy SolrZkClient */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    int numDocs = 10000;\n\n    processTest(client, numDocs, 400 /* Number of queries */);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","sourceOld":"  @Nightly\n  public void testSlotBorrowing() throws Exception {\n    CloudSolrClient client = cluster.getSolrClient();\n    client.setDefaultCollection(SECOND_COLLECTION);\n\n    CollectionAdminRequest.createCollection(SECOND_COLLECTION, 1, 1).process(client);\n    cluster.waitForActiveCollection(SECOND_COLLECTION, 1, 1);\n\n    SolrDispatchFilter solrDispatchFilter = cluster.getJettySolrRunner(0).getSolrDispatchFilter();\n\n    RequestRateLimiter.RateLimiterConfig queryRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.QUERY,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    RequestRateLimiter.RateLimiterConfig indexRateLimiterConfig = new RequestRateLimiter.RateLimiterConfig(SolrRequest.SolrRequestType.UPDATE,\n        true, 1, DEFAULT_SLOT_ACQUISITION_TIMEOUT_MS, 5 /* allowedRequests */, true /* isSlotBorrowing */);\n    // We are fine with a null FilterConfig here since we ensure that MockBuilder never invokes its parent\n    RateLimitManager.Builder builder = new MockBuilder(null /*dummy FilterConfig */, new MockRequestRateLimiter(queryRateLimiterConfig, 5), new MockRequestRateLimiter(indexRateLimiterConfig, 5));\n    RateLimitManager rateLimitManager = builder.build();\n\n    solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n\n    int numDocs = 10000;\n\n    processTest(client, numDocs, 400 /* Number of queries */);\n\n    MockRequestRateLimiter mockIndexRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.UPDATE);\n\n    assertTrue(\"Incoming slots borrowed count did not match. Expected > 0  incoming \" + mockIndexRateLimiter.borrowedSlotCount.get(),\n        mockIndexRateLimiter.borrowedSlotCount.get() > 0);\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"2460e6297ab2074eb39fc76a9806e0a0b640c88c":["4d8de9b037ea3dd378609f4eb4d229334680d60d"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"4d8de9b037ea3dd378609f4eb4d229334680d60d":["0fb0add11bccdea6f8a289cec694aa9f3895ef4e"],"c99002731351c8c955238845b0038682148eec53":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"0fb0add11bccdea6f8a289cec694aa9f3895ef4e":["c99002731351c8c955238845b0038682148eec53"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["2460e6297ab2074eb39fc76a9806e0a0b640c88c"]},"commit2Childs":{"2460e6297ab2074eb39fc76a9806e0a0b640c88c":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["c99002731351c8c955238845b0038682148eec53"],"4d8de9b037ea3dd378609f4eb4d229334680d60d":["2460e6297ab2074eb39fc76a9806e0a0b640c88c"],"c99002731351c8c955238845b0038682148eec53":["0fb0add11bccdea6f8a289cec694aa9f3895ef4e"],"0fb0add11bccdea6f8a289cec694aa9f3895ef4e":["4d8de9b037ea3dd378609f4eb4d229334680d60d"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}