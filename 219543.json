{"path":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","commits":[{"id":"abb23fcc2461782ab204e61213240feb77d355aa","date":1422029612,"type":1,"author":"Erick Erickson","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#doTest().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","sourceOld":"  @Override\n  public void doTest() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"84bc0ab6faa849a8e6667f3bce45874b858d44c9","date":1427871306,"type":3,"author":"Varun Thacker","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"0c924d4069ef5a5bc479a493befe0121aada6896","date":1427901860,"type":3,"author":"Robert Muir","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4d048016075a0b8589fcfc77fdf8e2a29fc80964","date":1494631326,"type":3,"author":"Steve Rowe","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"e9017cf144952056066919f1ebc7897ff9bd71b1","date":1496757600,"type":3,"author":"Shalin Shekhar Mangar","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"5\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"50\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"4\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"10\", \"test_tl\", \"100\", \"test_tf\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_ti\", \"1\",  \"test_tl\", \"100000\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_ti\", \"2\",  \"test_tl\", \"100000\", \"test_tf\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1000\", \"test_tl\", \"1005\", \"test_tf\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1500\", \"test_tl\", \"1001\", \"test_tf\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_ti\", \"1300\", \"test_tl\", \"1002\", \"test_tf\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"15\",  \"test_tl\", \"10\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"16\",  \"test_tl\", \"9\", \"test_tf\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_ti\", \"1\",  \"test_tl\", \"20\", \"test_tf\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_ti:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_ti:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"expand.sort\", \"test_tl desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_ti)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_tl desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_ti)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"a71f63026529f3c1f03cfdd664910873ab2369ae","date":1497543264,"type":3,"author":"Chris Hostetter","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9","date":1498028748,"type":3,"author":"Shalin Shekhar Mangar","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"28288370235ed02234a64753cdbf0c6ec096304a","date":1498726817,"type":3,"author":"Karl Wright","isMerge":true,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7.0\", \"1.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8.0\", \"5.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9.0\", \"11.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14.0\", \"12.0\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14.0\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1.0\", \"7.0\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5.0\", \"8.0\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11.0\", \"9.0\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12.0\", \"14.0\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"97473b7232d88686879e8d72210e5e2ad71bfcd1","date":1566274445,"type":3,"author":"Munendra S N","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    ignoreException(\"missing expand field\");\n    SolrException e = expectThrows(SolrException.class, () -> query(\"q\", \"*:*\", \"expand\", \"true\"));\n    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n    assertTrue(e.getMessage().contains(\"missing expand field\"));\n    resetExceptionIgnores();\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"93c255ee5a354a24c9d163acebc0457234aed8db","date":1584503584,"type":3,"author":"ameliahenderson","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    ignoreException(\"missing expand field\");\n    SolrException e = expectThrows(SolrException.class, () -> query(\"q\", \"*:*\", \"expand\", \"true\"));\n    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n    assertTrue(e.getMessage().contains(\"missing expand field\"));\n    resetExceptionIgnores();\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n    //Test expand.rows = 0 - no docs only expand count\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group2\", 0, results);\n    assertExpandGroupCountAndOrder(\"group3\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test expand.rows = 0 with expand.field\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"test_l:10\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.fq\", \"test_f:2000\");\n    params.add(\"expand.field\", group);\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id,score\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    ignoreException(\"missing expand field\");\n    SolrException e = expectThrows(SolrException.class, () -> query(\"q\", \"*:*\", \"expand\", \"true\"));\n    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n    assertTrue(e.getMessage().contains(\"missing expand field\"));\n    resetExceptionIgnores();\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"820a47b6a19467558c5c4eb4ff340c4bb224fd71","date":1585374825,"type":3,"author":"Munendra S N","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","pathOld":"solr/core/src/test/org/apache/solr/handler/component/DistributedExpandComponentTest#test().mjava","sourceNew":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n    // multiple collapse and equal cost\n    ModifiableSolrParams baseParams = params(\"q\", \"*:*\", \"defType\", \"edismax\", \"expand\", \"true\", \"fl\", \"*,score\",\n        \"bf\", \"field(test_i)\", \"expand.sort\", \"id asc\");\n    baseParams.set(\"fq\", \"{!collapse field=\"+group+\"}\", \"{!collapse field=test_i}\");\n    query(baseParams);\n\n    // multiple collapse and unequal cost case1\n    baseParams.set(\"fq\", \"{!collapse cost=1000 field=\"+group+\"}\", \"{!collapse cost=2000 field=test_i}\");\n    query(baseParams);\n\n    // multiple collapse and unequal cost case2\n    baseParams.set(\"fq\", \"{!collapse cost=1000 field=\"+group+\"}\", \"{!collapse cost=200 field=test_i}\");\n    query(baseParams);\n\n    ignoreException(\"missing expand field\");\n    SolrException e = expectThrows(SolrException.class, () -> query(\"q\", \"*:*\", \"expand\", \"true\"));\n    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n    assertTrue(e.getMessage().contains(\"missing expand field\"));\n    resetExceptionIgnores();\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n    //Test expand.rows = 0 - no docs only expand count\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group2\", 0, results);\n    assertExpandGroupCountAndOrder(\"group3\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test expand.rows = 0 with expand.field\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"test_l:10\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.fq\", \"test_f:2000\");\n    params.add(\"expand.field\", group);\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id,score\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","sourceOld":"  @Test\n  @ShardsFixed(num = 3)\n  public void test() throws Exception {\n    final String group = (random().nextBoolean() ? \"group_s\" : \"group_s_dv\");\n    \n    del(\"*:*\");\n\n    index_specific(0,\"id\",\"1\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"5\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(0,\"id\",\"2\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"50\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(1,\"id\",\"5\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"4\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"6\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"10\", \"test_l\", \"100\", \"test_f\", \"200\");\n    index_specific(0,\"id\",\"7\", \"term_s\", \"YYYY\", group, \"group1\", \"test_i\", \"1\",  \"test_l\", \"100000\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"8\", \"term_s\", \"YYYY\", group, \"group2\", \"test_i\", \"2\",  \"test_l\", \"100000\", \"test_f\", \"200\");\n    index_specific(2,\"id\",\"9\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1000\", \"test_l\", \"1005\", \"test_f\", \"3000\");\n    index_specific(2, \"id\", \"10\", \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1500\", \"test_l\", \"1001\", \"test_f\", \"3200\");\n    index_specific(2,\"id\", \"11\",  \"term_s\", \"YYYY\", group, \"group3\", \"test_i\", \"1300\", \"test_l\", \"1002\", \"test_f\", \"3300\");\n    index_specific(1,\"id\",\"12\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"15\",  \"test_l\", \"10\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"13\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"16\",  \"test_l\", \"9\", \"test_f\", \"2000\");\n    index_specific(1,\"id\",\"14\", \"term_s\", \"YYYY\", group, \"group4\", \"test_i\", \"1\",  \"test_l\", \"20\", \"test_f\", \"2000\");\n\n\n    commit();\n\n\n    handle.put(\"explain\", SKIPVAL);\n    handle.put(\"timestamp\", SKIPVAL);\n    handle.put(\"score\", SKIPVAL);\n    handle.put(\"wt\", SKIP);\n    handle.put(\"distrib\", SKIP);\n    handle.put(\"shards.qt\", SKIP);\n    handle.put(\"shards\", SKIP);\n    handle.put(\"q\", SKIP);\n    handle.put(\"maxScore\", SKIPVAL);\n    handle.put(\"_version_\", SKIP);\n    handle.put(\"expanded\", UNORDERED);\n\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"fl\",\"*,score\");\n    query(\"q\", \"*:*\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test no expand results\n    query(\"q\", \"test_i:5\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test zero results\n    query(\"q\", \"test_i:5434343\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"expand.sort\", \"test_l desc\", \"expand.rows\", \"1\", \"fl\",\"*,score\");\n    //Test page 2\n    query(\"q\", \"*:*\", \"start\",\"1\", \"rows\", \"1\", \"fq\", \"{!collapse field=\"+group+\"}\", \"defType\", \"edismax\", \"bf\", \"field(test_i)\", \"expand\", \"true\", \"fl\",\"*,score\");\n\n\n    ignoreException(\"missing expand field\");\n    SolrException e = expectThrows(SolrException.class, () -> query(\"q\", \"*:*\", \"expand\", \"true\"));\n    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n    assertTrue(e.getMessage().contains(\"missing expand field\"));\n    resetExceptionIgnores();\n\n    //First basic test case.\n    ModifiableSolrParams params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n\n    setDistributedParams(params);\n    QueryResponse rsp = queryServer(params);\n    Map<String, SolrDocumentList> results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n\n    //Test expand.sort\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"7\", \"1\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"8\", \"5\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"9\", \"11\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"14\", \"12\");\n\n\n    //Test expand.rows\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.sort\", \"test_l desc\");\n    params.add(\"expand.rows\", \"1\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 1, results, \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 1, results, \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 1, results, \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 1, results, \"14\");\n\n    //Test expand.rows = 0 - no docs only expand count\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group2\", 0, results);\n    assertExpandGroupCountAndOrder(\"group3\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test expand.rows = 0 with expand.field\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"test_l:10\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"expand\", \"true\");\n    params.add(\"expand.fq\", \"test_f:2000\");\n    params.add(\"expand.field\", group);\n    params.add(\"expand.rows\", \"0\");\n    params.add(\"fl\", \"id,score\");\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 0, results);\n    assertExpandGroupCountAndOrder(\"group4\", 0, results);\n\n    //Test key-only fl\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"fl\", \"id\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n    //Test distrib.singlePass true\n\n    params = new ModifiableSolrParams();\n    params.add(\"q\", \"*:*\");\n    params.add(\"fq\", \"{!collapse field=\"+group+\"}\");\n    params.add(\"defType\", \"edismax\");\n    params.add(\"bf\", \"field(test_i)\");\n    params.add(\"expand\", \"true\");\n    params.add(\"distrib.singlePass\", \"true\");\n\n    setDistributedParams(params);\n    rsp = queryServer(params);\n    results = rsp.getExpandedResults();\n    assertExpandGroups(results, \"group1\",\"group2\", \"group3\", \"group4\");\n    assertExpandGroupCountAndOrder(\"group1\", 2, results, \"1\", \"7\");\n    assertExpandGroupCountAndOrder(\"group2\", 2, results, \"5\", \"8\");\n    assertExpandGroupCountAndOrder(\"group3\", 2, results, \"11\", \"9\");\n    assertExpandGroupCountAndOrder(\"group4\", 2, results, \"12\", \"14\");\n\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"84bc0ab6faa849a8e6667f3bce45874b858d44c9":["abb23fcc2461782ab204e61213240feb77d355aa"],"820a47b6a19467558c5c4eb4ff340c4bb224fd71":["93c255ee5a354a24c9d163acebc0457234aed8db"],"97473b7232d88686879e8d72210e5e2ad71bfcd1":["28288370235ed02234a64753cdbf0c6ec096304a"],"4d048016075a0b8589fcfc77fdf8e2a29fc80964":["84bc0ab6faa849a8e6667f3bce45874b858d44c9"],"abb23fcc2461782ab204e61213240feb77d355aa":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"a71f63026529f3c1f03cfdd664910873ab2369ae":["4d048016075a0b8589fcfc77fdf8e2a29fc80964"],"28288370235ed02234a64753cdbf0c6ec096304a":["4d048016075a0b8589fcfc77fdf8e2a29fc80964","a71f63026529f3c1f03cfdd664910873ab2369ae"],"0c924d4069ef5a5bc479a493befe0121aada6896":["abb23fcc2461782ab204e61213240feb77d355aa","84bc0ab6faa849a8e6667f3bce45874b858d44c9"],"e9017cf144952056066919f1ebc7897ff9bd71b1":["84bc0ab6faa849a8e6667f3bce45874b858d44c9","4d048016075a0b8589fcfc77fdf8e2a29fc80964"],"93c255ee5a354a24c9d163acebc0457234aed8db":["97473b7232d88686879e8d72210e5e2ad71bfcd1"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9":["e9017cf144952056066919f1ebc7897ff9bd71b1","a71f63026529f3c1f03cfdd664910873ab2369ae"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["820a47b6a19467558c5c4eb4ff340c4bb224fd71"]},"commit2Childs":{"84bc0ab6faa849a8e6667f3bce45874b858d44c9":["4d048016075a0b8589fcfc77fdf8e2a29fc80964","0c924d4069ef5a5bc479a493befe0121aada6896","e9017cf144952056066919f1ebc7897ff9bd71b1"],"820a47b6a19467558c5c4eb4ff340c4bb224fd71":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"97473b7232d88686879e8d72210e5e2ad71bfcd1":["93c255ee5a354a24c9d163acebc0457234aed8db"],"abb23fcc2461782ab204e61213240feb77d355aa":["84bc0ab6faa849a8e6667f3bce45874b858d44c9","0c924d4069ef5a5bc479a493befe0121aada6896"],"4d048016075a0b8589fcfc77fdf8e2a29fc80964":["a71f63026529f3c1f03cfdd664910873ab2369ae","28288370235ed02234a64753cdbf0c6ec096304a","e9017cf144952056066919f1ebc7897ff9bd71b1"],"a71f63026529f3c1f03cfdd664910873ab2369ae":["28288370235ed02234a64753cdbf0c6ec096304a","2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9"],"28288370235ed02234a64753cdbf0c6ec096304a":["97473b7232d88686879e8d72210e5e2ad71bfcd1"],"0c924d4069ef5a5bc479a493befe0121aada6896":[],"e9017cf144952056066919f1ebc7897ff9bd71b1":["2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9"],"93c255ee5a354a24c9d163acebc0457234aed8db":["820a47b6a19467558c5c4eb4ff340c4bb224fd71"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["abb23fcc2461782ab204e61213240feb77d355aa"],"2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["0c924d4069ef5a5bc479a493befe0121aada6896","2a3ed3f77cdd034e789d00d1ca8bb7054c9fb8e9","cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}