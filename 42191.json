{"path":"lucene/src/test/org/apache/lucene/util/fst/TestFSTs.VisitTerms#run(int,boolean,boolean).mjava","commits":[{"id":"f04dea8ce9675dc75eb2483feb840a86f765fb82","date":1328049049,"type":1,"author":"Michael McCandless","isMerge":false,"pathNew":"lucene/src/test/org/apache/lucene/util/fst/TestFSTs.VisitTerms#run(int,boolean,boolean).mjava","pathOld":"lucene/src/test/org/apache/lucene/util/fst/TestFSTs.VisitTerms#run(int,boolean).mjava","sourceNew":"    public void run(int limit, boolean verify, boolean verifyByOutput) throws IOException {\n      BufferedReader is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n      try {\n        final IntsRef intsRef = new IntsRef(10);\n        long tStart = System.currentTimeMillis();\n        int ord = 0;\n        while(true) {\n          String w = is.readLine();\n          if (w == null) {\n            break;\n          }\n          toIntsRef(w, inputMode, intsRef);\n          builder.add(intsRef,\n                      getOutput(intsRef, ord));\n\n          ord++;\n          if (ord % 500000 == 0) {\n            System.out.println(\n                String.format(Locale.ENGLISH, \n                    \"%6.2fs: %9d...\", ((System.currentTimeMillis() - tStart) / 1000.0), ord));\n          }\n          if (ord >= limit) {\n            break;\n          }\n        }\n\n        assert builder.getTermCount() == ord;\n        FST<T> fst = builder.finish();\n        if (fst == null) {\n          System.out.println(\"FST was fully pruned!\");\n          System.exit(0);\n        }\n\n        if (dirOut == null) {\n          return;\n        }\n\n        System.out.println(ord + \" terms; \" + fst.getNodeCount() + \" nodes; \" + fst.getArcCount() + \" arcs; \" + fst.getArcWithOutputCount() + \" arcs w/ output; tot size \" + fst.sizeInBytes());\n        if (fst.getNodeCount() < 100) {\n          Writer w = new OutputStreamWriter(new FileOutputStream(\"out.dot\"), \"UTF-8\");\n          Util.toDot(fst, w, false, false);\n          w.close();\n          System.out.println(\"Wrote FST to out.dot\");\n        }\n\n        if (doPack) {\n          System.out.println(\"Pack...\");\n          fst = fst.pack(4, 100000000);\n          System.out.println(\"New size \" + fst.sizeInBytes() + \" bytes\");\n        }\n        \n        Directory dir = FSDirectory.open(new File(dirOut));\n        IndexOutput out = dir.createOutput(\"fst.bin\", IOContext.DEFAULT);\n        fst.save(out);\n        out.close();\n        System.out.println(\"Saved FST to fst.bin.\");\n\n        if (!verify) {\n          return;\n        }\n\n        System.out.println(\"\\nNow verify...\");\n\n        while(true) {\n          for(int iter=0;iter<2;iter++) {\n            is.close();\n            is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n\n            ord = 0;\n            tStart = System.currentTimeMillis();\n            while(true) {\n              String w = is.readLine();\n              if (w == null) {\n                break;\n              }\n              toIntsRef(w, inputMode, intsRef);\n              if (iter == 0) {\n                T expected = getOutput(intsRef, ord);\n                T actual = Util.get(fst, intsRef);\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null output on input=\" + w);\n                }\n                if (!actual.equals(expected)) {\n                  throw new RuntimeException(\"wrong output (got \" + outputs.outputToString(actual) + \" but expected \" + outputs.outputToString(expected) + \") on input=\" + w);\n                }\n              } else {\n                // Get by output\n                final Long output = (Long) getOutput(intsRef, ord);\n                @SuppressWarnings(\"unchecked\") final IntsRef actual = Util.getByOutput((FST<Long>) fst, output.longValue());\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null input from output=\" + output);\n                }\n                if (!actual.equals(intsRef)) {\n                  throw new RuntimeException(\"wrong input (got \" + actual + \" but expected \" + intsRef + \" from output=\" + output);\n                }\n              }\n\n              ord++;\n              if (ord % 500000 == 0) {\n                System.out.println(((System.currentTimeMillis()-tStart)/1000.0) + \"s: \" + ord + \"...\");\n              }\n              if (ord >= limit) {\n                break;\n              }\n            }\n\n            double totSec = ((System.currentTimeMillis() - tStart)/1000.0);\n            System.out.println(\"Verify \" + (iter == 1 ? \"(by output) \" : \"\") + \"took \" + totSec + \" sec + (\" + (int) ((totSec*1000000000/ord)) + \" nsec per lookup)\");\n\n            if (!verifyByOutput) {\n              break;\n            }\n          }\n\n          // NOTE: comment out to profile lookup...\n          break;\n        }\n\n      } finally {\n        is.close();\n      }\n    }\n\n","sourceOld":"    public void run(int limit, boolean verify) throws IOException {\n      BufferedReader is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n      try {\n        final IntsRef intsRef = new IntsRef(10);\n        long tStart = System.currentTimeMillis();\n        int ord = 0;\n        while(true) {\n          String w = is.readLine();\n          if (w == null) {\n            break;\n          }\n          toIntsRef(w, inputMode, intsRef);\n          builder.add(intsRef,\n                      getOutput(intsRef, ord));\n\n          ord++;\n          if (ord % 500000 == 0) {\n            System.out.println(\n                String.format(Locale.ENGLISH, \n                    \"%6.2fs: %9d...\", ((System.currentTimeMillis() - tStart) / 1000.0), ord));\n          }\n          if (ord >= limit) {\n            break;\n          }\n        }\n\n        assert builder.getTermCount() == ord;\n        FST<T> fst = builder.finish();\n        if (fst == null) {\n          System.out.println(\"FST was fully pruned!\");\n          System.exit(0);\n        }\n\n        if (dirOut == null) {\n          return;\n        }\n\n        System.out.println(ord + \" terms; \" + fst.getNodeCount() + \" nodes; \" + fst.getArcCount() + \" arcs; \" + fst.getArcWithOutputCount() + \" arcs w/ output; tot size \" + fst.sizeInBytes());\n        if (fst.getNodeCount() < 100) {\n          Writer w = new OutputStreamWriter(new FileOutputStream(\"out.dot\"), \"UTF-8\");\n          Util.toDot(fst, w, false, false);\n          w.close();\n          System.out.println(\"Wrote FST to out.dot\");\n        }\n\n        if (doPack) {\n          System.out.println(\"Pack...\");\n          fst = fst.pack(4, 100000000);\n          System.out.println(\"New size \" + fst.sizeInBytes() + \" bytes\");\n        }\n        \n        Directory dir = FSDirectory.open(new File(dirOut));\n        IndexOutput out = dir.createOutput(\"fst.bin\", IOContext.DEFAULT);\n        fst.save(out);\n        out.close();\n        System.out.println(\"Saved FST to fst.bin.\");\n\n        if (!verify) {\n          return;\n        }\n\n        System.out.println(\"\\nNow verify...\");\n\n        while(true) {\n          is.close();\n          is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n\n          ord = 0;\n          tStart = System.currentTimeMillis();\n          while(true) {\n            String w = is.readLine();\n            if (w == null) {\n              break;\n            }\n            toIntsRef(w, inputMode, intsRef);\n            T expected = getOutput(intsRef, ord);\n            T actual = Util.get(fst, intsRef);\n            if (actual == null) {\n              throw new RuntimeException(\"unexpected null output on input=\" + w);\n            }\n            if (!actual.equals(expected)) {\n              throw new RuntimeException(\"wrong output (got \" + outputs.outputToString(actual) + \" but expected \" + outputs.outputToString(expected) + \") on input=\" + w);\n            }\n\n            ord++;\n            if (ord % 500000 == 0) {\n              System.out.println(((System.currentTimeMillis()-tStart)/1000.0) + \"s: \" + ord + \"...\");\n            }\n            if (ord >= limit) {\n              break;\n            }\n          }\n\n          double totSec = ((System.currentTimeMillis() - tStart)/1000.0);\n          System.out.println(\"Verify took \" + totSec + \" sec + (\" + (int) ((totSec*1000000000/ord)) + \" nsec per lookup)\");\n\n          // NOTE: comment out to profile lookup...\n          break;\n        }\n\n      } finally {\n        is.close();\n      }\n    }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"3a119bbc8703c10faa329ec201c654b3a35a1e3e","date":1328644745,"type":5,"author":"Steven Rowe","isMerge":false,"pathNew":"lucene/core/src/test/org/apache/lucene/util/fst/TestFSTs.VisitTerms#run(int,boolean,boolean).mjava","pathOld":"lucene/src/test/org/apache/lucene/util/fst/TestFSTs.VisitTerms#run(int,boolean,boolean).mjava","sourceNew":"    public void run(int limit, boolean verify, boolean verifyByOutput) throws IOException {\n      BufferedReader is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n      try {\n        final IntsRef intsRef = new IntsRef(10);\n        long tStart = System.currentTimeMillis();\n        int ord = 0;\n        while(true) {\n          String w = is.readLine();\n          if (w == null) {\n            break;\n          }\n          toIntsRef(w, inputMode, intsRef);\n          builder.add(intsRef,\n                      getOutput(intsRef, ord));\n\n          ord++;\n          if (ord % 500000 == 0) {\n            System.out.println(\n                String.format(Locale.ENGLISH, \n                    \"%6.2fs: %9d...\", ((System.currentTimeMillis() - tStart) / 1000.0), ord));\n          }\n          if (ord >= limit) {\n            break;\n          }\n        }\n\n        assert builder.getTermCount() == ord;\n        FST<T> fst = builder.finish();\n        if (fst == null) {\n          System.out.println(\"FST was fully pruned!\");\n          System.exit(0);\n        }\n\n        if (dirOut == null) {\n          return;\n        }\n\n        System.out.println(ord + \" terms; \" + fst.getNodeCount() + \" nodes; \" + fst.getArcCount() + \" arcs; \" + fst.getArcWithOutputCount() + \" arcs w/ output; tot size \" + fst.sizeInBytes());\n        if (fst.getNodeCount() < 100) {\n          Writer w = new OutputStreamWriter(new FileOutputStream(\"out.dot\"), \"UTF-8\");\n          Util.toDot(fst, w, false, false);\n          w.close();\n          System.out.println(\"Wrote FST to out.dot\");\n        }\n\n        if (doPack) {\n          System.out.println(\"Pack...\");\n          fst = fst.pack(4, 100000000);\n          System.out.println(\"New size \" + fst.sizeInBytes() + \" bytes\");\n        }\n        \n        Directory dir = FSDirectory.open(new File(dirOut));\n        IndexOutput out = dir.createOutput(\"fst.bin\", IOContext.DEFAULT);\n        fst.save(out);\n        out.close();\n        System.out.println(\"Saved FST to fst.bin.\");\n\n        if (!verify) {\n          return;\n        }\n\n        System.out.println(\"\\nNow verify...\");\n\n        while(true) {\n          for(int iter=0;iter<2;iter++) {\n            is.close();\n            is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n\n            ord = 0;\n            tStart = System.currentTimeMillis();\n            while(true) {\n              String w = is.readLine();\n              if (w == null) {\n                break;\n              }\n              toIntsRef(w, inputMode, intsRef);\n              if (iter == 0) {\n                T expected = getOutput(intsRef, ord);\n                T actual = Util.get(fst, intsRef);\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null output on input=\" + w);\n                }\n                if (!actual.equals(expected)) {\n                  throw new RuntimeException(\"wrong output (got \" + outputs.outputToString(actual) + \" but expected \" + outputs.outputToString(expected) + \") on input=\" + w);\n                }\n              } else {\n                // Get by output\n                final Long output = (Long) getOutput(intsRef, ord);\n                @SuppressWarnings(\"unchecked\") final IntsRef actual = Util.getByOutput((FST<Long>) fst, output.longValue());\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null input from output=\" + output);\n                }\n                if (!actual.equals(intsRef)) {\n                  throw new RuntimeException(\"wrong input (got \" + actual + \" but expected \" + intsRef + \" from output=\" + output);\n                }\n              }\n\n              ord++;\n              if (ord % 500000 == 0) {\n                System.out.println(((System.currentTimeMillis()-tStart)/1000.0) + \"s: \" + ord + \"...\");\n              }\n              if (ord >= limit) {\n                break;\n              }\n            }\n\n            double totSec = ((System.currentTimeMillis() - tStart)/1000.0);\n            System.out.println(\"Verify \" + (iter == 1 ? \"(by output) \" : \"\") + \"took \" + totSec + \" sec + (\" + (int) ((totSec*1000000000/ord)) + \" nsec per lookup)\");\n\n            if (!verifyByOutput) {\n              break;\n            }\n          }\n\n          // NOTE: comment out to profile lookup...\n          break;\n        }\n\n      } finally {\n        is.close();\n      }\n    }\n\n","sourceOld":"    public void run(int limit, boolean verify, boolean verifyByOutput) throws IOException {\n      BufferedReader is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n      try {\n        final IntsRef intsRef = new IntsRef(10);\n        long tStart = System.currentTimeMillis();\n        int ord = 0;\n        while(true) {\n          String w = is.readLine();\n          if (w == null) {\n            break;\n          }\n          toIntsRef(w, inputMode, intsRef);\n          builder.add(intsRef,\n                      getOutput(intsRef, ord));\n\n          ord++;\n          if (ord % 500000 == 0) {\n            System.out.println(\n                String.format(Locale.ENGLISH, \n                    \"%6.2fs: %9d...\", ((System.currentTimeMillis() - tStart) / 1000.0), ord));\n          }\n          if (ord >= limit) {\n            break;\n          }\n        }\n\n        assert builder.getTermCount() == ord;\n        FST<T> fst = builder.finish();\n        if (fst == null) {\n          System.out.println(\"FST was fully pruned!\");\n          System.exit(0);\n        }\n\n        if (dirOut == null) {\n          return;\n        }\n\n        System.out.println(ord + \" terms; \" + fst.getNodeCount() + \" nodes; \" + fst.getArcCount() + \" arcs; \" + fst.getArcWithOutputCount() + \" arcs w/ output; tot size \" + fst.sizeInBytes());\n        if (fst.getNodeCount() < 100) {\n          Writer w = new OutputStreamWriter(new FileOutputStream(\"out.dot\"), \"UTF-8\");\n          Util.toDot(fst, w, false, false);\n          w.close();\n          System.out.println(\"Wrote FST to out.dot\");\n        }\n\n        if (doPack) {\n          System.out.println(\"Pack...\");\n          fst = fst.pack(4, 100000000);\n          System.out.println(\"New size \" + fst.sizeInBytes() + \" bytes\");\n        }\n        \n        Directory dir = FSDirectory.open(new File(dirOut));\n        IndexOutput out = dir.createOutput(\"fst.bin\", IOContext.DEFAULT);\n        fst.save(out);\n        out.close();\n        System.out.println(\"Saved FST to fst.bin.\");\n\n        if (!verify) {\n          return;\n        }\n\n        System.out.println(\"\\nNow verify...\");\n\n        while(true) {\n          for(int iter=0;iter<2;iter++) {\n            is.close();\n            is = new BufferedReader(new InputStreamReader(new FileInputStream(wordsFileIn), \"UTF-8\"), 65536);\n\n            ord = 0;\n            tStart = System.currentTimeMillis();\n            while(true) {\n              String w = is.readLine();\n              if (w == null) {\n                break;\n              }\n              toIntsRef(w, inputMode, intsRef);\n              if (iter == 0) {\n                T expected = getOutput(intsRef, ord);\n                T actual = Util.get(fst, intsRef);\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null output on input=\" + w);\n                }\n                if (!actual.equals(expected)) {\n                  throw new RuntimeException(\"wrong output (got \" + outputs.outputToString(actual) + \" but expected \" + outputs.outputToString(expected) + \") on input=\" + w);\n                }\n              } else {\n                // Get by output\n                final Long output = (Long) getOutput(intsRef, ord);\n                @SuppressWarnings(\"unchecked\") final IntsRef actual = Util.getByOutput((FST<Long>) fst, output.longValue());\n                if (actual == null) {\n                  throw new RuntimeException(\"unexpected null input from output=\" + output);\n                }\n                if (!actual.equals(intsRef)) {\n                  throw new RuntimeException(\"wrong input (got \" + actual + \" but expected \" + intsRef + \" from output=\" + output);\n                }\n              }\n\n              ord++;\n              if (ord % 500000 == 0) {\n                System.out.println(((System.currentTimeMillis()-tStart)/1000.0) + \"s: \" + ord + \"...\");\n              }\n              if (ord >= limit) {\n                break;\n              }\n            }\n\n            double totSec = ((System.currentTimeMillis() - tStart)/1000.0);\n            System.out.println(\"Verify \" + (iter == 1 ? \"(by output) \" : \"\") + \"took \" + totSec + \" sec + (\" + (int) ((totSec*1000000000/ord)) + \" nsec per lookup)\");\n\n            if (!verifyByOutput) {\n              break;\n            }\n          }\n\n          // NOTE: comment out to profile lookup...\n          break;\n        }\n\n      } finally {\n        is.close();\n      }\n    }\n\n","bugFix":null,"bugIntro":[],"isBuggy":true,"nexts":[],"revCommit":null}],"commit2Parents":{"3a119bbc8703c10faa329ec201c654b3a35a1e3e":["f04dea8ce9675dc75eb2483feb840a86f765fb82"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["3a119bbc8703c10faa329ec201c654b3a35a1e3e"],"f04dea8ce9675dc75eb2483feb840a86f765fb82":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"]},"commit2Childs":{"3a119bbc8703c10faa329ec201c654b3a35a1e3e":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["f04dea8ce9675dc75eb2483feb840a86f765fb82"],"f04dea8ce9675dc75eb2483feb840a86f765fb82":["3a119bbc8703c10faa329ec201c654b3a35a1e3e"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}