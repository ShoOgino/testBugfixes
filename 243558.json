{"path":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","commits":[{"id":"02c6a0e240c698414e7728a55f07361be84852d8","date":1392675457,"type":0,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","pathOld":"/dev/null","sourceNew":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    boolean shouldFail = false;\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkForLegalDiff(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return shouldFail;\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"35cbf075846889e7dab27a7ad7f0b62225ba66cf","date":1397251910,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","pathOld":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","sourceNew":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkForLegalDiff(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return true;\n  }\n\n","sourceOld":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    boolean shouldFail = false;\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkForLegalDiff(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return shouldFail;\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"35b47293d52729d80d78492b2aeda6e45d5a42f1","date":1397788632,"type":3,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","pathOld":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","sourceNew":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkIfDiffIsLegal(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return true;\n  }\n\n","sourceOld":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkForLegalDiff(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return true;\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null},{"id":"4339eef0c1b12030c8590187e652cd1cd0a1f3cb","date":1397833225,"type":5,"author":"Mark Robert Miller","isMerge":false,"pathNew":"solr/test-framework/src/java/org/apache/solr/cloud/CloudInspectUtil#compareResults(SolrServer,SolrServer,Set[String],Set[String]).mjava","pathOld":"solr/test-framework/src/java/org/apache/solr/cloud/AbstractFullDistribZkTestBase#compareResults(long,long,Set[String],Set[String]).mjava","sourceNew":"  /**\n   * Compares the results of the control and cloud clients.\n   * \n   * @return true if the compared results are illegal.\n   */\n  public static boolean compareResults(SolrServer controlServer, SolrServer cloudServer, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    \n    SolrParams q = SolrTestCaseJ4.params(\"q\",\"*:*\",\"rows\",\"0\", \"tests\",\"checkShardConsistency(vsControl)\");    // add a tag to aid in debugging via logs\n\n    SolrDocumentList controlDocList = controlServer.query(q).getResults();\n    long controlDocs = controlDocList.getNumFound();\n\n    SolrDocumentList cloudDocList = cloudServer.query(q).getResults();\n    long cloudClientDocs = cloudDocList.getNumFound();\n    \n    // re-execute the query getting ids\n    q = SolrTestCaseJ4.params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlServer.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudServer.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (controlDocs != cloudClientDocs && (addFails != null || deleteFails != null)) {\n      boolean legal = CloudInspectUtil.checkIfDiffIsLegal(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = CloudInspectUtil.showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = SolrTestCaseJ4.params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlServer.query(q).getResults();\n      SolrDocumentList b = cloudServer.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return true;\n  }\n\n","sourceOld":"  protected boolean compareResults(long controlDocs, long cloudClientDocs, Set<String> addFails, Set<String> deleteFails)\n      throws SolrServerException {\n    SolrParams q;\n    SolrDocumentList controlDocList;\n    SolrDocumentList cloudDocList;\n    // re-execute the query getting ids\n    q = params(\"q\",\"*:*\",\"rows\",\"100000\", \"fl\",\"id\", \"tests\",\"checkShardConsistency(vsControl)/getIds\");    // add a tag to aid in debugging via logs\n    controlDocList = controlClient.query(q).getResults();\n    if (controlDocs != controlDocList.getNumFound()) {\n      log.error(\"Something changed! control now \" + controlDocList.getNumFound());\n    };\n\n    cloudDocList = cloudClient.query(q).getResults();\n    if (cloudClientDocs != cloudDocList.getNumFound()) {\n      log.error(\"Something changed! cloudClient now \" + cloudDocList.getNumFound());\n    };\n\n    if (addFails != null || deleteFails != null) {\n      boolean legal = checkIfDiffIsLegal(controlDocList, cloudDocList,\n          \"controlDocList\", \"cloudDocList\", addFails, deleteFails);\n      if (legal) {\n        return false;\n      }\n    }\n    \n    Set<Map> differences = showDiff(controlDocList, cloudDocList,\n        \"controlDocList\", \"cloudDocList\");\n\n    // get versions for the mismatched ids\n    boolean foundId = false;\n    StringBuilder ids = new StringBuilder(\"id:(\");\n    for (Map doc : differences) {\n      ids.append(\" \"+doc.get(\"id\"));\n      foundId = true;\n    }\n    ids.append(\")\");\n    \n    if (foundId) {\n      // get versions for those ids that don't match\n      q = params(\"q\", ids.toString(), \"rows\", \"100000\", \"fl\", \"id,_version_\",\n          \"sort\", \"id asc\", \"tests\",\n          \"checkShardConsistency(vsControl)/getVers\"); // add a tag to aid in\n                                                       // debugging via logs\n      \n      SolrDocumentList a = controlClient.query(q).getResults();\n      SolrDocumentList b = cloudClient.query(q).getResults();\n      \n      log.error(\"controlClient :\" + a + \"\\n\\tcloudClient :\" + b);\n    }\n    \n    return true;\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":false,"nexts":[],"revCommit":null}],"commit2Parents":{"35cbf075846889e7dab27a7ad7f0b62225ba66cf":["02c6a0e240c698414e7728a55f07361be84852d8"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"4339eef0c1b12030c8590187e652cd1cd0a1f3cb":["35b47293d52729d80d78492b2aeda6e45d5a42f1"],"02c6a0e240c698414e7728a55f07361be84852d8":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"35b47293d52729d80d78492b2aeda6e45d5a42f1":["35cbf075846889e7dab27a7ad7f0b62225ba66cf"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["4339eef0c1b12030c8590187e652cd1cd0a1f3cb"]},"commit2Childs":{"35cbf075846889e7dab27a7ad7f0b62225ba66cf":["35b47293d52729d80d78492b2aeda6e45d5a42f1"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["02c6a0e240c698414e7728a55f07361be84852d8"],"02c6a0e240c698414e7728a55f07361be84852d8":["35cbf075846889e7dab27a7ad7f0b62225ba66cf"],"4339eef0c1b12030c8590187e652cd1cd0a1f3cb":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"35b47293d52729d80d78492b2aeda6e45d5a42f1":["4339eef0c1b12030c8590187e652cd1cd0a1f3cb"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}