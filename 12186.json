{"path":"solr/core/src/test/org/apache/solr/cloud/FailoverZKtest#testRestartZkWhenClusterDown().mjava","commits":[{"id":"a73a633911940a9a6b39b4da22b965b33efe8ed6","date":1503304208,"type":0,"author":"Cao Manh Dat","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/FailoverZKtest#testRestartZkWhenClusterDown().mjava","pathOld":"/dev/null","sourceNew":"  public void testRestartZkWhenClusterDown() throws Exception {\n    String coll = \"coll1\";\n    CollectionAdminRequest.createCollection(coll, 2, 1).process(cluster.getSolrClient());\n    cluster.getSolrClient().add(coll, new SolrInputDocument(\"id\", \"1\"));\n    for (JettySolrRunner runner : cluster.getJettySolrRunners()) {\n      ChaosMonkey.stop(runner);\n    }\n    ZkTestServer zkTestServer = cluster.getZkServer();\n    zkTestServer.shutdown();\n    Thread[] threads = new Thread[cluster.getJettySolrRunners().size()];\n    for (int i = 0; i < cluster.getJettySolrRunners().size(); i++) {\n      final JettySolrRunner runner = cluster.getJettySolrRunner(i);\n      threads[i] = new Thread(() -> {\n        try {\n          ChaosMonkey.start(runner);\n        } catch (Exception e) {\n          e.printStackTrace();\n        }\n        });\n      threads[i].start();\n    }\n    Thread.sleep(5000);\n    zkTestServer = new ZkTestServer(zkTestServer.getZkDir(), zkTestServer.getPort());\n    zkTestServer.run();\n    for (Thread thread : threads) {\n      thread.join();\n    }\n    waitForLiveNodes(2);\n    waitForState(\"Timeout waiting for \" + coll, coll, clusterShape(2, 1));\n    QueryResponse rsp = new QueryRequest(new SolrQuery(\"*:*\")).process(cluster.getSolrClient(), coll);\n    assertEquals(1, rsp.getResults().getNumFound());\n    zkTestServer.shutdown();\n  }\n\n","sourceOld":null,"bugFix":null,"bugIntro":["bb222a3f9d9421d5c95afce73013fbd8de07ea1f","1c588f16cab976d98d9c0f04dbc6b8cdd8c9d936"],"isBuggy":true,"nexts":[],"revCommit":null},{"id":"025721dff6f9cdee2edd999c6f0680d82fd736e2","date":1503371271,"type":5,"author":"Cao Manh Dat","isMerge":false,"pathNew":"solr/core/src/test/org/apache/solr/cloud/ZkFailoverTest#testRestartZkWhenClusterDown().mjava","pathOld":"solr/core/src/test/org/apache/solr/cloud/FailoverZKtest#testRestartZkWhenClusterDown().mjava","sourceNew":"  public void testRestartZkWhenClusterDown() throws Exception {\n    String coll = \"coll1\";\n    CollectionAdminRequest.createCollection(coll, 2, 1).process(cluster.getSolrClient());\n    cluster.getSolrClient().add(coll, new SolrInputDocument(\"id\", \"1\"));\n    for (JettySolrRunner runner : cluster.getJettySolrRunners()) {\n      ChaosMonkey.stop(runner);\n    }\n    ZkTestServer zkTestServer = cluster.getZkServer();\n    zkTestServer.shutdown();\n    Thread[] threads = new Thread[cluster.getJettySolrRunners().size()];\n    for (int i = 0; i < cluster.getJettySolrRunners().size(); i++) {\n      final JettySolrRunner runner = cluster.getJettySolrRunner(i);\n      threads[i] = new Thread(() -> {\n        try {\n          ChaosMonkey.start(runner);\n        } catch (Exception e) {\n          e.printStackTrace();\n        }\n        });\n      threads[i].start();\n    }\n    Thread.sleep(5000);\n    zkTestServer = new ZkTestServer(zkTestServer.getZkDir(), zkTestServer.getPort());\n    zkTestServer.run();\n    for (Thread thread : threads) {\n      thread.join();\n    }\n    waitForLiveNodes(2);\n    waitForState(\"Timeout waiting for \" + coll, coll, clusterShape(2, 1));\n    QueryResponse rsp = new QueryRequest(new SolrQuery(\"*:*\")).process(cluster.getSolrClient(), coll);\n    assertEquals(1, rsp.getResults().getNumFound());\n    zkTestServer.shutdown();\n  }\n\n","sourceOld":"  public void testRestartZkWhenClusterDown() throws Exception {\n    String coll = \"coll1\";\n    CollectionAdminRequest.createCollection(coll, 2, 1).process(cluster.getSolrClient());\n    cluster.getSolrClient().add(coll, new SolrInputDocument(\"id\", \"1\"));\n    for (JettySolrRunner runner : cluster.getJettySolrRunners()) {\n      ChaosMonkey.stop(runner);\n    }\n    ZkTestServer zkTestServer = cluster.getZkServer();\n    zkTestServer.shutdown();\n    Thread[] threads = new Thread[cluster.getJettySolrRunners().size()];\n    for (int i = 0; i < cluster.getJettySolrRunners().size(); i++) {\n      final JettySolrRunner runner = cluster.getJettySolrRunner(i);\n      threads[i] = new Thread(() -> {\n        try {\n          ChaosMonkey.start(runner);\n        } catch (Exception e) {\n          e.printStackTrace();\n        }\n        });\n      threads[i].start();\n    }\n    Thread.sleep(5000);\n    zkTestServer = new ZkTestServer(zkTestServer.getZkDir(), zkTestServer.getPort());\n    zkTestServer.run();\n    for (Thread thread : threads) {\n      thread.join();\n    }\n    waitForLiveNodes(2);\n    waitForState(\"Timeout waiting for \" + coll, coll, clusterShape(2, 1));\n    QueryResponse rsp = new QueryRequest(new SolrQuery(\"*:*\")).process(cluster.getSolrClient(), coll);\n    assertEquals(1, rsp.getResults().getNumFound());\n    zkTestServer.shutdown();\n  }\n\n","bugFix":null,"bugIntro":[],"isBuggy":true,"nexts":[],"revCommit":null}],"commit2Parents":{"025721dff6f9cdee2edd999c6f0680d82fd736e2":["a73a633911940a9a6b39b4da22b965b33efe8ed6"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":[],"a73a633911940a9a6b39b4da22b965b33efe8ed6":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":["025721dff6f9cdee2edd999c6f0680d82fd736e2"]},"commit2Childs":{"025721dff6f9cdee2edd999c6f0680d82fd736e2":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85":["a73a633911940a9a6b39b4da22b965b33efe8ed6"],"a73a633911940a9a6b39b4da22b965b33efe8ed6":["025721dff6f9cdee2edd999c6f0680d82fd736e2"],"cd5edd1f2b162a5cfa08efd17851a07373a96817":[]},"heads":["cd5edd1f2b162a5cfa08efd17851a07373a96817"],"roots":["a0e7ee9d0d12370e8d2b5ae0a23b6e687e018d85"],"pathCommit":null}